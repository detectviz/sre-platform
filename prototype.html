<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SRE 平台互動原型</title>
  <!-- React, Babel, Day.js -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/dayjs.min.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/plugin/relativeTime.js"></script>
  <script src="https://unpkg.com/dayjs@1.11.10/plugin/isBetween.js"></script>
  <!-- Ant Design -->
  <script src="https://unpkg.com/antd@5.19.1/dist/antd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/antd@5.19.1/dist/reset.css" />
  <!-- Ant Design Icons -->
  <script src="https://unpkg.com/@ant-design/icons@5.3.7/dist/index.umd.min.js"></script>
  <!-- ECharts -->
  <script src="https://unpkg.com/echarts@5.5.0/dist/echarts.min.js"></script>

  <style>
    /* Structural and specific styles that are theme-agnostic */
    .page-title {
      font-size: 28px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .page-subtitle {
      font-size: 14px;
      margin-bottom: 24px;
    }

    .ant-table-row.row-highlight>td {
      background-color: rgba(255, 77, 79, 0.1) !important;
    }

    /* 資源列表容器樣式 */
    .resource-list-container {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .table-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .table-wrapper .ant-table {
      background: transparent;
    }

    .table-wrapper .ant-table-thead>tr>th {
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.85);
      font-weight: 500;
      padding: 8px 12px;
      line-height: 1.2;
    }

    .table-wrapper .ant-table-tbody>tr {
      &:hover>td {
        background: rgba(255, 255, 255, 0.03);
      }

      >td {
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.85);
        padding: 8px 12px;
        line-height: 1.2;
      }
    }

    .table-wrapper .ant-table-row-selected>td {
      background: rgba(24, 144, 255, 0.1);
    }

    /* Sidebar 選取效果 - 左側藍色邊框（主色） */
    .ant-menu-dark .ant-menu-item-selected {
      background-color: rgba(24, 144, 255, 0.15) !important;
      color: rgba(255, 255, 255, 0.9) !important;
      border-radius: 0 !important;
      position: relative;
    }

    .ant-menu-dark .ant-menu-item-selected::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #1890ff !important;
      border-radius: 0 !important;
    }

    .ant-menu-dark .ant-menu-item-selected::after {
      display: none !important;
    }

    /* 子選單展開時，父選單不顯示選取指示器，只有輕微背景色 */
    .ant-menu-dark .ant-menu-submenu-open .ant-menu-submenu-title {
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: rgba(255, 255, 255, 0.8) !important;
      border-radius: 0 !important;
    }

    /* 移除父選單的選取指示器 */
    .ant-menu-dark .ant-menu-submenu-selected .ant-menu-submenu-title::before {
      display: none !important;
    }

    .ant-menu-dark .ant-menu-item:hover {
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .ant-menu-dark .ant-menu-submenu-title:hover {
      background-color: rgba(255, 255, 255, 0.05) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }

    /* 表格滾動條樣式 */
    .table-wrapper .ant-table-container::-webkit-scrollbar {
      height: 8px;
    }

    .table-wrapper .ant-table-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .table-wrapper .ant-table-container::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    .table-wrapper .ant-table-container::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .code-editor-like {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    }

    .log-viewer {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      padding: 16px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .admin-card {
      cursor: pointer;
      transition: all 0.3s ease;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(200, 200, 200, 0.05) 100%) !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      border-radius: 12px !important;
      backdrop-filter: blur(20px) saturate(180%) brightness(1.1) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) brightness(1.1) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.1) !important;
      position: relative;
      overflow: hidden;
    }

    .admin-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      z-index: -1;
    }

    .admin-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2), inset 0 -1px 0 rgba(0, 0, 0, 0.15) !important;
      border-color: rgba(255, 255, 255, 0.25) !important;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(200, 200, 200, 0.06) 100%) !important;
    }

    /* 圖表容器樣式 */
    .chart-container {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: 100%;
    }

    /* 圖表區域的 Card 樣式 */
    .dashboard-chart-card .ant-card-body {
      height: 100%;
      padding: 16px;
    }

    .dashboard-chart-card {
      height: 100%;
    }

    /* 玻璃效果樣式 */
    .glass-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(200, 200, 200, 0.04) 100%) !important;
      border: 1px solid rgba(255, 255, 255, 0.12) !important;
      border-radius: 12px !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    }

    .glass-card-subtle {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%) !important;
      border: 1px solid rgba(255, 255, 255, 0.08) !important;
      border-radius: 12px !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08) !important;
    }

    .glass-card-colored {
      border-radius: 12px !important;
      backdrop-filter: blur(20px) saturate(180%) !important;
      -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
    }

    /* 優化按鈕樣式 */
    .ant-btn {
      border-radius: 6px !important;
      font-weight: 500 !important;
      transition: all 0.3s ease !important;
    }

    .ant-btn-primary {
      background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%) !important;
      border: none !important;
      box-shadow: 0 2px 8px rgba(24, 144, 255, 0.3) !important;
    }

    .ant-btn-primary:hover {
      background: linear-gradient(135deg, #40a9ff 0%, #69c0ff 100%) !important;
      box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4) !important;
      transform: translateY(-1px) !important;
    }

    .ant-btn-primary:active {
      transform: translateY(0) !important;
    }

    .ant-btn-link {
      color: rgba(255, 255, 255, 0.75) !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;
    }

    .ant-btn-link:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      color: #1890ff !important;
    }

    .ant-btn-link.ant-btn-dangerous {
      color: rgba(255, 77, 79, 0.85) !important;
    }

    .ant-btn-link.ant-btn-dangerous:hover {
      background: rgba(255, 77, 79, 0.1) !important;
      color: #ff4d4f !important;
    }

    .ant-btn.ant-btn-dangerous:not(.ant-btn-link) {
      background: linear-gradient(135deg, #ff4d4f 0%, #ff7875 100%) !important;
      border: 1px solid #ff4d4f !important;
      box-shadow: 0 2px 8px rgba(255, 77, 79, 0.3) !important;
      color: #ffffff !important;
    }

    .ant-btn.ant-btn-dangerous:not(.ant-btn-link):hover {
      background: linear-gradient(135deg, #ff7875 0%, #ffa39e 100%) !important;
      border-color: #ff7875 !important;
      box-shadow: 0 4px 12px rgba(255, 77, 79, 0.4) !important;
      transform: translateY(-1px) !important;
      color: #ffffff !important;
    }

    .ant-btn.ant-btn-dangerous:not(.ant-btn-link):active {
      transform: translateY(0) !important;
    }

    .ant-btn-default {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      color: rgba(255, 255, 255, 0.85) !important;
    }

    .ant-btn-default:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
      color: rgba(255, 255, 255, 0.95) !important;
    }

    /* 表格操作按鈕間距 */
    .ant-table-tbody .ant-btn+.ant-btn,
    .ant-table-tbody .ant-btn+.ant-divider {
      margin-left: 8px !important;
    }

    /* 功能按鈕樣式 - 提高辨識性 */
    .btn-edit {
      background: #0f4c75 !important;
      border: 1px solid #0f4c75 !important;
      color: #ffffff !important;
      font-weight: normal !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
    }

    .btn-edit:hover {
      background: #1890ff !important;
      border-color: #1890ff !important;
      transform: translateY(-1px) !important;
    }

    .btn-delete {
      background: #8b0000 !important;
      border: 1px solid #8b0000 !important;
      color: #ffffff !important;
      font-weight: normal !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
    }

    .btn-delete:hover {
      background: #ff4d4f !important;
      border-color: #ff4d4f !important;
      transform: translateY(-1px) !important;
    }

    .btn-run {
      background: #2e7d32 !important;
      border: 1px solid #2e7d32 !important;
      color: #ffffff !important;
      font-weight: normal !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
    }

    .btn-run:hover {
      background: #52c41a !important;
      border-color: #52c41a !important;
      transform: translateY(-1px) !important;
    }

    .btn-confirm {
      background: #0f4c75 !important;
      border: 1px solid #0f4c75 !important;
      color: #ffffff !important;
      font-weight: normal !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
    }

    .btn-confirm:hover {
      background: #1890ff !important;
      border-color: #1890ff !important;
      transform: translateY(-1px) !important;
    }

    .btn-silence {
      background: #b7800b !important;
      border: 1px solid #b7800b !important;
      color: #ffffff !important;
      font-weight: normal !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
    }

    .btn-silence:hover {
      background: #faad14 !important;
      border-color: #faad14 !important;
      transform: translateY(-1px) !important;
    }

    .btn-detail {
      background: #4a148c !important;
      border: 1px solid #4a148c !important;
      color: #ffffff !important;
      font-weight: normal !important;
      padding: 4px 8px !important;
      height: 28px !important;
      border-radius: 4px !important;
    }

    .btn-detail:hover {
      background: #722ed1 !important;
      border-color: #722ed1 !important;
      transform: translateY(-1px) !important;
    }

    /* 導航項目樣式 */
    .nav-item {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(200, 200, 200, 0.05) 100%);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      cursor: pointer;
      transition: all 0.3s ease;
      height: 100%;
      backdrop-filter: blur(20px) saturate(180%) brightness(1.1);
      -webkit-backdrop-filter: blur(20px) saturate(180%) brightness(1.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 12px;
      z-index: -1;
    }

    .nav-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
      border-color: rgba(255, 255, 255, 0.25);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(200, 200, 200, 0.06) 100%);
    }

    .nav-item-content {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      height: 100%;
    }

    .nav-item-icon {
      font-size: 24px;
      color: rgba(255, 255, 255, 0.8);
      margin-top: 4px;
    }

    .nav-item-text {
      flex: 1;
    }

    .nav-item-title {
      margin: 0 0 8px 0 !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .nav-item-description {
      margin: 0 !important;
      color: rgba(255, 255, 255, 0.6) !important;
      font-size: 14px;
      line-height: 1.4;
    }

    /* 模態框區段樣式 */
    .modal-section {
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .modal-section+.modal-section {
      margin-top: 16px;
    }

    /* 條件群組容器樣式 */
    .condition-group-container {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      padding: 12px;
    }

    .condition-group-container+.condition-group-container {
      margin-top: 12px;
    }

    .condition-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .condition-group-title {
      font-size: 14px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.85);
    }

    .condition-group-remove {
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: color 0.2s;
    }

    .condition-group-remove:hover {
      color: rgba(255, 255, 255, 0.9);
    }

    /* 腳本參數容器樣式 */
    .script-params-container {
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      margin-top: 12px;
    }

    .script-params-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .script-params-content {
      padding: 12px 16px;
    }

    /* 統計卡片樣式 */
    .stat-card {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      text-align: center;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stat-card .ant-statistic-title {
      color: rgba(255, 255, 255, 0.65);
      margin-bottom: 8px;
    }

    .stat-card .ant-statistic-content {
      color: rgba(255, 255, 255, 0.9);
    }

    .stat-card .ant-statistic-content-suffix {
      color: rgba(255, 255, 255, 0.8);
    }

    /* 圖表區域樣式 */
    .chart-section {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      overflow: hidden;
    }

    .chart-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .chart-content {
      padding: 16px 20px;
    }

    /* 分析區域樣式 */
    .analysis-section {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 16px;
    }

    .analysis-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .analysis-content {
      padding: 16px 20px;
    }

    /* 空分析提示樣式 */
    .empty-analysis {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 32px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* 登入頁面樣式 */
    .login-page {
      background: linear-gradient(135deg, #161719 0%, #202226 100%) !important;
      background-attachment: fixed !important;
    }

    .login-page .ant-input {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .login-page .ant-input::placeholder {
      color: rgba(255, 255, 255, 0.4) !important;
    }

    .login-page .ant-input:focus,
    .login-page .ant-input-focused {
      border-color: #1890ff !important;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2) !important;
    }

    .login-page .ant-input-password {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    .login-page .ant-form-item-label>label {
      color: rgba(255, 255, 255, 0.85) !important;
    }

    /* 使用者團隊容器樣式 */
    .user-team-container {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 16px;
    }

    /* 角色列表容器樣式 */
    .role-list-container {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: fit-content;
    }

    .role-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .role-list-content {
      padding: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    /* 角色權限容器樣式 */
    .role-permissions-container {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: fit-content;
    }

    .role-permissions-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .role-permissions-content {
      padding: 16px 20px;
    }

    /* Transfer 組件樣式優化 */
    .ant-transfer-list {
      background: rgba(0, 0, 0, 0.2) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    .ant-transfer-list-header {
      background: rgba(0, 0, 0, 0.3) !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    .ant-transfer-list-header-title {
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .ant-transfer-list-body {
      background: rgba(0, 0, 0, 0.1) !important;
    }

    .ant-transfer-list-content-item {
      color: rgba(255, 255, 255, 0.9) !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
    }

    .ant-transfer-list-content-item:hover {
      background: rgba(255, 255, 255, 0.05) !important;
    }

    .ant-transfer-list-search {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }

    .ant-transfer-list-search input {
      background: transparent !important;
      color: rgba(255, 255, 255, 0.9) !important;
    }

    .ant-transfer-list-search input::placeholder {
      color: rgba(255, 255, 255, 0.4) !important;
    }

    /* Header 和 Sidebar 細灰線分隔 */
    .ant-layout-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important;
    }

    .ant-layout-sider {
      border-right: 1px solid rgba(255, 255, 255, 0.08) !important;
    }

    .ant-layout-sider-collapsed {
      border-right: 1px solid rgba(255, 255, 255, 0.08) !important;
    }

    /* 統一按鈕設計系統（新增） */
    :root {
      --btn-radius: 6px;
      --btn-font-weight: 600;
      --btn-focus-ring: 0 0 0 2px rgba(24, 144, 255, 0.35);

      --c-primary: #1890ff;
      --c-primary-600: #1677ff;
      --c-primary-300: #69c0ff;

      --c-success: #52c41a;
      --c-success-600: #389e0d;

      --c-warning: #faad14;
      --c-warning-600: #d48806;

      --c-danger: #ff4d4f;
      --c-danger-600: #cf1322;

      --c-info: #722ed1;
      --c-info-300: #b37feb;

      --c-neutral: rgba(255, 255, 255, 0.85);
      --c-neutral-200: rgba(255, 255, 255, 0.3);
      --c-bg-soft: rgba(255, 255, 255, 0.06);
      --c-bg-hover: rgba(255, 255, 255, 0.1);
    }

    .ant-btn.btn {
      border-radius: var(--btn-radius) !important;
      font-weight: var(--btn-font-weight) !important;
      transition: all 0.2s ease !important;
      display: inline-flex !important;
      align-items: center;
      gap: 6px;
    }

    .ant-btn.btn:focus-visible {
      box-shadow: var(--btn-focus-ring) !important;
      outline: none !important;
    }

    .ant-btn.btn.btn--sm {
      height: 28px !important;
      padding: 0 10px !important;
      font-size: 12px !important;
    }

    .ant-btn.btn.btn--md {
      height: 32px !important;
      padding: 0 12px !important;
      font-size: 14px !important;
    }

    .ant-btn.btn.btn--lg {
      height: 40px !important;
      padding: 0 16px !important;
      font-size: 16px !important;
    }

    .ant-btn.btn.btn--icon-only {
      width: 28px !important;
      height: 28px !important;
      padding: 0 !important;
      justify-content: center;
    }

    .ant-btn.btn.btn--primary {
      background: linear-gradient(135deg, var(--c-primary) 0%, var(--c-primary-300) 100%) !important;
      border: none !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(24, 144, 255, 0.25) !important;
    }

    .ant-btn.btn.btn--primary:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .ant-btn.btn.btn--success {
      background: linear-gradient(135deg, var(--c-success-600) 0%, var(--c-success) 100%) !important;
      border: none !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(82, 196, 26, 0.25) !important;
    }

    .ant-btn.btn.btn--success:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
    }

    .ant-btn.btn.btn--warning {
      background: linear-gradient(135deg, var(--c-warning-600) 0%, var(--c-warning) 100%) !important;
      border: none !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(250, 173, 20, 0.25) !important;
    }

    .ant-btn.btn.btn--warning:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .ant-btn.btn.btn--danger {
      background: linear-gradient(135deg, var(--c-danger-600) 0%, var(--c-danger) 100%) !important;
      border: none !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(255, 77, 79, 0.25) !important;
    }

    .ant-btn.btn.btn--danger:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }

    .ant-btn.btn.btn--info {
      background: linear-gradient(135deg, var(--c-info) 0%, var(--c-info-300) 100%) !important;
      border: none !important;
      color: #fff !important;
      box-shadow: 0 2px 8px rgba(114, 46, 209, 0.25) !important;
    }

    .ant-btn.btn.btn--info:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }

    .ant-btn.btn.btn--neutral {
      background: var(--c-bg-soft) !important;
      border: 1px solid var(--c-neutral-200) !important;
      color: var(--c-neutral) !important;
    }

    .ant-btn.btn.btn--neutral:hover {
      background: var(--c-bg-hover) !important;
    }

    .ant-btn.btn[class*='btn--primary-outline'] {
      background: transparent !important;
      border: 2px solid var(--c-primary) !important;
      color: var(--c-primary) !important;
    }

    .ant-btn.btn[class*='btn--primary-outline']:hover {
      background: var(--c-primary) !important;
      color: #fff !important;
      box-shadow: 0 4px 10px rgba(24, 144, 255, 0.25) !important;
      transform: translateY(-1px);
    }

    .ant-btn.btn[class*='btn--success-outline'] {
      background: transparent !important;
      border: 2px solid var(--c-success) !important;
      color: var(--c-success) !important;
    }

    .ant-btn.btn[class*='btn--success-outline']:hover {
      background: var(--c-success) !important;
      color: #fff !important;
      box-shadow: 0 4px 10px rgba(82, 196, 26, 0.25) !important;
      transform: translateY(-1px);
    }

    .ant-btn.btn[class*='btn--warning-outline'] {
      background: transparent !important;
      border: 2px solid var(--c-warning) !important;
      color: var(--c-warning) !important;
    }

    .ant-btn.btn[class*='btn--warning-outline']:hover {
      background: var(--c-warning) !important;
      color: #fff !important;
      box-shadow: 0 4px 10px rgba(250, 173, 20, 0.25) !important;
      transform: translateY(-1px);
    }

    .ant-btn.btn[class*='btn--danger-outline'] {
      background: transparent !important;
      border: 2px solid var(--c-danger) !important;
      color: var(--c-danger) !important;
    }

    .ant-btn.btn[class*='btn--danger-outline']:hover {
      background: var(--c-danger) !important;
      color: #fff !important;
      box-shadow: 0 4px 10px rgba(255, 77, 79, 0.25) !important;
      transform: translateY(-1px);
    }

    .ant-btn.btn[class*='btn--info-outline'] {
      background: transparent !important;
      border: 2px solid var(--c-info) !important;
      color: var(--c-info) !important;
    }

    .ant-btn.btn[class*='btn--info-outline']:hover {
      background: var(--c-info) !important;
      color: #fff !important;
      box-shadow: 0 4px 10px rgba(114, 46, 209, 0.25) !important;
      transform: translateY(-1px);
    }

    .ant-btn.btn.btn--ghost {
      background: transparent !important;
      border: 1px solid rgba(255, 255, 255, 0.15) !important;
      color: var(--c-neutral) !important;
    }

    .ant-btn.btn.btn--ghost:hover {
      background: rgba(255, 255, 255, 0.08) !important;
    }

    .ant-btn.btn[disabled] {
      opacity: 0.55 !important;
      cursor: not-allowed !important;
      box-shadow: none !important;
      transform: none !important;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const { Layout, Menu, ConfigProvider, theme, Typography, Input, Avatar, Button, Row, Col, Card, Statistic, Table, Tag, Modal, Form, Select, Breadcrumb, message, Tabs, DatePicker, List, Divider, Dropdown, Badge, Drawer, Tree, Collapse, InputNumber, Transfer, Spin, Empty, Switch, Space, Radio, Progress, Popover, Tooltip, Descriptions, Timeline, Checkbox, Steps } = antd;
    const { UserOutlined, SearchOutlined, LogoutOutlined, DashboardOutlined, HddOutlined, TeamOutlined, ProfileOutlined, CodeOutlined, BarChartOutlined, HistoryOutlined, PlusOutlined, SettingOutlined, SafetyCertificateOutlined, BellOutlined, DownOutlined, ExclamationCircleOutlined, InfoCircleOutlined, EditOutlined, DeleteOutlined, ApartmentOutlined, BuildOutlined, ControlOutlined, AuditOutlined, MenuUnfoldOutlined, MenuFoldOutlined, PauseCircleOutlined, ScheduleOutlined, CarryOutOutlined, ThunderboltOutlined, MinusCircleOutlined, FireOutlined, ClockCircleOutlined, CheckCircleOutlined, CopyOutlined, PlayCircleOutlined, RobotOutlined, DeploymentUnitOutlined } = icons;
    const { Title, Text, Paragraph } = Typography;
    const { TextArea } = Input;
    const { RangePicker } = DatePicker;
    dayjs.extend(dayjs_plugin_relativeTime);
    dayjs.extend(dayjs_plugin_isBetween);

    // --- Custom Hook for localStorage ---
    const useLocalStorageState = (key, defaultValue) => {
      const [state, setState] = useState(() => {
        try {
          const storedValue = window.localStorage.getItem(key);
          // Reviver function to parse ISO date strings back to dayjs objects
          const reviver = (k, v) => {
            if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z$/.test(v)) {
              return dayjs(v);
            }
            if (k === 'timeRange' && Array.isArray(v)) {
              return [dayjs(v[0]), dayjs(v[1])];
            }
            if (k === 'lastRun' && typeof v === 'string') {
              return dayjs(v);
            }
            return v;
          };
          return storedValue ? JSON.parse(storedValue, reviver) : defaultValue;
        } catch (error) {
          console.error("Error reading from localStorage for key:", key, error);
          return defaultValue;
        }
      });

      useEffect(() => {
        try {
          window.localStorage.setItem(key, JSON.stringify(state));
        } catch (error) {
          console.error("Error writing to localStorage for key:", key, error);
        }
      }, [key, state]);

      return [state, setState];
    };


    // --- ECharts Component ---
    const EchartsForReact = ({ option, isDark }) => {
      const chartRef = useRef(null);
      useEffect(() => {
        let chart;
        if (chartRef.current !== null) {
          chart = echarts.init(chartRef.current, isDark ? 'dark' : 'light', { renderer: 'svg' });
          chart.setOption({ backgroundColor: 'transparent', ...option });
        }
        const resizeChart = () => { if (chart && !chart.isDisposed()) chart.resize(); };
        window.addEventListener('resize', resizeChart);
        return () => { if (chart) chart.dispose(); window.removeEventListener('resize', resizeChart); };
      }, [option, isDark]);
      return <div ref={chartRef} style={{ width: '100%', height: '100%' }} />;
    };

    // --- Page Components ---
    const LoginPage = ({ onLogin }) => {
      const [form] = Form.useForm();
      const onFinish = (values) => {
        if (values.username === 'admin' && values.password === 'admin') {
          onLogin();
        } else {
          message.error('帳號或密碼錯誤');
        }
      };
      return (
        <div style={{
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          height: '100vh',
          background: 'linear-gradient(135deg, #161719 0%, #202226 100%)',
          backgroundAttachment: 'fixed'
        }}>
          <Card
            style={{
              width: 400,
              background: 'rgba(32, 34, 38, 0.9)',
              border: '1px solid rgba(255, 255, 255, 0.1)',
              borderRadius: '12px',
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
            }}
            bodyStyle={{
              padding: '32px',
              background: 'transparent'
            }}
          >
            <div style={{ textAlign: 'center', marginBottom: 32 }}>
              <div style={{ marginBottom: 16 }}>
                <DeploymentUnitOutlined style={{
                  fontSize: '48px',
                  color: '#8a2be2',
                  marginBottom: '8px'
                }} />
              </div>
              <Title level={2} style={{
                color: 'rgba(255, 255, 255, 0.9)',
                margin: 0,
                fontWeight: '600'
              }}>
                SRE Platform
              </Title>
              <Text style={{
                color: 'rgba(255, 255, 255, 0.6)',
                fontSize: '14px'
              }}>
                智慧化 SRE 管理平台
              </Text>
            </div>
            <Form
              form={form}
              name="login"
              onFinish={onFinish}
              layout="vertical"
              initialValues={{ username: 'admin', password: 'admin' }}
            >
              <Form.Item
                label={<span style={{ color: 'rgba(255, 255, 255, 0.85)' }}>帳號</span>}
                name="username"
                rules={[{ required: true, message: '請輸入帳號 (admin)' }]}
              >
                <Input
                  style={{
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    color: 'rgba(255, 255, 255, 0.9)'
                  }}
                  placeholder="請輸入帳號"
                />
              </Form.Item>
              <Form.Item
                label={<span style={{ color: 'rgba(255, 255, 255, 0.85)' }}>密碼</span>}
                name="password"
                rules={[{ required: true, message: '請輸入密碼 (admin)' }]}
              >
                <Input.Password
                  style={{
                    background: 'rgba(255, 255, 255, 0.05)',
                    border: '1px solid rgba(255, 255, 255, 0.1)',
                    color: 'rgba(255, 255, 255, 0.9)'
                  }}
                  placeholder="請輸入密碼"
                />
              </Form.Item>
              <Form.Item style={{ marginTop: 32 }}>
                <Button
                  type="primary"
                  htmlType="submit"
                  block
                  size="large"
                  style={{
                    height: '48px',
                    fontSize: '16px',
                    fontWeight: '500',
                    borderRadius: '8px',
                    background: 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)',
                    border: 'none'
                  }}
                >
                  登入
                </Button>
              </Form.Item>
            </Form>
          </Card>
        </div>
      );
    };

    // --- Page Components (Enhanced and Placeholders) ---
    const DashboardPage = ({ themeMode }) => {
      // 堆疊長條圖選項 - 資源群組狀態總覽
      const stackedBarOption = {
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(0,0,0,0.8)',
          borderColor: 'rgba(255,255,255,0.2)',
          textStyle: { color: '#fff' }
        },
        legend: {
          data: ['健康', '警告', '嚴重'],
          top: 0,
          textStyle: { color: 'rgba(255,255,255,0.85)' }
        },
        grid: {
          left: '5%',
          right: '5%',
          bottom: '15%',
          top: '15%'
        },
        xAxis: {
          type: 'category',
          data: ['Prod Web', 'Prod DB', 'Staging', 'Dev'],
          axisLabel: {
            color: 'rgba(255,255,255,0.65)',
            fontSize: 11,
            interval: 0,
            rotate: 0
          },
          axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
        },
        yAxis: {
          type: 'value',
          axisLabel: { color: 'rgba(255,255,255,0.65)' },
          axisLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } },
          splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }
        },
        series: [
          {
            name: '健康',
            type: 'bar',
            stack: '總量',
            data: [80, 15, 25, 18],
            color: '#52c41a',
            barWidth: '60%'
          },
          {
            name: '警告',
            type: 'bar',
            stack: '總量',
            data: [8, 3, 3, 2],
            color: '#faad14'
          },
          {
            name: '嚴重',
            type: 'bar',
            stack: '總量',
            data: [2, 2, 1, 0],
            color: '#ff4d4f'
          }
        ]
      };

      // 環圈圖選項 - 資源狀態分佈
      const doughnutOption = {
        tooltip: {
          trigger: 'item',
          formatter: '{a} <br/>{b}: {c} ({d}%)',
          backgroundColor: 'rgba(0,0,0,0.8)',
          borderColor: 'rgba(255,255,255,0.2)',
          textStyle: { color: '#fff' }
        },
        series: [
          {
            name: '資源狀態',
            type: 'pie',
            radius: ['40%', '65%'],
            center: ['50%', '58%'],
            data: [
              { value: 138, name: '健康', itemStyle: { color: '#52c41a' } },
              { value: 16, name: '警告', itemStyle: { color: '#faad14' } },
              { value: 5, name: '嚴重', itemStyle: { color: '#ff4d4f' } }
            ],
            label: {
              show: true,
              formatter: '{b}: {c}',
              color: 'rgba(255,255,255,0.85)',
              fontSize: 11,
              position: 'outside'
            },
            labelLine: {
              show: true,
              length: 15,
              length2: 10,
              lineStyle: {
                color: 'rgba(255,255,255,0.3)'
              }
            },
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: 'rgba(0, 0, 0, 0.5)'
              }
            }
          }
        ]
      };

      // 事件統計卡片 - 帶背景色
      const EventStatCard = ({ icon, color, bgColor, title, value, change }) => (
        <Card style={{
          background: `linear-gradient(135deg, ${bgColor}20 0%, rgba(200, 200, 200, 0.08) 50%, ${bgColor}10 100%)`,
          border: `1px solid rgba(255, 255, 255, 0.15)`,
          borderRadius: '12px',
          height: '120px',
          backdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
          boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.1)',
          WebkitBackdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
          position: 'relative',
          overflow: 'hidden'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', height: '100%' }}>
            <div style={{ flex: 1 }}>
              <div style={{ color: 'rgba(255, 255, 255, 0.75)', fontSize: '13px', marginBottom: '8px', fontWeight: '500' }}>{title}</div>
              <div style={{ color: 'rgba(255, 255, 255, 0.95)', fontSize: '28px', fontWeight: 'bold', marginBottom: '6px', lineHeight: '1' }}>{value}</div>
              <div style={{ display: 'flex', alignItems: 'center', fontSize: '11px' }}>
                <span style={{
                  color: change > 0 ? '#ff4d4f' : '#52c41a',
                  fontWeight: '600',
                  display: 'flex',
                  alignItems: 'center'
                }}>
                  {change > 0 ? '↗' : '↘'} {Math.abs(change)}%
                </span>
                <span style={{ color: 'rgba(255, 255, 255, 0.5)', marginLeft: '6px' }}>vs 昨日</span>
              </div>
            </div>
            <div style={{
              fontSize: '36px',
              color: color,
              opacity: 0.8,
              marginLeft: '16px'
            }}>{icon}</div>
          </div>
        </Card>
      );

      // 關鍵指標卡片 - 左側圓形圖示
      const KeyMetricCard = ({ icon, iconBg, title, value, unit }) => (
        <Card style={{
          background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(200, 200, 200, 0.05) 100%)',
          border: '1px solid rgba(255, 255, 255, 0.15)',
          borderRadius: '12px',
          backdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
          boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.1)',
          WebkitBackdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
          height: '120px',
          position: 'relative',
          overflow: 'hidden'
        }}>
          <div style={{ display: 'flex', alignItems: 'center', height: '100%' }}>
            <div style={{
              width: '48px',
              height: '48px',
              borderRadius: '50%',
              background: iconBg,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              marginRight: '16px',
              boxShadow: '0 4px 16px rgba(0, 0, 0, 0.3)'
            }}>
              <div style={{ fontSize: '24px', color: '#fff' }}>{icon}</div>
            </div>
            <div>
              <div style={{ color: 'rgba(255, 255, 255, 0.75)', fontSize: '14px', marginBottom: '6px', fontWeight: '500' }}>{title}</div>
              <div style={{ color: 'rgba(255, 255, 255, 0.95)', fontSize: '28px', fontWeight: 'bold', lineHeight: '1' }}>
                {value}{unit && <span style={{ fontSize: '18px', marginLeft: '2px', opacity: 0.8 }}>{unit}</span>}
              </div>
            </div>
          </div>
        </Card>
      );

      return (
        <React.Fragment>
          <Title level={2} className="page-title">總覽儀表板</Title>
          <Paragraph className="page-subtitle" type="secondary">查看系統整體健康狀況與關鍵指標。</Paragraph>

          {/* 事件統計卡 */}
          <Row gutter={[16, 16]}>
            <Col xs={24} lg={8}>
              <EventStatCard
                icon={<FireOutlined />}
                color="#ff4d4f"
                bgColor="#ff4d4f"
                title="新告警"
                value={5}
                change={20}
              />
            </Col>
            <Col xs={24} lg={8}>
              <EventStatCard
                icon={<ClockCircleOutlined />}
                color="#faad14"
                bgColor="#faad14"
                title="處理中"
                value={3}
                change={-15}
              />
            </Col>
            <Col xs={24} lg={8}>
              <EventStatCard
                icon={<CheckCircleOutlined />}
                color="#52c41a"
                bgColor="#52c41a"
                title="今日已解決"
                value={12}
                change={8}
              />
            </Col>
          </Row>

          {/* 關鍵指標卡 */}
          <Row gutter={[16, 16]} style={{ marginTop: '16px' }}>
            <Col xs={24} lg={12}>
              <KeyMetricCard
                icon={<CheckCircleOutlined />}
                iconBg="#52c41a"
                title="資源妥善率"
                value="96.8"
                unit="%"
              />
            </Col>
            <Col xs={24} lg={12}>
              <KeyMetricCard
                icon={<HddOutlined />}
                iconBg="#1890ff"
                title="總資源數"
                value="159"
                unit="台"
              />
            </Col>
          </Row>

          {/* 圖表卡 */}
          <Row gutter={[16, 16]} style={{ marginTop: '16px' }}>
            <Col xs={24} lg={12}>
              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(200, 200, 200, 0.05) 100%)',
                border: '1px solid rgba(255, 255, 255, 0.15)',
                borderRadius: '12px',
                backdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
                WebkitBackdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.1)',
                height: '320px',
                padding: '24px',
                position: 'relative',
                overflow: 'hidden'
              }}>
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(255, 255, 255, 0.02)',
                  borderRadius: '12px',
                  zIndex: -1
                }}></div>
                <Title level={4} style={{ marginBottom: '16px', color: 'rgba(255, 255, 255, 0.85)', marginTop: 0 }}>資源群組狀態總覽</Title>
                <div style={{ height: 'calc(100% - 48px)' }}>
                  <EchartsForReact option={stackedBarOption} isDark={themeMode === 'dark'} />
                </div>
              </div>
            </Col>
            <Col xs={24} lg={12}>
              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(200, 200, 200, 0.05) 100%)',
                border: '1px solid rgba(255, 255, 255, 0.15)',
                borderRadius: '12px',
                backdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
                WebkitBackdropFilter: 'blur(20px) saturate(180%) brightness(1.1)',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.1)',
                height: '320px',
                padding: '24px',
                position: 'relative',
                overflow: 'hidden'
              }}>
                <div style={{
                  position: 'absolute',
                  top: 0,
                  left: 0,
                  right: 0,
                  bottom: 0,
                  background: 'rgba(255, 255, 255, 0.02)',
                  borderRadius: '12px',
                  zIndex: -1
                }}></div>
                <Title level={4} style={{ marginBottom: '16px', color: 'rgba(255, 255, 255, 0.85)', marginTop: 0 }}>資源狀態分佈</Title>
                <div style={{ height: 'calc(100% - 48px)' }}>
                  <EchartsForReact option={doughnutOption} isDark={themeMode === 'dark'} />
                </div>
              </div>
            </Col>
          </Row>
        </React.Fragment>
      );
    };

    const ResourceListPage = () => {
      const mockGroups = [
        { id: 'g_1', name: 'Production Database' },
        { id: 'g_2', name: 'Production Web Servers' },
        { id: 'g_3', name: 'Staging Environment' },
      ];

      // 資源群組數據（與 ResourceGroupsPage 保持一致）
      const groups = [
        { key: 'g_1', name: 'Production Database', description: '所有生產環境的資料庫', responsibleTeam: 't_1', members: ['r_1'] },
        { key: 'g_2', name: 'Production Web Servers', description: '所有生產環境的 Web 伺服器', responsibleTeam: 't_2', members: ['r_2'] },
        { key: 'g_3', name: 'Staging Environment', description: '測試環境所有資源', responsibleTeam: 't_3', members: ['r_3', 'r_4'] },
      ];

      // 團隊數據
      const teams = [
        { key: 't_1', name: '資料庫團隊' },
        { key: 't_2', name: 'Web 開發團隊' },
        { key: 't_3', name: '測試團隊' },
      ];
      const initialData = [
        { key: 'r_1', name: 'db-prod-01', type: 'database', status: 'healthy', ip_address: '10.0.0.10', groups: ['g_1'] },
        { key: 'r_2', name: 'web-prod-02', type: 'server', status: 'warning', ip_address: '10.0.0.21', groups: ['g_2'] },
        { key: 'r_3', name: 'api-gateway-prod', type: 'gateway', status: 'critical', ip_address: '10.0.0.35', groups: [] },
        { key: 'r_4', name: 'cache-redis-prod', type: 'cache', status: 'healthy', ip_address: '10.0.0.40', groups: ['g_1', 'g_2'] },
      ];

      const [resources, setResources] = useLocalStorageState('sre-resources', initialData);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingResource, setEditingResource] = useState(null);
      const [searchText, setSearchText] = useState('');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [form] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      const showModal = (resource = null) => {
        setEditingResource(resource);
        form.setFieldsValue(resource || { name: '', ip_address: '', type: 'server', groups: [] });
        setIsModalOpen(true);
      };
      const handleCancel = () => { setIsModalOpen(false); setEditingResource(null); form.resetFields(); };
      const onFinish = (values) => {
        const status = editingResource ? editingResource.status : 'healthy';
        if (editingResource) {
          setResources(resources.map(res => res.key === editingResource.key ? { ...res, ...values, status } : res));
          message.success('資源更新成功');
        } else {
          const newResource = { ...values, key: `r_${Date.now()}`, status: 'unknown' };
          setResources([newResource, ...resources]);
          message.success('資源新增成功');
        }
        handleCancel();
      };
      const handleDelete = (key) => { modal.confirm({ title: '確定要刪除此資源嗎？', icon: <ExclamationCircleOutlined />, content: '此操作無法復原。', okText: '確定', okType: 'danger', cancelText: '取消', onOk() { setResources(resources.filter(res => res.key !== key)); message.success('資源刪除成功'); } }); };

      const onSelectChange = (newSelectedRowKeys) => {
        setSelectedRowKeys(newSelectedRowKeys);
      };

      const rowSelection = { selectedRowKeys, onChange: onSelectChange };
      const hasSelected = selectedRowKeys.length > 0;

      const handleBatchDelete = () => {
        modal.confirm({
          title: `確定要刪除 ${selectedRowKeys.length} 個資源嗎？`,
          icon: <ExclamationCircleOutlined />,
          content: '此操作無法復原。',
          okText: '確定',
          okType: 'danger',
          cancelText: '取消',
          onOk() {
            setResources(resources.filter(res => !selectedRowKeys.includes(res.key)));
            setSelectedRowKeys([]);
            message.success('批次刪除成功');
          }
        });
      };

      const columns = [
        { title: '狀態', dataIndex: 'status', width: 100, filters: [{ text: 'Healthy', value: 'healthy' }, { text: 'Warning', value: 'warning' }, { text: 'Critical', value: 'critical' },], onFilter: (value, record) => record.status && record.status.indexOf(value) === 0, render: s => <Tag color={s === 'healthy' ? 'green' : (s === 'warning' ? 'orange' : 'red')}>{s ? s.toUpperCase() : 'UNKNOWN'}</Tag> },
        { title: '資源名稱', dataIndex: 'name', sorter: (a, b) => a.name.localeCompare(b.name), render: text => <a>{text}</a> },
        { title: 'IP位址', dataIndex: 'ip_address', sorter: (a, b) => a.ip_address.localeCompare(b.ip_address) },
        {
          title: '所屬團隊', key: 'team', render: (_, record) => {
            // 找到包含此資源的資源群組
            const group = groups.find(g => g.members && g.members.includes(record.key));
            if (group && group.responsibleTeam) {
              const team = teams.find(t => t.key === group.responsibleTeam);
              return team ? team.name : '-';
            }
            return '-';
          }
        },
        { title: '類型', dataIndex: 'type', filters: [{ text: 'Database', value: 'database' }, { text: 'Server', value: 'server' }, { text: 'Gateway', value: 'gateway' }, { text: 'Cache', value: 'cache' },], onFilter: (value, record) => record.type.indexOf(value) === 0 },
        { title: '操作', key: 'action', render: (_, record) => (<Space> <Tooltip title="編輯"><Button size="small" className="btn btn--info btn--icon-only btn--sm" icon={<EditOutlined />} onClick={() => showModal(record)} /></Tooltip> <Tooltip title="刪除"><Button size="small" className="btn btn--danger btn--icon-only btn--sm" icon={<DeleteOutlined />} onClick={() => handleDelete(record.key)} /></Tooltip> </Space>) }
      ];
      const filteredResources = resources.filter(res => res.name.toLowerCase().includes(searchText.toLowerCase()) || res.ip_address.toLowerCase().includes(searchText.toLowerCase()));

      return (<React.Fragment> <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}> <Title level={2} className="page-title" style={{ margin: 0 }}>資源列表</Title> <Space> {hasSelected && (<Button type="default" onClick={handleBatchDelete} danger>批次刪除 ({selectedRowKeys.length})</Button>)} <Input.Search placeholder="搜尋資源名稱或 IP" onChange={e => setSearchText(e.target.value)} style={{ width: 300 }} /> <Button type="primary" icon={<PlusOutlined />} onClick={() => showModal()}>新增資源</Button> </Space> </div> <Paragraph className="page-subtitle" type="secondary">集中管理、探索與操作所有監控資源。</Paragraph> <div className="resource-list-container"> <div className="table-wrapper"> {resources.length > 0 ? <Table rowSelection={rowSelection} columns={columns} dataSource={filteredResources} rowKey="key" style={{ background: 'transparent' }} /> : <Empty description="尚無任何資源"> <Button type="primary" icon={<PlusOutlined />} onClick={() => showModal()}>立即新增資源</Button> </Empty>} </div> </div>);
        <Modal title={editingResource ? '編輯資源' : '新增資源'} open={isModalOpen} onCancel={handleCancel} footer={null}>
          <Form form={form} layout="vertical" onFinish={onFinish} style={{ marginTop: 24 }}>
            <Form.Item name="name" label="資源名稱" rules={[{ required: true }]}><Input /></Form.Item>
            <Form.Item name="ip_address" label="IP 位址" rules={[{ required: true }]}><Input /></Form.Item>
            <Form.Item name="type" label="類型" rules={[{ required: true }]}> <Select> <Select.Option value="server">Server</Select.Option> <Select.Option value="database">Database</Select.Option> <Select.Option value="gateway">Gateway</Select.Option> <Select.Option value="cache">Cache</Select.Option> <Select.Option value="container">Container</Select.Option> </Select> </Form.Item>
            <Form.Item name="groups" label="所屬群組">
              <div style={{ maxHeight: '150px', overflowY: 'auto', border: '1px solid #444', padding: '8px', borderRadius: '4px' }}>
                <Checkbox.Group options={mockGroups.map(g => ({ label: g.name, value: g.id }))} />
              </div>
            </Form.Item>
            <Form.Item style={{ textAlign: 'right' }}> <Button onClick={handleCancel} style={{ marginRight: 8 }}>取消</Button> <Button type="primary" htmlType="submit">確定</Button> </Form.Item>
          </Form>
        </Modal>
      </React.Fragment>);
    };

    const ResourceGroupsPage = () => {
      const allResourcesData = [
        { key: 'r_1', name: 'db-prod-01', type: 'database', status: 'healthy', ip_address: '10.0.0.10' },
        { key: 'r_2', name: 'web-prod-02', type: 'server', status: 'warning', ip_address: '10.0.0.21' },
        { key: 'r_3', name: 'api-gateway-prod', type: 'gateway', status: 'critical', ip_address: '10.0.0.35' },
        { key: 'r_4', name: 'cache-redis-prod', type: 'cache', status: 'healthy', ip_address: '10.0.0.40' },
        { key: 'r_5', name: 'web-staging-01', type: 'server', status: 'healthy', ip_address: '10.1.0.11' },
        { key: 'r_6', name: 'db-staging-01', type: 'database', status: 'healthy', ip_address: '10.1.0.12' },
        { key: 'r_7', name: 'network-switch-01', type: 'network', status: 'healthy', ip_address: '192.168.1.1' },
        { key: 'r_8', name: 'prometheus-server', type: 'monitoring', status: 'healthy', ip_address: '10.0.0.50' },
        { key: 'r_9', name: 'grafana-server', type: 'monitoring', status: 'healthy', ip_address: '10.0.0.51' },
        { key: 'r_10', name: 'jenkins-server', type: 'ci_cd', status: 'healthy', ip_address: '10.0.0.60' },
        { key: 'r_11', name: 'gitlab-server', type: 'development', status: 'healthy', ip_address: '10.0.0.70' },
      ];

      const initialGroups = [
        { key: 'g_1', name: 'Production Database', description: '所有生產環境的資料庫', members: ['r_1'], responsibleTeam: 't_6' },
        { key: 'g_2', name: 'Production Web Servers', description: '所有生產環境的 Web 伺服器', members: ['r_2'], responsibleTeam: 't_5' },
        { key: 'g_3', name: 'Staging Environment', description: '測試環境所有資源', members: ['r_5', 'r_6'], responsibleTeam: 't_1' },
        { key: 'g_4', name: 'Network Infrastructure', description: '網路基礎設施資源', members: ['r_3', 'r_7'], responsibleTeam: 't_7' },
        { key: 'g_5', name: 'Monitoring Systems', description: '監控系統與告警資源', members: ['r_4', 'r_8', 'r_9'], responsibleTeam: 't_9' },
        { key: 'g_6', name: 'Security Resources', description: '安全相關的資源與工具', members: [], responsibleTeam: 't_8' },
        { key: 'g_7', name: 'Development Tools', description: '開發環境與工具資源', members: ['r_10', 'r_11'], responsibleTeam: 't_10' },
      ];

      const initialTeams = [
        { key: 't_1', name: 'Developers', description: '負責開發與維護的核心團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_devops'], createdAt: dayjs().subtract(60, 'day'), owner: 'u_2' },
        { key: 't_2', name: 'Viewers', description: '僅有檢視權限的觀察員', members: ['u_3'], subscribers: ['u_2'], createdAt: dayjs().subtract(45, 'day'), owner: 'u_1' },
        { key: 't_3', name: 'Administrators', description: '平台最高權限管理者', members: ['u_1', 'u_4'], subscribers: ['u_1', 'slack_network', 'email_security', 'oncall_security'], createdAt: dayjs().subtract(90, 'day'), owner: 'u_1' },
        { key: 't_4', name: 'QA Team', description: '品質保證與測試團隊', members: [], subscribers: ['u_3', 'email_ops'], createdAt: dayjs().subtract(20, 'day'), owner: 'u_1' },
        { key: 't_5', name: 'DevOps Team', description: '負責CI/CD和基礎設施自動化的團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_devops'], createdAt: dayjs().subtract(30, 'day'), owner: 'u_2' },
        { key: 't_6', name: 'Database Team', description: '負責資料庫管理與優化的團隊', members: ['u_1'], subscribers: ['u_1', 'slack_database'], createdAt: dayjs().subtract(40, 'day'), owner: 'u_1' },
        { key: 't_7', name: 'Network Team', description: '負責網路基礎設施與安全的團隊', members: ['u_3'], subscribers: ['u_3', 'slack_network'], createdAt: dayjs().subtract(50, 'day'), owner: 'u_3' },
        { key: 't_8', name: 'Security Team', description: '負責資訊安全與合規的團隊', members: ['u_4'], subscribers: ['u_4', 'email_security', 'oncall_security'], createdAt: dayjs().subtract(35, 'day'), owner: 'u_4' },
        { key: 't_9', name: 'Operations Team', description: '負責系統運營與監控的團隊', members: ['u_1', 'u_2', 'u_3'], subscribers: ['u_1', 'slack_operations'], createdAt: dayjs().subtract(25, 'day'), owner: 'u_1' },
        { key: 't_10', name: 'Platform Team', description: '負責平台架構與技術基礎設施的團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_platform'], createdAt: dayjs().subtract(15, 'day'), owner: 'u_2' },
      ];

      const [groups, setGroups] = useLocalStorageState('sre-groups', initialGroups);
      const [teams] = useLocalStorageState('sre-teams', initialTeams);
      const [allResources] = useState(allResourcesData.map(r => ({ ...r, title: r.name })));
      const [isGroupModalOpen, setIsGroupModalOpen] = useState(false);
      const [editingGroup, setEditingGroup] = useState(null);
      const [targetKeys, setTargetKeys] = useState([]);
      const [searchText, setSearchText] = useState('');
      const [groupForm] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      const getStatusSummary = (memberKeys) => {
        const summary = { healthy: 0, warning: 0, critical: 0 };
        memberKeys.forEach(key => {
          const resource = allResources.find(r => r.key === key);
          if (resource) {
            summary[resource.status]++;
          }
        });
        return summary;
      };

      const showGroupModal = (group = null) => {
        setEditingGroup(group);
        groupForm.setFieldsValue(group || { name: '', description: '', responsibleTeam: '' });
        setTargetKeys(group ? (group.members || []) : []);
        setIsGroupModalOpen(true);
      };
      const handleGroupCancel = () => {
        setIsGroupModalOpen(false);
        setEditingGroup(null);
        setTargetKeys([]);
        groupForm.resetFields();
      };
      const handleGroupFinish = (values) => {
        if (editingGroup) {
          setGroups(groups.map(g => g.key === editingGroup.key ? { ...g, ...values, members: targetKeys } : g));
          message.success('群組更新成功');
        } else {
          const newGroup = { ...values, key: `g_${Date.now()}`, members: targetKeys };
          setGroups([newGroup, ...groups]);
          message.success('群組新增成功');
        }
        handleGroupCancel();
      };
      const handleGroupDelete = (key) => {
        modal.confirm({ title: '確定要刪除此群組嗎？', icon: <ExclamationCircleOutlined />, content: '此操作無法復原。', okText: '確定', okType: 'danger', cancelText: '取消', onOk() { setGroups(groups.filter(g => g.key !== key)); message.success('群組刪除成功'); } });
      };


      const getTeamName = (teamKey) => {
        if (!teamKey) return '-';
        const team = teams.find(t => t.key === teamKey);
        return team ? team.name : teamKey;
      };

      const columns = [
        { title: '群組名稱', dataIndex: 'name', sorter: (a, b) => a.name.localeCompare(b.name) },
        { title: '描述', dataIndex: 'description' },
        { title: '負責團隊', dataIndex: 'responsibleTeam', render: responsibleTeam => getTeamName(responsibleTeam) },
        { title: '成員數量', dataIndex: 'members', render: members => members.length },
        {
          title: '狀態摘要', dataIndex: 'members', render: members => {
            const summary = getStatusSummary(members);
            return (
              <span>
                <Tag color="green">Healthy: {summary.healthy}</Tag>
                <Tag color="orange">Warning: {summary.warning}</Tag>
                <Tag color="red">Critical: {summary.critical}</Tag>
              </span>
            );
          }
        },
        {
          title: '操作', key: 'action', render: (_, record) => (
            <Space>
              <Tooltip title="編輯"><Button size="small" className="btn btn--info btn--icon-only btn--sm" icon={<EditOutlined />} onClick={() => showGroupModal(record)} /></Tooltip>
              <Tooltip title="刪除"><Button size="small" className="btn btn--danger btn--icon-only btn--sm" icon={<DeleteOutlined />} onClick={() => handleGroupDelete(record.key)} /></Tooltip>
            </Space>
          )
        },
      ];

      const filteredGroups = groups.filter(g => g.name.toLowerCase().includes(searchText.toLowerCase()));

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>資源群組</Title>
            <Space>
              <Input.Search placeholder="搜尋群組名稱" onChange={e => setSearchText(e.target.value)} style={{ width: 300 }} />
              <Button type="primary" icon={<PlusOutlined />} onClick={() => showGroupModal()}>新增群組</Button>
            </Space>
          </div>
          <Paragraph className="page-subtitle" type="secondary">管理資源的分群，支援階層，並提供群組層級的狀態摘要與成員管理。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              {
                filteredGroups.length > 0 ?
                  <Table columns={columns} dataSource={filteredGroups} rowKey="key" style={{ background: 'transparent' }} /> :
                  <Empty description="尚無任何資源群組">
                    <Button type="primary" icon={<PlusOutlined />} onClick={() => showGroupModal()}>立即新增群組</Button>
                  </Empty>
              }
            </div>
          </div>

          <Modal title={editingGroup ? '編輯群組' : '新增群組'} open={isGroupModalOpen} onCancel={handleGroupCancel} footer={null} width={900}>
            <Form form={groupForm} layout="vertical" onFinish={handleGroupFinish} style={{ marginTop: 24 }}>
              <Form.Item name="name" label="群組名稱" rules={[{ required: true, message: '請輸入群組名稱' }]}>
                <Input />
              </Form.Item>
              <Form.Item name="description" label="描述">
                <TextArea rows={3} />
              </Form.Item>
              <Form.Item name="responsibleTeam" label="負責團隊">
                <Select placeholder="請選擇負責團隊" allowClear>
                  {teams.map(team => (
                    <Select.Option key={team.key} value={team.key}>
                      {team.name}
                    </Select.Option>
                  ))}
                </Select>
              </Form.Item>
              <Form.Item label="群組資源">
                <Transfer
                  dataSource={allResources.map(resource => ({
                    key: resource.key,
                    title: `${resource.name} (${resource.type})`,
                    description: resource.ip_address,
                    status: resource.status,
                    name: resource.name,
                    type: resource.type,
                    ip_address: resource.ip_address
                  }))}
                  showSearch
                  filterOption={(inputValue, item) =>
                    item.name.toLowerCase().includes(inputValue.toLowerCase()) ||
                    item.type.toLowerCase().includes(inputValue.toLowerCase()) ||
                    item.ip_address.includes(inputValue)
                  }
                  targetKeys={targetKeys}
                  onChange={(targetKeys) => {
                    setTargetKeys(targetKeys);
                  }}
                  render={item => {
                    const resource = allResources.find(r => r.key === item.key);
                    return (
                      <div style={{ padding: '4px 0', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div style={{ fontWeight: '500', color: 'rgba(255, 255, 255, 0.9)', flex: 1 }}>
                          {item.name}
                        </div>
                        <div style={{ fontSize: '12px', color: 'rgba(255, 255, 255, 0.6)', flexShrink: 0 }}>
                          {item.type} • {item.ip_address}
                        </div>
                        <Tag size="small" color={
                          resource?.status === 'healthy' ? 'green' :
                            resource?.status === 'warning' ? 'orange' : 'red'
                        } style={{ flexShrink: 0 }}>
                          {resource?.status === 'healthy' ? '健康' :
                            resource?.status === 'warning' ? '警告' : '嚴重'}
                        </Tag>
                      </div>
                    );
                  }}
                  listStyle={{
                    width: 420,
                    height: 300,
                  }}
                  locale={{
                    itemUnit: '個資源',
                    itemsUnit: '個資源',
                    searchPlaceholder: '搜尋資源名稱、類型或IP'
                  }}
                  titles={['可用資源', '群組成員']}
                />
              </Form.Item>
              <Form.Item style={{ textAlign: 'right', marginTop: 24, marginBottom: 0 }}>
                <Button onClick={handleGroupCancel} style={{ marginRight: 8 }}>取消</Button>
                <Button type="primary" htmlType="submit">{editingGroup ? '更新群組' : '創建群組'}</Button>
              </Form.Item>
            </Form>
          </Modal>

        </React.Fragment>
      );
    };

    const ResourcesPage = ({ onNavigate }) => {
      const cards = [{ key: 'resource-list', icon: <HddOutlined />, title: '資源列表', description: '集中管理、探索與操作所有監控資源。' }, { key: 'resource-groups', icon: <ApartmentOutlined />, title: '資源群組', description: '管理資源的分群，支援階層化管理。' },];
      return (<React.Fragment> <Title level={2} className="page-title">資源管理</Title> <Paragraph className="page-subtitle" type="secondary">探索、組織與管理您的所有基礎設施資源。</Paragraph> <Row gutter={[16, 16]}> {cards.map(item => (<Col key={item.key} xs={24} md={12} lg={8}> <div className="nav-item" onClick={() => onNavigate(item.key)}> <div className="nav-item-content"> <div className="nav-item-icon">{item.icon}</div> <div className="nav-item-text"> <Title level={5} className="nav-item-title">{item.title}</Title> <Paragraph className="nav-item-description">{item.description}</Paragraph> </div> </div> </div> </Col>))} </Row> </React.Fragment>);
    };

    const IncidentsPage = ({ onNavigate }) => {
      const cards = [{ key: 'incident-list', icon: <HistoryOutlined />, title: '事件紀錄', description: '高效的事件處理中心，追蹤所有告警事件。' }, { key: 'alerting-rules', icon: <BellOutlined />, title: '告警規則', description: '定義事件觸發條件，並關聯通知與自動化。' }, { key: 'silences', icon: <PauseCircleOutlined />, title: '靜音規則', description: '建立臨時或計劃性的靜音，例如維護時段。' },];
      return (<React.Fragment> <Title level={2} className="page-title">事件中心</Title> <Paragraph className="page-subtitle" type="secondary">集中管理告警、事件並設定靜音規則。</Paragraph> <Row gutter={[16, 16]}> {cards.map(item => (<Col key={item.key} xs={24} md={12} lg={8}> <div className="nav-item" onClick={() => onNavigate(item.key)}> <div className="nav-item-content"> <div className="nav-item-icon">{item.icon}</div> <div className="nav-item-text"> <Title level={5} className="nav-item-title">{item.title}</Title> <Paragraph className="nav-item-description">{item.description}</Paragraph> </div> </div> </div> </Col>))} </Row> </React.Fragment>);
    };

    const AnalyzingPage = ({ onNavigate }) => {
      const cards = [{ key: 'capacity-planning', icon: <BarChartOutlined />, title: '容量規劃', description: '分析歷史數據，預測未來資源消耗趨勢。' },];
      return (<React.Fragment> <Title level={2} className="page-title">分析與報告</Title> <Paragraph className="page-subtitle" type="secondary">深入了解系統趨勢與效能瓶頸。</Paragraph> <Row gutter={[16, 16]}> {cards.map(item => (<Col key={item.key} xs={24} md={12} lg={8}> <div className="nav-item" onClick={() => onNavigate(item.key)}> <div className="nav-item-content"> <div className="nav-item-icon">{item.icon}</div> <div className="nav-item-text"> <Title level={5} className="nav-item-title">{item.title}</Title> <Paragraph className="nav-item-description">{item.description}</Paragraph> </div> </div> </div> </Col>))} </Row> </React.Fragment>);
    };

    const AutomationPage = ({ onNavigate }) => {
      const cards = [{ key: 'scripts', icon: <CodeOutlined />, title: '腳本庫', description: '管理、編輯與測試用於自動化修復或日常任務的腳本。' }, { key: 'schedules', icon: <ScheduleOutlined />, title: '排程管理', description: '設定定時執行的自動化任務，例如備份或健康檢查。' }, { key: 'executions', icon: <CarryOutOutlined />, title: '執行日誌', description: '追蹤所有自動化腳本的執行歷史、狀態與結果。' },];
      return (<React.Fragment> <Title level={2} className="page-title">自動化中心</Title> <Paragraph className="page-subtitle" type="secondary">管理自動化腳本、排程任務與執行歷史。</Paragraph> <Row gutter={[16, 16]}> {cards.map(item => (<Col key={item.key} xs={24} md={12} lg={8}> <div className="nav-item" onClick={() => onNavigate(item.key)}> <div className="nav-item-content"> <div className="nav-item-icon">{item.icon}</div> <div className="nav-item-text"> <Title level={5} className="nav-item-title">{item.title}</Title> <Paragraph className="nav-item-description">{item.description}</Paragraph> </div> </div> </div> </Col>))} </Row> </React.Fragment>);
    };

    const IncidentListPage = ({ onNavigate }) => {
      const initialData = [
        { key: 'i_0', summary: 'Network Switch CPU High', severity: 'critical', source: 'Datadog', status: 'new', created_at: dayjs().subtract(1, 'minutes'), automation_id: null, assignee: null, resource_name: 'network-switch-01' },
        { key: 'i_1', summary: 'CPU high on db-prod-01', severity: 'critical', source: 'Prometheus', status: 'acknowledged', created_at: dayjs().subtract(5, 'minutes'), automation_id: null, assignee: 'u_2', resource_name: 'db-prod-01' },
        { key: 'i_2', summary: 'Disk space low on web-prod-02', severity: 'warning', source: 'Grafana', status: 'new', created_at: dayjs().subtract(2, 'hour'), automation_id: 'e_1', assignee: null, resource_name: 'web-prod-02' },
        { key: 'i_3', summary: 'API latency over 500ms', severity: 'warning', source: 'Datadog', status: 'acknowledged', created_at: dayjs().subtract(1, 'day'), assignee: 'u_4', resource_name: 'api-gateway-prod' },
        { key: 'i_4', summary: 'Prometheus Server Down', severity: 'critical', source: 'Kubernetes', status: 'resolved', created_at: dayjs().subtract(3, 'day'), assignee: 'u_1', resource_name: 'prometheus-server' },
        { key: 'i_5', summary: '記憶體使用率過高 - staging', severity: 'warning', source: 'Prometheus', status: 'new', created_at: dayjs().subtract(15, 'minutes'), automation_id: null, assignee: null, resource_name: 'web-staging-01' },
        { key: 'i_6', summary: 'Cache Redis Memory Full', severity: 'critical', source: 'Grafana', status: 'new', created_at: dayjs().subtract(30, 'minutes'), automation_id: null, assignee: null, resource_name: 'cache-redis-prod' },
      ];
      const [incidents, setIncidents] = useLocalStorageState('sre-incidents-v2', initialData);
      const [searchText, setSearchText] = useState('');
      const [selectedRowKeys, setSelectedRowKeys] = useState([]);
      const [isDetailModalOpen, setIsDetailModalOpen] = useState(false);
      const [currentIncident, setCurrentIncident] = useState(null);
      const [isSilenceModalOpen, setIsSilenceModalOpen] = useState(false);
      const [silenceIncident, setSilenceIncident] = useState(null);
      const [silenceDuration, setSilenceDuration] = useState(1);
      const { message, modal } = antd.App.useApp();

      const handleStatusChange = (keys, newStatus) => {
        const actionText = newStatus === 'acknowledged' ? '確認' : '解決';
        setIncidents(incidents.map(inc => (keys.includes(inc.key) ? { ...inc, status: newStatus } : inc)));
        message.success(`事件狀態已更新`);
        if (isDetailModalOpen) {
          setCurrentIncident(prev => ({ ...prev, status: newStatus }));
        }
      };

      const handleBatchUpdate = (newStatus) => {
        const actionText = newStatus === 'acknowledged' ? '確認' : '解決';
        modal.confirm({
          title: `確定要批次 ${actionText} ${selectedRowKeys.length} 個事件嗎？`,
          icon: <ExclamationCircleOutlined />,
          onOk() {
            handleStatusChange(selectedRowKeys, newStatus);
            setSelectedRowKeys([]);
          }
        });
      };

      const handleAIAnalysis = (selectedKeys = null) => {
        const keysToAnalyze = selectedKeys || selectedRowKeys;
        if (keysToAnalyze.length === 0) {
          message.warning('請先選擇要分析的事件');
          return;
        }

        message.loading({ content: `AI 正在分析 ${keysToAnalyze.length} 個事件...`, key: 'ai-analysis' });
        setTimeout(() => {
          const analyzedEvents = incidents.filter(incident => keysToAnalyze.includes(incident.key));
          const analysisResults = analyzedEvents.map(event => `${event.summary} - 建議立即處理`).join('; ');

          message.success({
            content: `AI 分析完成：${analysisResults}`,
            key: 'ai-analysis',
            duration: 6
          });
        }, 2000);
      };

      const showDetailModal = (record) => {
        setCurrentIncident(record);
        setIsDetailModalOpen(true);
      };

      const showSilenceModal = (record) => {
        setSilenceIncident(record);
        setSilenceDuration(1); // 預設1小時
        setIsSilenceModalOpen(true);
      };

      const hideSilenceModal = () => {
        setIsSilenceModalOpen(false);
        setSilenceIncident(null);
        setSilenceDuration(1);
      };

      const handleSilence = () => {
        if (!silenceIncident) return;

        // 創建靜音規則的匹配條件
        const matchers = [
          { key: 'alert_name', op: '=', value: silenceIncident.summary },
          { key: 'resource_name', op: '=', value: silenceIncident.resource_name },
          { key: 'severity', op: '=', value: silenceIncident.severity }
        ];

        // 創建靜音規則物件
        const silenceRule = {
          key: `s_temp_${Date.now()}`,
          name: `臨時靜音 - ${silenceIncident.summary}`,
          description: `臨時靜音規則，由告警列表快速建立`,
          type: 'once',
          timeRange: [
            dayjs(),
            dayjs().add(silenceDuration, 'hour')
          ],
          matchers: matchers,
          creator: 'admin', // 應該從當前用戶獲取
          enabled: true,
          createdFromIncident: silenceIncident.key
        };

        // 獲取現有的靜音規則並添加新規則
        const existingSilences = JSON.parse(localStorage.getItem('sre-silences-v2') || '[]');
        existingSilences.push(silenceRule);
        localStorage.setItem('sre-silences-v2', JSON.stringify(existingSilences));

        // 更新當前告警的狀態為靜音
        setIncidents(incidents.map(inc =>
          inc.key === silenceIncident.key
            ? { ...inc, status: 'silenced', silencedUntil: dayjs().add(silenceDuration, 'hour') }
            : inc
        ));

        message.success(`已建立 ${silenceDuration} 小時的靜音規則`);
        hideSilenceModal();
      };

      const columns = [
        {
          title: '狀態', dataIndex: 'status', filters: [{ text: 'New', value: 'new' }, { text: 'Acknowledged', value: 'acknowledged' }, { text: 'Resolved', value: 'resolved' }, { text: 'Silenced', value: 'silenced' }], onFilter: (v, r) => r.status && r.status.includes(v), render: (s, record) => {
            const statusColors = {
              new: 'blue',
              acknowledged: 'orange',
              resolved: 'green',
              silenced: 'gray'
            };
            const statusText = s === 'silenced' ? '靜音中' : s?.toUpperCase() || 'UNKNOWN';
            return <Tag color={statusColors[s] || 'default'}>{statusText}</Tag>;
          }
        },
        { title: '嚴重性', dataIndex: 'severity', sorter: (a, b) => a.severity.localeCompare(b.severity), filters: [{ text: 'Critical', value: 'critical' }, { text: 'Warning', value: 'warning' }], onFilter: (v, r) => r.severity && r.severity.includes(v), render: s => <Tag color={s === 'critical' ? 'red' : 'orange'}>{s ? s.toUpperCase() : 'UNKNOWN'}</Tag> },
        { title: '觸發時間', dataIndex: 'created_at', sorter: (a, b) => a.created_at.valueOf() - b.created_at.valueOf(), render: time => <span title={time ? time.format('YYYY-MM-DD HH:mm:ss') : ''}>{time ? time.fromNow() : '-'}</span> },
        { title: '資源名稱', dataIndex: 'resource_name', sorter: (a, b) => (a || '').localeCompare(b || ''), render: name => name || '-' },
        { title: '處理人', dataIndex: 'assignee', sorter: (a, b) => (a || '').localeCompare(b || ''), render: (assignee) => assignee || '-' },
        { title: '摘要', dataIndex: 'summary', sorter: (a, b) => a.summary.localeCompare(b.summary), render: (text, record) => <a onClick={() => showDetailModal(record)}>{text}</a> },
        {
          title: '操作', key: 'action', render: (_, record) => (
            <Space>
              <Tooltip title="確認事件">
                <Button
                  size="small"
                  className="btn btn--primary btn--sm"
                  icon={<CheckCircleOutlined />}
                  disabled={record.status !== 'new'}
                  onClick={() => handleStatusChange([record.key], 'acknowledged')}
                >
                  確認
                </Button>
              </Tooltip>
              <Tooltip title={record.status === 'silenced' ? '已靜音' : '設置靜音'}>
                <Button
                  size="small"
                  className="btn btn--warning btn--sm"
                  icon={<PauseCircleOutlined />}
                  disabled={record.status === 'resolved'}
                  onClick={() => showSilenceModal(record)}
                >
                  {record.status === 'silenced' ? '已靜音' : '靜音'}
                </Button>
              </Tooltip>
              <Tooltip title="查看詳情">
                <Button
                  size="small"
                  className="btn btn--neutral btn--sm"
                  icon={<InfoCircleOutlined />}
                  onClick={() => showDetailModal(record)}
                >
                  詳情
                </Button>
              </Tooltip>
            </Space>
          )
        },
      ];

      const filteredIncidents = searchText ? incidents.filter(inc =>
        inc.summary.toLowerCase().includes(searchText.toLowerCase()) ||
        inc.status.toLowerCase().includes(searchText.toLowerCase()) ||
        (inc.assignee && inc.assignee.toLowerCase().includes(searchText.toLowerCase())) ||
        (inc.resource_name && inc.resource_name.toLowerCase().includes(searchText.toLowerCase()))
      ) : incidents;
      const onSelectChange = (newSelectedRowKeys) => setSelectedRowKeys(newSelectedRowKeys);
      const rowSelection = { selectedRowKeys, onChange: onSelectChange };
      const hasSelected = selectedRowKeys.length > 0;

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>事件紀錄</Title>
            <Space>
              {hasSelected && (
                <>
                  <Button className="btn btn--primary-outline" onClick={() => handleBatchUpdate('acknowledged')}>
                    批次確認
                  </Button>
                  <Button className="btn btn--success-outline" onClick={() => handleBatchUpdate('resolved')}>
                    批次解決
                  </Button>
                  <Button className="btn btn--info-outline" icon={<RobotOutlined />} onClick={() => handleAIAnalysis()}>
                    AI分析
                  </Button>
                  <Text type="secondary">已選取 {selectedRowKeys.length} 項</Text>
                </>
              )}
              <Input.Search placeholder="搜尋事件摘要" onChange={e => setSearchText(e.target.value)} style={{ width: 300 }} />
            </Space>
          </div>
          <Paragraph className="page-subtitle" type="secondary">高效的事件處理中心，集中追蹤、處理與分析所有告警事件。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              <Table rowSelection={rowSelection} columns={columns} dataSource={filteredIncidents} rowKey="key" style={{ background: 'transparent' }} />
            </div>
          </div>
          <Modal
            title={
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <InfoCircleOutlined style={{ color: '#1890ff' }} />
                <span>事件詳情</span>
              </div>
            }
            open={isDetailModalOpen}
            onCancel={() => setIsDetailModalOpen(false)}
            footer={
              <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
                <Button className="btn btn--neutral" onClick={() => setIsDetailModalOpen(false)}>關閉</Button>
                <Button className="btn btn--primary" disabled={currentIncident && currentIncident.status !== 'new'} onClick={() => { handleStatusChange([currentIncident.key], 'acknowledged') }}>確認收到 (Ack)</Button>
                <Button className="btn btn--info-outline" icon={<RobotOutlined />}>AI 分析</Button>
              </div>
            }
            width={800}
            style={{
              background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
              borderRadius: '12px'
            }}
          >
            {currentIncident && (
              <div style={{ marginTop: '24px' }}>
                {/* 基本資訊區塊 */}
                <div style={{
                  background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '12px',
                  padding: '20px',
                  marginBottom: '24px',
                  backdropFilter: 'blur(20px) saturate(180%)',
                  WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                    <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                    <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>基本資訊</Title>
                  </div>
                  <Descriptions bordered column={1} size="small">
                    <Descriptions.Item label="摘要">{currentIncident.summary}</Descriptions.Item>
                    <Descriptions.Item label="嚴重性"><Tag color={currentIncident.severity === 'critical' ? 'red' : 'orange'}>{currentIncident.severity ? currentIncident.severity.toUpperCase() : 'UNKNOWN'}</Tag></Descriptions.Item>
                    <Descriptions.Item label="狀態">{currentIncident.status ? currentIncident.status.toUpperCase() : 'UNKNOWN'}</Descriptions.Item>
                    <Descriptions.Item label="來源">{currentIncident.source}</Descriptions.Item>
                    <Descriptions.Item label="觸發時間">{currentIncident.created_at ? currentIncident.created_at.format('YYYY-MM-DD HH:mm:ss') : '-'}</Descriptions.Item>
                    <Descriptions.Item label="資源名稱">{currentIncident.resource_name || '-'}</Descriptions.Item>
                  </Descriptions>
                </div>

                {/* 處理歷史區塊 */}
                <div style={{
                  background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '12px',
                  padding: '20px',
                  marginBottom: '24px',
                  backdropFilter: 'blur(20px) saturate(180%)',
                  WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                    <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #fa8c16 0%, #faad14 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                    <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>處理歷史</Title>
                  </div>
                  <Timeline
                    items={[
                      { children: `事件建立於 ${currentIncident.created_at ? currentIncident.created_at.format('YYYY-MM-DD HH:mm:ss') : '未知時間'}` },
                      { children: '事件已被確認', dot: <ClockCircleOutlined />, color: 'blue' },
                      { children: '事件已解決', color: 'green' },
                    ]}
                  />
                  <div style={{ marginTop: '16px' }}>
                    <TextArea
                      rows={3}
                      placeholder="新增處理紀錄..."
                      style={{
                        background: 'rgba(255, 255, 255, 0.05)',
                        border: '1px solid rgba(255, 255, 255, 0.15)',
                        color: 'rgba(255, 255, 255, 0.85)',
                        borderRadius: '6px'
                      }}
                    />
                    <Button className="btn btn--primary" style={{ marginTop: '12px' }}>新增紀錄</Button>
                  </div>
                </div>

                {/* 關聯事件區塊 */}
                <div style={{
                  background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '12px',
                  padding: '20px',
                  marginBottom: '24px',
                  backdropFilter: 'blur(20px) saturate(180%)',
                  WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                    <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #722ed1 0%, #b37feb 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                    <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>關聯事件</Title>
                  </div>
                  <List
                    size="small"
                    bordered
                    dataSource={['API latency over 500ms']}
                    renderItem={(item) => (
                      <List.Item style={{ color: 'rgba(255, 255, 255, 0.85)', background: 'rgba(255, 255, 255, 0.02)' }}>
                        {item}
                      </List.Item>
                    )}
                  />
                </div>

                {/* 自動化區塊 */}
                <div style={{
                  background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '12px',
                  padding: '20px',
                  backdropFilter: 'blur(20px) saturate(180%)',
                  WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                  boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                }}>
                  <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                    <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #52c41a 0%, #73d13d 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                    <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>自動化</Title>
                  </div>
                  {currentIncident.automation_id ? (
                    <p style={{ color: 'rgba(255, 255, 255, 0.85)' }}>
                      執行紀錄 ID: <a onClick={() => onNavigate('executions')} style={{ color: '#1890ff' }}>{currentIncident.automation_id}</a>
                    </p>
                  ) : (
                    <p style={{ color: 'rgba(255, 255, 255, 0.7)' }}>此事件未觸發自動化腳本。</p>
                  )}
                </div>
              </div>
            )}
          </Modal>

          {/* 靜音模態框 */}
          <Modal
            title="建立靜音規則"
            open={isSilenceModalOpen}
            onCancel={hideSilenceModal}
            onOk={handleSilence}
            okText="建立靜音規則"
            cancelText="取消"
            width={600}
          >
            <div style={{ padding: '16px 0' }}>
              <div style={{ marginBottom: '20px' }}>
                <Title level={5} style={{ color: 'rgba(255, 255, 255, 0.85)', marginBottom: '12px' }}>
                  告警資訊
                </Title>
                <div style={{ background: 'rgba(255, 255, 255, 0.02)', padding: '12px', borderRadius: '6px', border: '1px solid rgba(255, 255, 255, 0.08)' }}>
                  <div style={{ marginBottom: '8px' }}>
                    <Text strong style={{ color: 'rgba(255, 255, 255, 0.9)' }}>摘要：</Text>
                    <Text style={{ color: 'rgba(255, 255, 255, 0.7)' }}>{silenceIncident?.summary}</Text>
                  </div>
                  <div style={{ marginBottom: '8px' }}>
                    <Text strong style={{ color: 'rgba(255, 255, 255, 0.9)' }}>資源：</Text>
                    <Text style={{ color: 'rgba(255, 255, 255, 0.7)' }}>{silenceIncident?.resource_name}</Text>
                  </div>
                  <div>
                    <Text strong style={{ color: 'rgba(255, 255, 255, 0.9)' }}>嚴重性：</Text>
                    <Tag color={silenceIncident?.severity === 'critical' ? 'red' : 'orange'} style={{ marginLeft: '8px' }}>
                      {silenceIncident?.severity?.toUpperCase()}
                    </Tag>
                  </div>
                </div>
              </div>

              <div style={{ marginBottom: '20px' }}>
                <Title level={5} style={{ color: 'rgba(255, 255, 255, 0.85)', marginBottom: '12px' }}>
                  靜音設定
                </Title>
                <div style={{ background: 'rgba(255, 255, 255, 0.02)', padding: '16px', borderRadius: '6px', border: '1px solid rgba(255, 255, 255, 0.08)' }}>
                  <div style={{ marginBottom: '12px' }}>
                    <Text style={{ color: 'rgba(255, 255, 255, 0.8)' }}>
                      選擇靜音持續時間：
                    </Text>
                  </div>
                  <div style={{ display: 'flex', gap: '12px', flexWrap: 'wrap' }}>
                    {[1, 2, 4, 8, 12, 24].map(duration => (
                      <Button
                        key={duration}
                        type={silenceDuration === duration ? 'primary' : 'default'}
                        size="small"
                        onClick={() => setSilenceDuration(duration)}
                        style={{
                          background: silenceDuration === duration ? undefined : 'rgba(255, 255, 255, 0.05)',
                          borderColor: 'rgba(255, 255, 255, 0.3)',
                          color: silenceDuration === duration ? undefined : 'rgba(255, 255, 255, 0.85)',
                          borderRadius: '6px',
                          transition: 'all 0.2s'
                        }}
                      >
                        {duration} 小時
                      </Button>
                    ))}
                  </div>
                  <div style={{ marginTop: '12px', padding: '8px', background: 'rgba(24, 144, 255, 0.1)', borderRadius: '4px', border: '1px solid rgba(24, 144, 255, 0.2)' }}>
                    <Text style={{ color: 'rgba(24, 144, 255, 0.9)', fontSize: '12px' }}>
                      📝 將建立靜音規則持續 {silenceDuration} 小時，到 {dayjs().add(silenceDuration, 'hour').format('YYYY-MM-DD HH:mm:ss')}
                    </Text>
                  </div>
                </div>
              </div>

              <div style={{ padding: '12px', background: 'rgba(250, 173, 20, 0.1)', borderRadius: '6px', border: '1px solid rgba(250, 173, 20, 0.2)' }}>
                <Text style={{ color: 'rgba(250, 173, 20, 0.9)', fontSize: '12px' }}>
                  💡 靜音規則將出現在「靜音規則管理」頁面中，您可以在那裡查看、管理或延長靜音時間。
                </Text>
              </div>
            </div>
          </Modal>
        </React.Fragment>
      );
    };

    const AlertingRulesPage = () => {
      const mockMetrics = [
        { id: 'cpu_utilization', name: 'CPU 使用率 (%)' },
        { id: 'memory_usage', name: '記憶體使用率 (%)' },
        { id: 'disk_space', name: '磁碟空間使用率 (%)' },
        { id: 'replication_lag_s', name: '資料庫複製延遲 (秒)' },
        { id: 'p95_latency_ms', name: 'P95 延遲 (ms)' },
      ];
      const mockScripts = [
        { id: 's_1', name: 'Auto-scaling for Web Servers', params: [{ name: 'instance_count', type: 'number', label: '實例數量' }] },
        { id: 's_2', name: 'Increase Database Disk Volume', params: [{ name: 'increase_gb', type: 'number', label: '增加容量 (GB)' }] },
        { id: 's_3', name: 'Restart Pod', params: [{ name: 'pod_name', type: 'string', label: 'Pod 名稱' }] },
      ];
      const mockChannels = [{ id: 'c_1', name: 'Email' }, { id: 'c_2', name: 'Slack' }, { id: 'c_3', name: 'Webhook' }];

      const initialRules = [
        {
          key: 'rule_1',
          name: '高 CPU 使用率',
          target: 'Production Web Servers',
          conditions: {
            operator: 'AND',
            conditions: [
              { metric: 'cpu_utilization', operator: '>', value: 90, duration: 5, durationUnit: 'minutes' },
              { metric: 'memory_usage', operator: '>', value: 85, duration: 3, durationUnit: 'minutes' }
            ]
          },
          notifications: ['Slack'],
          enabled: true
        },
        {
          key: 'rule_2',
          name: '資料庫延遲',
          target: 'Production Database',
          conditions: {
            operator: 'OR',
            conditions: [
              { metric: 'replication_lag_s', operator: '>', value: 10, duration: 2, durationUnit: 'minutes' },
              { metric: 'cpu_utilization', operator: '>', value: 95, duration: 1, durationUnit: 'minutes' }
            ]
          },
          notifications: ['Email', 'Slack'],
          enabled: true
        },
        {
          key: 'rule_3',
          name: '測試環境資源監控',
          target: 'Staging Environment',
          conditions: {
            operator: 'AND',
            conditions: [
              { metric: 'memory_usage', operator: '>', value: 80, duration: 10, durationUnit: 'minutes' },
              { metric: 'disk_space', operator: '<', value: 15, duration: 5, durationUnit: 'minutes' }
            ]
          },
          notifications: ['Email'],
          enabled: false
        },
        {
          key: 'rule_4',
          name: '網路基礎設施監控',
          target: 'Network Infrastructure',
          conditions: {
            operator: 'OR',
            conditions: [
              { metric: 'p95_latency_ms', operator: '>', value: 500, duration: 3, durationUnit: 'minutes' },
              { metric: 'cpu_utilization', operator: '>', value: 80, duration: 5, durationUnit: 'minutes' }
            ]
          },
          notifications: ['PagerDuty'],
          enabled: true
        },
        {
          key: 'rule_5',
          name: '複雜告警規則',
          target: 'Monitoring Systems',
          conditions: {
            operator: 'AND',
            conditions: [
              {
                operator: 'OR',
                conditions: [
                  { metric: 'cpu_utilization', operator: '>', value: 90, duration: 5, durationUnit: 'minutes' },
                  { metric: 'memory_usage', operator: '>', value: 90, duration: 3, durationUnit: 'minutes' }
                ]
              },
              { metric: 'disk_space', operator: '<', value: 10, duration: 10, durationUnit: 'minutes' }
            ]
          },
          notifications: ['Slack', 'PagerDuty'],
          enabled: true
        }
      ];

      const [rules, setRules] = useLocalStorageState('sre-alert-rules', initialRules);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingRule, setEditingRule] = useState(null);
      const [searchText, setSearchText] = useState('');
      const [form] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      const [selectedScriptId, setSelectedScriptId] = useState(null);

      const handleFormChange = (changedValues, allValues) => {
        if ('automation_script' in changedValues) {
          setSelectedScriptId(changedValues.automation_script);
        }
      };

      const selectedScript = mockScripts.find(s => s.id === selectedScriptId);

      const applyAlertTemplate = (templateType) => {
        const templates = {
          cpu_multi_level: {
            name: 'CPU 多等級告警規則',
            description: '根據不同的 CPU 使用率設定不同等級的告警',
            condition_groups: [
              {
                severity: 'critical',
                conditions: [{
                  metric: 'cpu_utilization',
                  operator: '>',
                  value: 95,
                  duration: 1,
                  duration_unit: 'minutes'
                }]
              },
              {
                severity: 'warning',
                conditions: [{
                  metric: 'cpu_utilization',
                  operator: '>',
                  value: 80,
                  duration: 5,
                  duration_unit: 'minutes'
                }]
              }
            ],
            title_template: '🚨 {{resource.name}} CPU 異常',
            content_template: '{{resource.name}} 的 CPU 使用率已達 {{metric.value}}%，持續時間：{{duration}} {{duration_unit}}。請立即關注系統狀態。'
          },
          cpu_high: {
            name: 'CPU 使用率過高',
            description: '當 CPU 使用率超過 80% 時觸發告警',
            condition_groups: [{
              severity: 'warning',
              conditions: [{
                metric: 'cpu_utilization',
                operator: '>',
                value: 80,
                duration: 5,
                duration_unit: 'minutes'
              }]
            }],
            title_template: '🚨 {{resource.name}} CPU 使用率異常',
            content_template: '{{resource.name}} 的 CPU 使用率已持續 {{duration}} 分鐘超過閾值 {{threshold}}%，目前數值為 {{metric.value}}%。建議立即檢查系統負載。',
            automation_enabled: true,
            automation_script: 's_1'
          },
          memory_high: {
            name: '記憶體使用率過高',
            description: '當記憶體使用率超過 85% 時觸發告警',
            condition_groups: [{
              severity: 'warning',
              conditions: [{
                metric: 'memory_usage',
                operator: '>',
                value: 85,
                duration: 3,
                duration_unit: 'minutes'
              }]
            }],
            title_template: '🚨 {{resource.name}} 記憶體使用率異常',
            content_template: '{{resource.name}} 的記憶體使用率已持續 {{duration}} 分鐘超過閾值 {{threshold}}%，目前數值為 {{metric.value}}%。可能需要檢查應用程式的記憶體使用情況。',
          },
          disk_space_low: {
            name: '磁碟空間不足',
            description: '當磁碟空間使用率超過 90% 時觸發告警',
            condition_groups: [{
              severity: 'critical',
              conditions: [{
                metric: 'disk_space',
                operator: '>',
                value: 90,
                duration: 10,
                duration_unit: 'minutes'
              }]
            }],
            title_template: '🚨 {{resource.name}} 磁碟空間不足',
            content_template: '{{resource.name}} 的磁碟空間使用率已持續 {{duration}} 分鐘超過閾值 {{threshold}}%，目前數值為 {{metric.value}}%。建議立即清理磁碟空間或擴展儲存容量。',
            automation_enabled: true,
            automation_script: 's_2'
          },
          database_lag: {
            name: '資料庫複製延遲',
            description: '當資料庫複製延遲超過 5 秒時觸發告警',
            condition_groups: [{
              severity: 'critical',
              conditions: [{
                metric: 'replication_lag_s',
                operator: '>',
                value: 5,
                duration: 2,
                duration_unit: 'minutes'
              }]
            }],
            title_template: '🚨 {{resource.name}} 資料庫複製延遲',
            content_template: '{{resource.name}} 的資料庫複製延遲已持續 {{duration}} 分鐘超過閾值 {{threshold}} 秒，目前延遲為 {{metric.value}} 秒。請檢查資料庫複製狀態。'
          },
          api_latency: {
            name: 'API 延遲過高',
            description: '當 P95 延遲超過 500ms 時觸發告警',
            condition_groups: [{
              severity: 'warning',
              conditions: [{
                metric: 'p95_latency_ms',
                operator: '>',
                value: 500,
                duration: 5,
                duration_unit: 'minutes'
              }]
            }],
            title_template: '🚨 {{resource.name}} API 延遲過高',
            content_template: '{{resource.name}} 的 API P95 延遲已持續 {{duration}} 分鐘超過閾值 {{threshold}}ms，目前延遲為 {{metric.value}}ms。建議檢查應用程式效能和負載情況。'
          }
        };

        const template = templates[templateType];
        if (template) {
          form.setFieldsValue(template);
          if (template.automation_script) {
            setSelectedScriptId(template.automation_script);
          }
          message.success(`已套用範本：${template.name}`);
        }
      };

      const showModal = (rule = null) => {
        setEditingRule(rule);
        const initialValues = rule || {
          name: '',
          description: '',
          condition_groups: [{ severity: 'warning', conditions: [{ duration: 5, duration_unit: 'minutes' }] }],
          automation_enabled: false
        };
        form.setFieldsValue(initialValues);
        setSelectedScriptId(initialValues.automation_script || null);
        setIsModalOpen(true);
      };

      const handleCancel = () => {
        setIsModalOpen(false);
        setEditingRule(null);
        form.resetFields();
        setSelectedScriptId(null);
      };

      const onFinish = (values) => {
        console.log("Rule Submitted:", values);
        message.success(editingRule ? '規則更新成功' : '規則新增成功');
        handleCancel();
      };

      const handleDelete = (key) => {
        modal.confirm({
          title: '確定要刪除此規則嗎？', icon: <ExclamationCircleOutlined />, onOk: () => {
            setRules(rules.filter(r => r.key !== key));
            message.success('規則已刪除');
          }
        });
      };

      const handleToggleEnable = (key, checked) => {
        setRules(rules.map(r => r.key === key ? { ...r, enabled: checked } : r));
        message.success(`規則已${checked ? '啟用' : '停用'}`);
      };

      const columns = [
        { title: '規則名稱', dataIndex: 'name', sorter: (a, b) => a.name.localeCompare(b.name) },
        { title: '監控對象', dataIndex: 'target' },
        { title: '觸發條件', dataIndex: 'conditions' },
        { title: '狀態', dataIndex: 'enabled', render: (enabled, record) => <Switch checked={enabled} onChange={(checked) => handleToggleEnable(record.key, checked)} /> },
        {
          title: '操作', key: 'action', render: (_, record) => (
            <Space>
              <Button type="link" onClick={() => showModal(record)}>編輯</Button>
              <Button type="link" danger onClick={() => handleDelete(record.key)}>刪除</Button>
            </Space>
          )
        }
      ];

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>告警規則</Title>
            <Space>
              <Input.Search placeholder="搜尋規則名稱" style={{ width: 300 }} />
              <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>新增規則</Button>
            </Space>
          </div>
          <Paragraph className="page-subtitle" type="secondary">定義事件觸發條件，並關聯自動化腳本與團隊通知。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              {
                rules.length > 0 ?
                  <Table columns={columns} dataSource={rules} rowKey="key" style={{ background: 'transparent' }} /> :
                  <Empty description="尚無任何告警規則">
                    <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>立即新增規則</Button>
                  </Empty>
              }
            </div>
          </div>

          <Modal
            title={editingRule ? '編輯告警規則' : '新增告警規則'}
            open={isModalOpen}
            onCancel={handleCancel}
            width={900}
            footer={[
              <Button key="back" onClick={handleCancel}>取消</Button>,
              <Button key="submit" type="primary" className="btn btn--primary" onClick={() => form.submit()}>儲存</Button>
            ]}
          >
            <Form form={form} layout="vertical" onFinish={onFinish} onValuesChange={handleFormChange} style={{ marginTop: 24 }}>
              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>快速套用範本</Title>
              </div>
              <div style={{ padding: '20px', background: 'rgba(255, 255, 255, 0.02)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: '8px', marginBottom: '32px' }}>
                <Space wrap size={[12, 8]}>
                  {[
                    { key: 'cpu_multi_level', label: 'CPU 多等級告警', icon: '🎯' },
                    { key: 'cpu_high', label: 'CPU 使用率過高', icon: '🖥️' },
                    { key: 'memory_high', label: '記憶體使用率過高', icon: '🧠' },
                    { key: 'disk_space_low', label: '磁碟空間不足', icon: '💾' },
                    { key: 'database_lag', label: '資料庫延遲', icon: '🗄️' },
                    { key: 'api_latency', label: 'API 延遲過高', icon: '⚡' }
                  ].map(template => (
                    <Button
                      key={template.key}
                      size="small"
                      className="btn btn--neutral btn--sm"
                      onClick={() => applyAlertTemplate(template.key)}
                    >
                      {template.icon} {template.label}
                    </Button>
                  ))}
                </Space>
              </div>

              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #52c41a 0%, #73d13d 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>基本資訊</Title>
              </div>
              <div style={{ padding: '20px', background: 'rgba(255, 255, 255, 0.02)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: '8px', marginBottom: '32px' }}>
                <Form.Item name="name" label="規則名稱" rules={[{ required: true }]}>
                  <Input placeholder="例如：Web 伺服器 CPU 使用率告警" />
                </Form.Item>
                <Form.Item name="description" label="描述">
                  <TextArea rows={2} placeholder="當 CPU 使用率超過 80% 時觸發告警，並自動擴展實例" />
                </Form.Item>
              </div>

              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #fa8c16 0%, #faad14 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>觸發條件</Title>
              </div>
              <Form.List name="condition_groups">
                {(fields, { add, remove }) => (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                    {fields.map(({ key, name, ...restField }) => (
                      <div key={key} style={{ padding: '16px', background: 'rgba(255, 255, 255, 0.03)', border: '1px solid rgba(255, 255, 255, 0.1)', borderRadius: '8px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                          <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <span style={{ color: 'rgba(255, 255, 255, 0.7)', fontSize: '12px', background: 'rgba(255, 255, 255, 0.1)', padding: '2px 8px', borderRadius: '4px' }}>
                              任一 (OR)
                            </span>
                            <span style={{ color: 'rgba(255, 255, 255, 0.85)', fontWeight: '500' }}>
                              條件群組 {name + 1}
                            </span>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                              <span style={{ color: 'rgba(255, 255, 255, 0.8)', fontSize: '13px', fontWeight: '400' }}>告警等級:</span>
                              <Form.Item
                                noStyle
                                shouldUpdate={(prevValues, currentValues) => {
                                  const prevSeverity = prevValues.condition_groups?.[name]?.severity;
                                  const currentSeverity = currentValues.condition_groups?.[name]?.severity;
                                  return prevSeverity !== currentSeverity;
                                }}
                              >
                                {({ getFieldValue }) => {
                                  const severity = getFieldValue(['condition_groups', name, 'severity']) || 'warning';

                                  return (
                                    <div style={{ display: 'flex', gap: '6px' }}>
                                      {[
                                        { value: 'info', label: 'INFO', color: 'blue' },
                                        { value: 'warning', label: 'WARNING', color: 'orange' },
                                        { value: 'critical', label: 'CRITICAL', color: 'red' }
                                      ].map(option => (
                                        <Tag
                                          key={option.value}
                                          color={severity === option.value ? option.color : 'default'}
                                          style={{
                                            cursor: 'pointer',
                                            opacity: severity === option.value ? 1 : 0.6,
                                            border: severity === option.value ? `1px solid ${option.color}` : '1px solid rgba(255, 255, 255, 0.3)',
                                            transition: 'all 0.2s'
                                          }}
                                          onClick={() => {
                                            const currentGroups = form.getFieldValue('condition_groups') || [];
                                            const newGroups = [...currentGroups];
                                            if (newGroups[name]) {
                                              newGroups[name] = { ...newGroups[name], severity: option.value };
                                            } else {
                                              newGroups[name] = { severity: option.value };
                                            }
                                            form.setFieldsValue({ condition_groups: newGroups });
                                          }}
                                        >
                                          {option.label}
                                        </Tag>
                                      ))}
                                    </div>
                                  );
                                }}
                              </Form.Item>
                              <Form.Item name={[name, 'severity']} initialValue="warning" style={{ display: 'none' }}>
                                <Input />
                              </Form.Item>
                            </div>
                          </div>
                          {fields.length > 1 && (
                            <Button type="text" danger icon={<MinusCircleOutlined />} onClick={() => remove(name)} size="small" />
                          )}
                        </div>
                        <Form.List name={[name, 'conditions']}>
                          {(subFields, { add: subAdd, remove: subRemove }) => (
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                              {subFields.map((subField) => (
                                <div key={subField.key} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px' }}>
                                  <Form.Item {...subField} name={[subField.name, 'metric']} rules={[{ required: true }]} style={{ margin: 0, flex: 1 }}>
                                    <Select style={{ width: '100%' }} options={mockMetrics.map(m => ({ label: m.name, value: m.id }))} placeholder="指標選擇" />
                                  </Form.Item>
                                  <Form.Item {...subField} name={[subField.name, 'operator']} initialValue=">" rules={[{ required: true }]} style={{ margin: 0 }}>
                                    <Select style={{ width: '60px' }}>
                                      <Select.Option value=">">&gt;</Select.Option>
                                      <Select.Option value="<">&lt;</Select.Option>
                                      <Select.Option value="=">=</Select.Option>
                                    </Select>
                                  </Form.Item>
                                  <Form.Item {...subField} name={[subField.name, 'value']} rules={[{ required: true }]} style={{ margin: 0 }}>
                                    <InputNumber placeholder="閾值" style={{ width: '80px' }} />
                                  </Form.Item>
                                  <span style={{ color: 'rgba(255, 255, 255, 0.6)', fontSize: '12px' }}>在</span>
                                  <Form.Item {...subField} name={[subField.name, 'duration']} initialValue="5" rules={[{ required: true }]} style={{ margin: 0 }}>
                                    <InputNumber placeholder="持續時間" style={{ width: '80px' }} />
                                  </Form.Item>
                                  <Form.Item {...subField} name={[subField.name, 'duration_unit']} initialValue="minutes" rules={[{ required: true }]} style={{ margin: 0 }}>
                                    <Select style={{ width: '80px' }}>
                                      <Select.Option value="seconds">秒</Select.Option>
                                      <Select.Option value="minutes">分鐘</Select.Option>
                                      <Select.Option value="hours">小時</Select.Option>
                                    </Select>
                                  </Form.Item>
                                  {subFields.length > 1 && (
                                    <Button type="text" danger icon={<DeleteOutlined />} onClick={() => subRemove(subField.name)} size="small" />
                                  )}
                                </div>
                              ))}
                              {subFields.length > 1 && (
                                <div style={{ textAlign: 'center', margin: '8px 0' }}>
                                  <span style={{ color: 'rgba(255, 255, 255, 0.6)', fontSize: '12px', background: 'rgba(255, 255, 255, 0.1)', padding: '2px 8px', borderRadius: '4px' }}>
                                    且滿足所有條件 (AND)
                                  </span>
                                </div>
                              )}
                              <Button
                                type="dashed"
                                onClick={() => subAdd({ duration: 5, duration_unit: 'minutes' })}
                                icon={<PlusOutlined />}
                                style={{ borderColor: 'rgba(255, 255, 255, 0.3)' }}
                              >
                                + 新增 AND 條件
                              </Button>
                            </div>
                          )}
                        </Form.List>
                      </div>
                    ))}
                    <Button
                      type="dashed"
                      onClick={() => add({ severity: 'warning', conditions: [{ duration: 5, duration_unit: 'minutes' }] })}
                      icon={<PlusOutlined />}
                      size="large"
                      style={{ height: '48px', borderColor: 'rgba(255, 255, 255, 0.3)', fontWeight: '500' }}
                    >
                      + 新增 OR 條件群組
                    </Button>
                  </div>
                )}
              </Form.List>

              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px', marginTop: '32px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #722ed1 0%, #9254de 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>事件內容與通知</Title>
              </div>
              <div style={{ padding: '20px', background: 'rgba(255, 255, 255, 0.02)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: '8px', marginBottom: '32px' }}>
                <Form.Item name="title_template" label="事件標題樣板" rules={[{ required: true }]} initialValue="🚨 {{resource.name}} - {{metric.name}} 異常">
                  <Input placeholder="使用變數來自訂事件標題" />
                </Form.Item>
                <Form.Item name="content_template" label="事件內容樣板" rules={[{ required: true }]} initialValue="{{resource.name}} 的 {{metric.name}} 已持續 {{duration}} 分鐘超過閾值 {{threshold}}，目前數值為 {{metric.value}}。請立即關注！">
                  <TextArea rows={3} placeholder="使用變數來自訂事件內容" />
                </Form.Item>
                <div style={{ marginBottom: '16px' }}>
                  <div style={{ marginBottom: '8px', fontSize: '12px', color: 'rgba(255, 255, 255, 0.7)' }}>
                    可用變數（點擊插入）：
                  </div>
                  <Space wrap size={[8, 4]}>
                    {[
                      { label: '{{resource.name}}', desc: '資源名稱' },
                      { label: '{{resource.type}}', desc: '資源類型' },
                      { label: '{{metric.name}}', desc: '指標名稱' },
                      { label: '{{metric.value}}', desc: '指標數值' },
                      { label: '{{threshold}}', desc: '閾值' },
                      { label: '{{operator}}', desc: '運算子' },
                      { label: '{{duration}}', desc: '持續時間' },
                      { label: '{{duration_unit}}', desc: '持續時間單位' },
                      { label: '{{severity}}', desc: '嚴重程度' },
                      { label: '{{timestamp}}', desc: '觸發時間' }
                    ].map(variable => (
                      <Tooltip key={variable.label} title={variable.desc}>
                        <Tag
                          style={{
                            cursor: 'pointer',
                            background: 'rgba(24, 144, 255, 0.1)',
                            borderColor: 'rgba(24, 144, 255, 0.3)',
                            color: 'rgba(24, 144, 255, 0.9)',
                            transition: 'all 0.2s'
                          }}
                          onClick={(e) => {
                            // 判斷點擊的目標是標題還是內容輸入框
                            const titleInput = document.querySelector('input[placeholder="使用變數來自訂事件標題"]');
                            const contentTextarea = document.querySelector('textarea[placeholder="使用變數來自訂事件內容"]');

                            let targetInput = null;
                            if (e.target.closest('.ant-form-item').querySelector('input[placeholder="使用變數來自訂事件標題"]')) {
                              targetInput = titleInput;
                            } else if (e.target.closest('.ant-form-item').querySelector('textarea[placeholder="使用變數來自訂事件內容"]')) {
                              targetInput = contentTextarea;
                            } else {
                              // 如果無法確定目標，預設插入到標題
                              targetInput = titleInput;
                            }

                            if (targetInput) {
                              const start = targetInput.selectionStart || 0;
                              const end = targetInput.selectionEnd || 0;
                              const value = targetInput.value;
                              const newValue = value.substring(0, start) + variable.label + value.substring(end);

                              if (targetInput === titleInput) {
                                form.setFieldsValue({ title_template: newValue });
                              } else {
                                form.setFieldsValue({ content_template: newValue });
                              }

                              setTimeout(() => {
                                targetInput.focus();
                                targetInput.setSelectionRange(start + variable.label.length, start + variable.label.length);
                              }, 0);
                            }
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.background = 'rgba(24, 144, 255, 0.15)';
                            e.target.style.transform = 'scale(1.05)';
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.background = 'rgba(24, 144, 255, 0.1)';
                            e.target.style.transform = 'scale(1)';
                          }}
                        >
                          {variable.label}
                        </Tag>
                      </Tooltip>
                    ))}
                  </Space>
                </div>
              </div>

              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #13c2c2 0%, #36cfc9 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>自動化響應</Title>
              </div>
              <div style={{ padding: '20px', background: 'rgba(255, 255, 255, 0.02)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: '8px', marginBottom: '24px' }}>
                <Form.Item name="automation_enabled" valuePropName="checked">
                  <Checkbox>啟用自動化響應</Checkbox>
                </Form.Item>
                <Form.Item
                  noStyle
                  shouldUpdate={(prevValues, currentValues) => prevValues.automation_enabled !== currentValues.automation_enabled}
                >
                  {({ getFieldValue }) =>
                    getFieldValue('automation_enabled') ? (
                      <Form.Item name="automation_script" label="選擇腳本" rules={[{ required: true, message: '請選擇自動化腳本' }]}>
                        <Select allowClear placeholder="選擇自動化腳本" options={mockScripts.map(s => ({ label: s.name, value: s.id }))} />
                      </Form.Item>
                    ) : null
                  }
                </Form.Item>
                <Form.Item
                  noStyle
                  shouldUpdate={(prevValues, currentValues) =>
                    prevValues.automation_enabled !== currentValues.automation_enabled ||
                    prevValues.automation_script !== currentValues.automation_script
                  }
                >
                  {({ getFieldValue }) => {
                    const automationEnabled = getFieldValue('automation_enabled');
                    const selectedScriptId = getFieldValue('automation_script');
                    const currentSelectedScript = mockScripts.find(s => s.id === selectedScriptId);

                    return automationEnabled && currentSelectedScript && currentSelectedScript.params ? (
                      <div className="script-params-container" style={{ marginTop: '16px', padding: '16px', background: 'rgba(255, 255, 255, 0.03)', border: '1px solid rgba(255, 255, 255, 0.1)', borderRadius: '8px' }}>
                        <div className="script-params-header" style={{ marginBottom: '12px' }}>
                          <Title level={5} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>腳本參數</Title>
                        </div>
                        <div className="script-params-content">
                          {currentSelectedScript.params.map(p => (
                            <Form.Item key={p.name} name={['automation_params', p.name]} label={p.label} rules={[{ required: true }]}>
                              {p.type === 'number' ? <InputNumber style={{ width: '100%' }} /> : <Input />}
                            </Form.Item>
                          ))}
                        </div>
                      </div>
                    ) : null;
                  }}
                </Form.Item>
              </div>
            </Form>
          </Modal>
        </React.Fragment>
      );
    };

    const NotificationStrategiesPage = () => {
      const [strategies, setStrategies] = useLocalStorageState('sre-notification-strategies', []);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingStrategy, setEditingStrategy] = useState(null);
      const [currentStep, setCurrentStep] = useState(1);
      const [selectedResourceGroup, setSelectedResourceGroup] = useState(null);
      const [selectedTeam, setSelectedTeam] = useState(null);
      const [selectedChannels, setSelectedChannels] = useState([]);
      const [matchConditions, setMatchConditions] = useState([]);
      const [strategyName, setStrategyName] = useState('');
      const [manualTeamSelection, setManualTeamSelection] = useState(false);
      const { message, modal } = antd.App.useApp();

      // 模擬數據
      const mockResourceGroups = [
        { key: 'rg_prod_db', name: 'Production-Database', description: '生產環境資料庫資源' },
        { key: 'rg_prod_web', name: 'Production-Web', description: '生產環境Web服務資源' },
        { key: 'rg_staging', name: 'Staging', description: '測試環境資源' },
        { key: 'rg_monitoring', name: 'Monitoring', description: '監控系統資源' }
      ];

      const mockTeams = [
        { key: 't_1', name: 'Developers', description: '負責開發與維護的核心團隊' },
        { key: 't_2', name: 'Viewers', description: '僅有檢視權限的觀察員' },
        { key: 't_3', name: 'Administrators', description: '平台最高權限管理者' },
        { key: 't_4', name: 'QA Team', description: '品質保證與測試團隊' },
        { key: 't_5', name: 'DevOps Team', description: '負責CI/CD和基礎設施自動化的團隊' },
        { key: 't_6', name: 'Database Team', description: '負責資料庫管理與優化的團隊' },
        { key: 't_7', name: 'Network Team', description: '負責網路基礎設施與安全的團隊' },
        { key: 't_8', name: 'Security Team', description: '負責資訊安全與合規的團隊' },
        { key: 't_9', name: 'Operations Team', description: '負責系統運營與監控的團隊' },
        { key: 't_10', name: 'Platform Team', description: '負責平台架構與技術基礎設施的團隊' }
      ];

      const mockChannels = [
        { key: 'c_pagerduty_db', name: 'Database Team PagerDuty', type: 'PagerDuty', team: 't_6' },
        { key: 'c_slack_db', name: 'Database Slack Channel', type: 'Slack', team: 't_6' },
        { key: 'c_pagerduty_ops', name: 'Operations Team PagerDuty', type: 'PagerDuty', team: 't_9' },
        { key: 'c_slack_ops', name: 'Operations Slack Channel', type: 'Slack', team: 't_9' },
        { key: 'c_email_devops', name: 'DevOps Email', type: 'Email', team: 't_5' },
        { key: 'c_pagerduty_network', name: 'Network Team PagerDuty', type: 'PagerDuty', team: 't_7' },
        { key: 'c_slack_network', name: 'Network Slack Channel', type: 'Slack', team: 't_7' },
        { key: 'c_email_security', name: 'Security Email', type: 'Email', team: 't_8' },
        { key: 'c_pagerduty_platform', name: 'Platform Team PagerDuty', type: 'PagerDuty', team: 't_10' },
        { key: 'c_slack_platform', name: 'Platform Slack Channel', type: 'Slack', team: 't_10' }
      ];

      const showModal = (strategy = null) => {
        setEditingStrategy(strategy);
        setCurrentStep(1);
        setSelectedResourceGroup(null);
        setSelectedTeam(null);
        setSelectedChannels([]);
        setMatchConditions([]);
        setStrategyName(strategy ? strategy.name : '');
        setManualTeamSelection(false);
        setIsModalOpen(true);
      };

      const handleCancel = () => {
        setIsModalOpen(false);
        setEditingStrategy(null);
        resetForm();
      };

      const resetForm = () => {
        setCurrentStep(1);
        setSelectedResourceGroup(null);
        setSelectedTeam(null);
        setSelectedChannels([]);
        setMatchConditions([]);
        setStrategyName('');
        setManualTeamSelection(false);
      };

      const handleResourceGroupSelect = (resourceGroupKey) => {
        const resourceGroup = mockResourceGroups.find(rg => rg.key === resourceGroupKey);
        setSelectedResourceGroup(resourceGroup);

        // 根據資源群組自動建議團隊（模擬邏輯）
        if (resourceGroupKey === 'rg_prod_db') {
          setSelectedTeam(mockTeams.find(t => t.key === 't_6'));
          setSelectedChannels(mockChannels.filter(c => c.team === 't_6'));
        } else if (resourceGroupKey === 'rg_prod_web') {
          setSelectedTeam(mockTeams.find(t => t.key === 't_9'));
          setSelectedChannels(mockChannels.filter(c => c.team === 't_9'));
        } else if (resourceGroupKey === 'rg_monitoring') {
          setSelectedTeam(mockTeams.find(t => t.key === 't_9'));
          setSelectedChannels(mockChannels.filter(c => c.team === 't_9'));
        } else {
          setSelectedTeam(mockTeams.find(t => t.key === 't_5'));
          setSelectedChannels(mockChannels.filter(c => c.team === 't_5'));
        }
      };

      const handleTeamSelect = (teamKey) => {
        const team = mockTeams.find(t => t.key === teamKey);
        setSelectedTeam(team);
        setSelectedChannels(mockChannels.filter(c => c.team === teamKey));
      };

      const addMatchCondition = () => {
        setMatchConditions([...matchConditions, { key: '', operator: '=', value: '' }]);
      };

      const updateMatchCondition = (index, field, value) => {
        const newConditions = [...matchConditions];
        newConditions[index] = { ...newConditions[index], [field]: value };
        setMatchConditions(newConditions);
      };

      const removeMatchCondition = (index) => {
        setMatchConditions(matchConditions.filter((_, i) => i !== index));
      };

      const handleCreateStrategy = () => {
        if (!selectedResourceGroup || !selectedTeam || selectedChannels.length === 0) {
          message.error('請完成所有必要設定');
          return;
        }

        const strategy = {
          key: editingStrategy ? editingStrategy.key : `ns_${Date.now()}`,
          name: strategyName || `${selectedResourceGroup.name} 通知策略`,
          resourceGroup: selectedResourceGroup,
          team: selectedTeam,
          channels: selectedChannels,
          matchConditions: matchConditions.filter(cond => cond.key && cond.value),
          createdAt: editingStrategy ? editingStrategy.createdAt : dayjs(),
          enabled: true
        };

        if (editingStrategy) {
          setStrategies(strategies.map(s => s.key === editingStrategy.key ? strategy : s));
          message.success('通知策略更新成功');
        } else {
          setStrategies([...strategies, strategy]);
          message.success('通知策略建立成功');
        }

        handleCancel();
      };

      const handleDelete = (strategy) => {
        modal.confirm({
          title: '確定要刪除此通知策略嗎？',
          content: `將刪除策略 "${strategy.name}"，此操作無法復原。`,
          okText: '確定',
          okType: 'danger',
          cancelText: '取消',
          onOk() {
            setStrategies(strategies.filter(s => s.key !== strategy.key));
            message.success('通知策略刪除成功');
          }
        });
      };

      const columns = [
        { title: '策略名稱', dataIndex: 'name', sorter: (a, b) => a.name.localeCompare(b.name) },
        { title: '資源群組', dataIndex: 'resourceGroup', render: rg => rg?.name, sorter: (a, b) => a.resourceGroup?.name.localeCompare(b.resourceGroup?.name) },
        { title: '負責團隊', dataIndex: 'team', render: team => team?.name, sorter: (a, b) => a.team?.name.localeCompare(b.team?.name) },
        { title: '通知管道數', dataIndex: 'channels', render: channels => channels?.length || 0, sorter: (a, b) => (a.channels?.length || 0) - (b.channels?.length || 0) },
        { title: '狀態', dataIndex: 'enabled', render: enabled => <Tag color={enabled ? 'green' : 'red'}>{enabled ? '啟用' : '停用'}</Tag> },
        {
          title: '操作',
          key: 'action',
          render: (_, record) => (
            <Space>
              <Button type="link" onClick={() => showModal(record)}>編輯</Button>
              <Button type="link" danger onClick={() => handleDelete(record)}>刪除</Button>
            </Space>
          )
        }
      ];

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>通知策略</Title>
            <Button type="primary" icon={<PlusOutlined />} onClick={() => showModal()}>
              新增通知策略
            </Button>
          </div>
          <Paragraph className="page-subtitle" type="secondary">
            設定告警通知的路由策略，將告警自動分派給負責的團隊和通知管道。
          </Paragraph>

          <div className="resource-list-container">
            <div className="table-wrapper">
              {strategies.length > 0 ? (
                <Table
                  columns={columns}
                  dataSource={strategies}
                  rowKey="key"
                  style={{ background: 'transparent' }}
                  pagination={{ pageSize: 10 }}
                />
              ) : (
                <Empty description="尚無任何通知策略">
                  <Button type="primary" icon={<PlusOutlined />} onClick={() => showModal()}>
                    立即新增通知策略
                  </Button>
                </Empty>
              )}
            </div>
          </div>

          {/* 新增/編輯通知策略模態框 */}
          <Modal
            title={editingStrategy ? '編輯通知策略' : '新增通知策略'}
            open={isModalOpen}
            onCancel={handleCancel}
            width={800}
            footer={[
              <Button key="back" onClick={handleCancel}>
                取消
              </Button>,
              <Button
                key="submit"
                type="primary"
                onClick={handleCreateStrategy}
                disabled={!selectedResourceGroup || !selectedTeam || selectedChannels.length === 0}
              >
                {editingStrategy ? '更新策略' : '建立策略'}
              </Button>
            ]}
          >
            <div style={{ padding: '16px 0' }}>
              {/* 步驟指示器 */}
              <div style={{ marginBottom: '24px' }}>
                <Steps current={currentStep - 1} size="small">
                  <Steps.Step title="選擇資源群組" description="決定監控範圍" />
                  <Steps.Step title="設定通知管道" description="選擇負責團隊和管道" />
                  <Steps.Step title="新增匹配條件" description="設定額外過濾條件" />
                </Steps>
              </div>

              {/* 第1步：選擇資源群組 */}
              {currentStep === 1 && (
                <div>
                  <div style={{ marginBottom: '16px' }}>
                    <Text strong style={{ fontSize: '16px', color: 'rgba(255, 255, 255, 0.9)' }}>
                      第一步：選擇您關心的範圍
                    </Text>
                  </div>

                  <Form.Item label="資源群組" rules={[{ required: true, message: '請選擇資源群組' }]}>
                    <Select
                      placeholder="請選擇一個資源群組..."
                      style={{ width: '100%' }}
                      value={selectedResourceGroup?.key}
                      onChange={handleResourceGroupSelect}
                    >
                      {mockResourceGroups.map(rg => (
                        <Select.Option key={rg.key} value={rg.key}>
                          {rg.name} - {rg.description}
                        </Select.Option>
                      ))}
                    </Select>
                  </Form.Item>

                  <Form.Item label="策略名稱">
                    <Input
                      placeholder="自動生成或自訂名稱"
                      value={strategyName}
                      onChange={e => setStrategyName(e.target.value)}
                    />
                  </Form.Item>
                </div>
              )}

              {/* 第2步：設定通知管道 */}
              {currentStep === 2 && selectedResourceGroup && (
                <div>
                  <div style={{ marginBottom: '16px' }}>
                    <Text strong style={{ fontSize: '16px', color: 'rgba(255, 255, 255, 0.9)' }}>
                      第二步：選擇通知管道
                    </Text>
                  </div>

                  {/* 系統建議 */}
                  {selectedTeam && !manualTeamSelection && (
                    <div style={{ marginBottom: '16px', padding: '12px', background: 'rgba(24, 144, 255, 0.1)', borderRadius: '6px', border: '1px solid rgba(24, 144, 255, 0.2)' }}>
                      <Text style={{ color: 'rgba(24, 144, 255, 0.9)' }}>
                        💡 系統建議：此資源群組由 <strong>{selectedTeam.name}</strong> 團隊負責
                      </Text>
                    </div>
                  )}

                  {/* 負責團隊選擇 */}
                  {(!selectedTeam || manualTeamSelection) && (
                    <Form.Item label="負責團隊" rules={[{ required: true, message: '請選擇負責團隊' }]}>
                      <Select
                        placeholder="選擇負責團隊"
                        style={{ width: '100%' }}
                        value={selectedTeam?.key}
                        onChange={handleTeamSelect}
                      >
                        {mockTeams.map(team => (
                          <Select.Option key={team.key} value={team.key}>
                            {team.name} - {team.description}
                          </Select.Option>
                        ))}
                      </Select>
                    </Form.Item>
                  )}

                  {/* 通知管道選擇 */}
                  {selectedTeam && (
                    <Form.Item label="通知管道" rules={[{ required: true, message: '請選擇至少一個通知管道' }]}>
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        {mockChannels
                          .filter(channel => channel.team === selectedTeam.key)
                          .map(channel => (
                            <div key={channel.key} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                              <Checkbox
                                checked={selectedChannels.some(c => c.key === channel.key)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setSelectedChannels([...selectedChannels, channel]);
                                  } else {
                                    setSelectedChannels(selectedChannels.filter(c => c.key !== channel.key));
                                  }
                                }}
                              />
                              <Tag color={
                                channel.type === 'PagerDuty' ? 'red' :
                                  channel.type === 'Slack' ? 'blue' : 'green'
                              }>
                                {channel.type}
                              </Tag>
                              <Text style={{ color: 'rgba(255, 255, 255, 0.8)' }}>
                                {channel.name}
                              </Text>
                            </div>
                          ))}
                      </div>
                    </Form.Item>
                  )}

                  {/* 手動選擇其他團隊的連結 */}
                  {!manualTeamSelection && (
                    <div style={{ marginTop: '12px' }}>
                      <Button
                        type="link"
                        size="small"
                        onClick={() => setManualTeamSelection(true)}
                        style={{ padding: 0, fontSize: '12px' }}
                      >
                        手動選擇其他團隊?
                      </Button>
                    </div>
                  )}
                </div>
              )}

              {/* 第3步：新增匹配條件 */}
              {currentStep === 3 && (
                <div>
                  <div style={{ marginBottom: '16px' }}>
                    <Text strong style={{ fontSize: '16px', color: 'rgba(255, 255, 255, 0.9)' }}>
                      第三步：新增更多匹配條件 (可選)
                    </Text>
                    <br />
                    <Text style={{ fontSize: '12px', color: 'rgba(255, 255, 255, 0.6)' }}>
                      除了資源群組外，還可以設定額外的標籤匹配條件
                    </Text>
                  </div>

                  <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                    {matchConditions.map((condition, index) => (
                      <div key={index} style={{ display: 'flex', alignItems: 'center', gap: '8px', padding: '8px', background: 'rgba(0,0,0,0.2)', borderRadius: '6px' }}>
                        <Text style={{ color: 'rgba(255, 255, 255, 0.7)', fontSize: '12px', minWidth: '60px' }}>
                          且 (AND)
                        </Text>
                        <Select
                          placeholder="選擇標籤"
                          style={{ width: '120px', flexShrink: 0 }}
                          value={condition.key}
                          onChange={value => updateMatchCondition(index, 'key', value)}
                        >
                          <Select.Option value="severity">severity</Select.Option>
                          <Select.Option value="alert_name">alert_name</Select.Option>
                          <Select.Option value="instance">instance</Select.Option>
                          <Select.Option value="service">service</Select.Option>
                        </Select>
                        <Select
                          style={{ width: '80px', flexShrink: 0 }}
                          value={condition.operator}
                          onChange={value => updateMatchCondition(index, 'operator', value)}
                        >
                          <Select.Option value="=">=</Select.Option>
                          <Select.Option value="!=">!=</Select.Option>
                          <Select.Option value="~">~</Select.Option>
                          <Select.Option value="!~">!~</Select.Option>
                        </Select>
                        <Input
                          placeholder="匹配值"
                          style={{ flex: 1 }}
                          value={condition.value}
                          onChange={e => updateMatchCondition(index, 'value', e.target.value)}
                        />
                        <Button
                          type="text"
                          danger
                          icon={<DeleteOutlined />}
                          onClick={() => removeMatchCondition(index)}
                        />
                      </div>
                    ))}

                    <Button
                      type="dashed"
                      onClick={addMatchCondition}
                      icon={<PlusOutlined />}
                      style={{ borderColor: 'rgba(255, 255, 255, 0.3)' }}
                    >
                      新增匹配條件
                    </Button>
                  </div>
                </div>
              )}

              {/* 步驟導航 */}
              <div style={{ marginTop: '24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                <div>
                  {currentStep > 1 && (
                    <Button onClick={() => setCurrentStep(currentStep - 1)}>
                      上一步
                    </Button>
                  )}
                </div>
                <div>
                  {currentStep < 3 && (
                    <Button
                      type="primary"
                      onClick={() => {
                        if (currentStep === 1 && !selectedResourceGroup) {
                          message.warning('請先選擇資源群組');
                          return;
                        }
                        if (currentStep === 2 && (!selectedTeam || selectedChannels.length === 0)) {
                          message.warning('請選擇負責團隊和通知管道');
                          return;
                        }
                        setCurrentStep(currentStep + 1);
                      }}
                    >
                      下一步
                    </Button>
                  )}
                </div>
              </div>
            </div>
          </Modal>
        </React.Fragment>
      );
    };

    const SilencesPage = () => {
      const initialSilences = [
        {
          key: 's_1',
          name: '週末例行維護',
          description: '資料庫例行維護，預期會有短暫連線中斷',
          type: 'recurring',
          recurringPattern: 'weekly',
          weekdays: [6, 0], // 週六日
          timeSlot: ['02:00', '04:00'],
          validUntil: dayjs().add(6, 'month'),
          creator: 'admin',
          matchers: [{ key: 'resource_group', op: '=', value: 'Production Database' }],
          enabled: true
        },
        {
          key: 's_2',
          name: '月底批次作業',
          description: '財務結算期間高負載',
          type: 'recurring',
          recurringPattern: 'monthly',
          monthlyType: 'lastday',
          timeSlot: ['22:00', '06:00'],
          validUntil: null,
          creator: 'admin',
          matchers: [{ key: 'alert_name', op: '=', value: 'CPU high' }],
          enabled: true
        },
        {
          key: 's_3',
          name: '緊急維護視窗',
          description: '緊急修復作業',
          type: 'once',
          timeRange: [dayjs().add(1, 'day'), dayjs().add(1, 'day').add(4, 'hour')],
          creator: 'ops_user',
          matchers: [{ key: 'resource_name', op: '=', value: 'api-gateway' }],
          enabled: true
        },
      ];

      const [silences, setSilences] = useLocalStorageState('sre-silences-v2', initialSilences);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingSilence, setEditingSilence] = useState(null);
      const [silenceType, setSilenceType] = useState('once');
      const [recurringPattern, setRecurringPattern] = useState('weekly');
      const [monthlyType, setMonthlyType] = useState('date');
      const [validityType, setValidityType] = useState('forever');
      const [form] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      // 快速範本
      const quickTemplates = [
        {
          name: '週末維護窗口',
          template: {
            type: 'recurring',
            recurringPattern: 'weekly',
            weekdays: [6, 0],
            timeSlot: ['02:00', '04:00'],
            validityType: 'until',
            validUntil: dayjs().add(6, 'month')
          }
        },
        {
          name: '月底批次作業',
          template: {
            type: 'recurring',
            recurringPattern: 'monthly',
            monthlyType: 'lastday',
            timeSlot: ['22:00', '06:00'],
            validityType: 'forever'
          }
        },
        {
          name: '每日深夜維護',
          template: {
            type: 'recurring',
            recurringPattern: 'daily',
            timeSlot: ['01:00', '03:00'],
            validityType: 'forever'
          }
        }
      ];

      const applyTemplate = (templateData) => {
        setSilenceType(templateData.type);
        setRecurringPattern(templateData.recurringPattern || 'weekly');
        setMonthlyType(templateData.monthlyType || 'date');
        setValidityType(templateData.validityType || 'forever');
        form.setFieldsValue(templateData);
      };

      const getStatus = (record) => {
        if (!record.enabled) return { color: 'gray', text: '已停用' };

        if (record.type === 'once') {
          const now = dayjs();
          const start = record.timeRange[0];
          const end = record.timeRange[1];
          if (now.isBefore(start)) return { color: 'blue', text: '待生效' };
          if (now.isAfter(end)) return { color: 'gray', text: '已過期' };
          return { color: 'green', text: '生效中' };
        } else {
          // 週期性靜音狀態判斷
          if (record.validUntil && dayjs().isAfter(record.validUntil)) {
            return { color: 'gray', text: '已過期' };
          }
          return { color: 'green', text: '週期生效' };
        }
      };

      const getNextExecution = (record) => {
        if (record.type === 'once') return null;

        // 簡化的下次執行時間計算
        if (record.recurringPattern === 'weekly' && record.weekdays) {
          const nextSaturday = dayjs().day(6).hour(parseInt(record.timeSlot[0])).minute(0);
          return nextSaturday.isAfter(dayjs()) ? nextSaturday : nextSaturday.add(1, 'week');
        }
        return dayjs().add(1, 'day').hour(parseInt(record.timeSlot?.[0] || '02')).minute(0);
      };

      const showModal = (silence = null) => {
        setEditingSilence(silence);
        if (silence) {
          setSilenceType(silence.type || 'once');
          setRecurringPattern(silence.recurringPattern || 'weekly');
          setMonthlyType(silence.monthlyType || 'date');
          setValidityType(silence.validUntil ? 'until' : 'forever');
          form.setFieldsValue(silence);
        } else {
          setSilenceType('once');
          setRecurringPattern('weekly');
          setMonthlyType('date');
          setValidityType('forever');
          form.setFieldsValue({ matchers: [{}], enabled: true });
        }
        setIsModalOpen(true);
      };

      const handleCancel = () => {
        setIsModalOpen(false);
        setEditingSilence(null);
        form.resetFields();
      };

      const onFinish = (values) => {
        const newSilence = {
          ...values,
          key: editingSilence ? editingSilence.key : `s_${Date.now()}`,
          creator: editingSilence ? editingSilence.creator : 'admin',
          type: silenceType,
          recurringPattern: silenceType === 'recurring' ? recurringPattern : null,
          monthlyType: recurringPattern === 'monthly' ? monthlyType : null
        };

        if (editingSilence) {
          setSilences(silences.map(s => s.key === editingSilence.key ? newSilence : s));
          message.success('靜音規則更新成功');
        } else {
          setSilences([newSilence, ...silences]);
          message.success('靜音規則新增成功');
        }
        handleCancel();
      };

      const handleDelete = (key) => {
        modal.confirm({
          title: '確定要刪除此靜音規則嗎？',
          icon: <ExclamationCircleOutlined />,
          onOk: () => {
            setSilences(silences.filter(s => s.key !== key));
            message.success('靜音規則已刪除');
          }
        });
      };

      const toggleEnabled = (key) => {
        setSilences(silences.map(s =>
          s.key === key ? { ...s, enabled: !s.enabled } : s
        ));
        message.success('靜音規則狀態已更新');
      };

      const columns = [
        { title: '名稱', dataIndex: 'name', width: '18%' },
        {
          title: '狀態',
          key: 'status',
          width: '10%',
          render: (_, record) => {
            const status = getStatus(record);
            return <Tag color={status.color}>{status.text}</Tag>;
          }
        },
        {
          title: '類型',
          dataIndex: 'type',
          width: '8%',
          render: (type) => (
            <Tag color={type === 'once' ? 'blue' : 'green'}>
              {type === 'once' ? '單次' : '週期'}
            </Tag>
          )
        },
        {
          title: '排程',
          key: 'schedule',
          width: '22%',
          render: (_, record) => {
            if (record.type === 'once') {
              return record.timeRange?.[0]?.format('MM-DD HH:mm') + ' - ' + record.timeRange?.[1]?.format('MM-DD HH:mm');
            } else if (record.recurringPattern === 'weekly') {
              const days = record.weekdays?.map(d => ['日', '一', '二', '三', '四', '五', '六'][d]).join(',') || '';
              return `每週${days} ${record.timeSlot?.[0]}-${record.timeSlot?.[1]}`;
            } else if (record.recurringPattern === 'monthly') {
              return `每月${record.monthlyType === 'lastday' ? '最後一天' : '特定日期'} ${record.timeSlot?.[0]}-${record.timeSlot?.[1]}`;
            }
            return '-';
          }
        },
        {
          title: '下次執行',
          key: 'nextExecution',
          width: '12%',
          render: (_, record) => {
            const next = getNextExecution(record);
            return next ? next.format('MM-DD HH:mm') : '-';
          }
        },
        {
          title: '匹配條件',
          dataIndex: 'matchers',
          width: '15%',
          render: (matchers) => (
            <div>
              {(matchers && matchers.length > 0) ?
                matchers.slice(0, 2).map((m, i) => (
                  <Tag key={i} size="small">{`${m.key}=${m.value}`}</Tag>
                )) :
                <Text type="secondary">無</Text>
              }
              {matchers && matchers.length > 2 && <Text type="secondary">...</Text>}
            </div>
          )
        },
        { title: '創建者', dataIndex: 'creator', width: '8%' },
        {
          title: '操作',
          key: 'action',
          width: '12%',
          render: (_, record) => (
            <Space size="small">
              <Button
                type="link"
                size="small"
                onClick={() => toggleEnabled(record.key)}
                style={{ color: record.enabled ? '#faad14' : '#52c41a' }}
              >
                {record.enabled ? '停用' : '啟用'}
              </Button>
              <Button type="link" size="small" onClick={() => showModal(record)}>編輯</Button>
              <Button type="link" size="small" danger onClick={() => handleDelete(record.key)}>刪除</Button>
            </Space>
          )
        }
      ];

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>靜音規則</Title>
            <Space>
              <Input.Search placeholder="搜尋規則" style={{ width: 300 }} />
              <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>新增靜音規則</Button>
            </Space>
          </div>
          <Paragraph className="page-subtitle" type="secondary">支援單次與週期性靜音，在計畫性維護或已知問題期間自動抑制相關事件通知。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              {
                silences.length > 0 ?
                  <Table
                    columns={columns}
                    dataSource={silences}
                    rowKey="key"
                    style={{ background: 'transparent' }}
                    pagination={{ pageSize: 10 }}
                    size="middle"
                  /> :
                  <Empty description="尚無任何靜音規則">
                    <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>立即新增靜音規則</Button>
                  </Empty>
              }
            </div>
          </div>

          <Modal
            title={editingSilence ? '編輯靜音規則' : '新增靜音規則'}
            open={isModalOpen}
            onCancel={handleCancel}
            footer={[
              <Button key="cancel" onClick={handleCancel}>取消</Button>,
              <Button key="submit" type="primary" className="btn btn--primary" onClick={() => form.submit()}>儲存</Button>
            ]}
            width={720}
          >
            <Form form={form} layout="vertical" onFinish={onFinish} style={{ marginTop: 24 }}>
              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>快速套用範本</Title>
              </div>
              <div style={{ padding: '20px', background: 'rgba(255, 255, 255, 0.02)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: '8px', marginBottom: '32px' }}>
                <Space wrap size={[12, 8]}>
                  {quickTemplates.map((template, index) => (
                    <Button
                      key={index}
                      size="small"
                      className="btn btn--neutral btn--sm"
                      onClick={() => applyTemplate(template.template)}
                    >
                      {template.name}
                    </Button>
                  ))}
                </Space>
              </div>

              {/* 基本資訊 */}
              <Form.Item name="name" label="名稱" rules={[{ required: true }]}>
                <Input placeholder="例如：週末例行維護" />
              </Form.Item>

              <Form.Item name="description" label="描述">
                <TextArea rows={2} placeholder="資料庫例行維護，預期會有短暫連線中斷" />
              </Form.Item>

              {/* 靜音類型 */}
              <Form.Item label="靜音類型" required>
                <Radio.Group value={silenceType} onChange={e => setSilenceType(e.target.value)}>
                  <Radio value="once">單次靜音</Radio>
                  <Radio value="recurring">週期性靜音</Radio>
                </Radio.Group>
              </Form.Item>

              {/* 單次靜音設定 */}
              {silenceType === 'once' && (
                <Form.Item name="timeRange" label="時間範圍" rules={[{ required: true }]}>
                  <RangePicker
                    showTime
                    format="YYYY-MM-DD HH:mm"
                    style={{ width: '100%' }}
                    placeholder={['開始時間', '結束時間']}
                  />
                </Form.Item>
              )}

              {/* 週期性靜音設定 */}
              {silenceType === 'recurring' && (
                <>
                  <Form.Item label="重複模式" required>
                    <Select
                      value={recurringPattern}
                      onChange={setRecurringPattern}
                      placeholder="選擇重複模式"
                    >
                      <Select.Option value="daily">每日</Select.Option>
                      <Select.Option value="weekly">每週</Select.Option>
                      <Select.Option value="monthly">每月</Select.Option>
                      <Select.Option value="custom">自訂 Cron</Select.Option>
                    </Select>
                  </Form.Item>

                  {/* 每週設定 */}
                  {recurringPattern === 'weekly' && (
                    <Form.Item name="weekdays" label="選擇星期">
                      <Checkbox.Group>
                        <Checkbox value={1}>週一</Checkbox>
                        <Checkbox value={2}>週二</Checkbox>
                        <Checkbox value={3}>週三</Checkbox>
                        <Checkbox value={4}>週四</Checkbox>
                        <Checkbox value={5}>週五</Checkbox>
                        <Checkbox value={6}>週六</Checkbox>
                        <Checkbox value={0}>週日</Checkbox>
                      </Checkbox.Group>
                    </Form.Item>
                  )}

                  {/* 每月設定 */}
                  {recurringPattern === 'monthly' && (
                    <Form.Item label="執行日期">
                      <Radio.Group value={monthlyType} onChange={e => setMonthlyType(e.target.value)}>
                        <Radio value="date">每月特定日期</Radio>
                        <Radio value="weekday">每月特定星期</Radio>
                        <Radio value="lastday">每月最後一天</Radio>
                      </Radio.Group>

                      {monthlyType === 'date' && (
                        <Form.Item name="monthlyDates" style={{ marginTop: 8 }}>
                          <Select mode="multiple" placeholder="選擇日期">
                            {[...Array(31)].map((_, i) => (
                              <Select.Option key={i + 1} value={i + 1}>{i + 1}日</Select.Option>
                            ))}
                          </Select>
                        </Form.Item>
                      )}
                    </Form.Item>
                  )}

                  {/* 自訂 Cron */}
                  {recurringPattern === 'custom' && (
                    <Form.Item
                      name="cronExpression"
                      label="Cron 表達式"
                      extra="例如: 0 2 * * 6,0 (每週六日凌晨2點)"
                    >
                      <Input placeholder="輸入 Cron 表達式" />
                    </Form.Item>
                  )}

                  {/* 時段設定 */}
                  <Row gutter={16}>
                    <Col span={12}>
                      <Form.Item name="timeSlot" label="靜音時段" rules={[{ required: true }]}>
                        <Input placeholder="例如: ['02:00', '04:00']" />
                      </Form.Item>
                    </Col>
                    <Col span={12}>
                      <Form.Item name="duration" label="持續時間">
                        <InputNumber
                          addonAfter="小時"
                          min={0.5}
                          max={24}
                          step={0.5}
                          style={{ width: '100%' }}
                        />
                      </Form.Item>
                    </Col>
                  </Row>

                  {/* 有效期限 */}
                  <Form.Item label="有效期限">
                    <Radio.Group value={validityType} onChange={e => setValidityType(e.target.value)}>
                      <Radio value="forever">永久有效</Radio>
                      <Radio value="until">截止到特定日期</Radio>
                      <Radio value="count">執行特定次數</Radio>
                    </Radio.Group>

                    {validityType === 'until' && (
                      <Form.Item name="validUntil" style={{ marginTop: 8 }}>
                        <DatePicker placeholder="選擇截止日期" style={{ width: '100%' }} />
                      </Form.Item>
                    )}

                    {validityType === 'count' && (
                      <Form.Item name="executionCount" style={{ marginTop: 8 }}>
                        <InputNumber min={1} max={100} addonAfter="次" style={{ width: '100%' }} />
                      </Form.Item>
                    )}
                  </Form.Item>
                </>
              )}

              {/* 匹配條件 */}
              <Form.Item label="靜音目標" required>
                <Tabs size="small">
                  <Tabs.TabPane tab="匹配條件" key="matchers">
                    <Form.List name="matchers">
                      {(fields, { add, remove }) => (
                        <React.Fragment>
                          {fields.map(({ key, name, ...restField }) => (
                            <Space key={key} style={{ display: 'flex', marginBottom: 8 }} align="baseline">
                              <Form.Item {...restField} name={[name, 'key']} rules={[{ required: true }]}>
                                <Select style={{ width: 150 }} placeholder="標籤">
                                  <Select.Option value="resource_name">資源名稱</Select.Option>
                                  <Select.Option value="resource_group">資源群組</Select.Option>
                                  <Select.Option value="alert_name">告警名稱</Select.Option>
                                  <Select.Option value="severity">嚴重性</Select.Option>
                                  <Select.Option value="environment">環境</Select.Option>
                                </Select>
                              </Form.Item>
                              <Form.Item {...restField} name={[name, 'op']} rules={[{ required: true }]} initialValue="=">
                                <Select style={{ width: 70 }}>
                                  <Select.Option value="=">=</Select.Option>
                                  <Select.Option value="!=">!=</Select.Option>
                                  <Select.Option value="=~">~=</Select.Option>
                                </Select>
                              </Form.Item>
                              <Form.Item {...restField} name={[name, 'value']} rules={[{ required: true }]}>
                                <Input placeholder="標籤值" style={{ width: 150 }} />
                              </Form.Item>
                              <MinusCircleOutlined onClick={() => remove(name)} />
                            </Space>
                          ))}
                          <Form.Item>
                            <Button type="dashed" onClick={() => add()} block icon={<PlusOutlined />}>
                              新增匹配條件
                            </Button>
                          </Form.Item>
                        </React.Fragment>
                      )}
                    </Form.List>
                  </Tabs.TabPane>
                </Tabs>
              </Form.Item>

              {/* 其他設定 */}
              <Form.Item name="enabled" valuePropName="checked" initialValue={true}>
                <Checkbox>立即啟用此靜音規則</Checkbox>
              </Form.Item>

              <Form.Item name="notifyOnChange" valuePropName="checked">
                <Checkbox>靜音開始/結束時發送通知</Checkbox>
              </Form.Item>
            </Form>
          </Modal>
        </React.Fragment>
      );
    };

    const ScriptsPage = ({ scripts, setScripts, addExecution }) => {
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingScript, setEditingScript] = useState(null);
      const [form] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      const showModal = (script = null) => {
        setEditingScript(script);
        form.setFieldsValue(script || { name: '', type: 'Python', description: '', code: '' });
        setIsModalOpen(true);
      };
      const handleCancel = () => setIsModalOpen(false);
      const onFinish = (values) => {
        message.success(editingScript ? '腳本更新成功' : '腳本新增成功');
        // Logic to update/add script
        handleCancel();
      };
      const handleRun = (script) => {
        modal.confirm({
          title: `確定要執行腳本 "${script.name}" 嗎?`,
          icon: <PlayCircleOutlined />,
          onOk: () => {
            message.loading({ content: '執行中...', key: 'run_script' });
            setTimeout(() => {
              addExecution({
                key: `e_${Date.now()}`,
                scriptName: script.name,
                trigger: { type: 'Manual', user: 'admin' },
                status: 'success',
                startTime: dayjs(),
                duration: `${(Math.random() * 5).toFixed(1)}s`
              });
              message.success({ content: '執行成功', key: 'run_script' });
            }, 1000);
          }
        })
      };

      const columns = [
        { title: '腳本名稱', dataIndex: 'name' },
        { title: '類型', dataIndex: 'type', render: t => <Tag>{t}</Tag> },
        { title: '描述', dataIndex: 'description' },
        { title: '創建者', dataIndex: 'creator' },
        {
          title: '操作', key: 'action', render: (_, record) => (
            <Space>
              <Tooltip title="運行"><Button size="small" className="btn btn--success btn--icon-only btn--sm" icon={<PlayCircleOutlined />} onClick={() => handleRun(record)} /></Tooltip>
              <Tooltip title="編輯"><Button size="small" className="btn btn--info btn--icon-only btn--sm" icon={<EditOutlined />} onClick={() => showModal(record)} /></Tooltip>
              <Tooltip title="刪除"><Button size="small" className="btn btn--danger btn--icon-only btn--sm" icon={<DeleteOutlined />} /></Tooltip>
            </Space>
          )
        }
      ];

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>腳本庫</Title>
            <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>新增腳本</Button>
          </div>
          <Paragraph className="page-subtitle" type="secondary">提供自動化腳本的開發與管理界面。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              {
                scripts.length > 0 ?
                  <Table columns={columns} dataSource={scripts} rowKey="key" style={{ background: 'transparent' }} /> :
                  <Empty description="尚無任何腳本">
                    <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>立即新增腳本</Button>
                  </Empty>
              }
            </div>
          </div>
          <Modal title={editingScript ? '編輯腳本' : '新建腳本'} open={isModalOpen} onCancel={handleCancel} onOk={() => form.submit()} width={800}>
            <Form form={form} layout="vertical" onFinish={onFinish} style={{ marginTop: 24 }}>
              <Form.Item name="name" label="腳本名稱" rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              <Form.Item name="type" label="類型" rules={[{ required: true }]}>
                <Select><Select.Option value="Python">Python</Select.Option><Select.Option value="Bash">Bash</Select.Option></Select>
              </Form.Item>
              <Form.Item name="description" label="描述">
                <TextArea rows={2} />
              </Form.Item>
              <Form.List name="parameters">
                {(fields, { add, remove }) => (
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '16px' }}>
                    {fields.map(({ key, name, ...restField }) => (
                      <Space key={key} align="baseline">
                        <Form.Item {...restField} name={[name, 'name']} rules={[{ required: true, message: '請輸入參數名稱' }]}>
                          <Input placeholder="參數名稱" />
                        </Form.Item>
                        <Form.Item {...restField} name={[name, 'type']} initialValue="string" rules={[{ required: true, message: '請選擇類型' }]}>
                          <Select style={{ width: 120 }}>
                            <Select.Option value="string">String</Select.Option>
                            <Select.Option value="number">Number</Select.Option>
                          </Select>
                        </Form.Item>
                        <MinusCircleOutlined onClick={() => remove(name)} />
                      </Space>
                    ))}
                    <Button type="dashed" onClick={() => add()} block icon={<PlusOutlined />}>新增參數</Button>
                  </div>
                )}
              </Form.List>
              <Form.Item name="code" label="腳本內容" rules={[{ required: true }]}>
                <TextArea rows={15} className="code-editor-like" />
              </Form.Item>
            </Form>
          </Modal>
        </React.Fragment>
      );
    };

    const SchedulesPage = ({ scripts }) => {
      const initialSchedules = [
        { key: 'sch_1', name: '每日資料庫備份', cron: '0 2 * * *', scriptId: 's_3', lastRun: dayjs().subtract(1, 'day').hour(2), enabled: true },
        { key: 'sch_2', name: '每小時清理臨時文件', cron: '0 * * * *', scriptId: 's_2', lastRun: dayjs().subtract(30, 'minute'), enabled: false },
      ];
      const [schedules, setSchedules] = useLocalStorageState('sre-schedules', initialSchedules);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingSchedule, setEditingSchedule] = useState(null);
      const [form] = Form.useForm();
      const { message, modal } = antd.App.useApp();
      const selectedScriptId = Form.useWatch('scriptId', form);
      const selectedScript = scripts.find(function (s) { return s.key === selectedScriptId; });
      const mockResources = [
        { key: 'r_1', name: 'db-prod-01' }, { key: 'r_2', name: 'web-prod-02' }, { key: 'r_3', name: 'api-gateway-prod' }, { key: 'r_4', name: 'cache-redis-prod' }
      ];

      const getScriptName = (id) => {
        const script = scripts.find(function (s) { return s.key === id; });
        return script ? script.name : '未知腳本';
      };

      const showModal = (schedule = null) => {
        setEditingSchedule(schedule);
        form.setFieldsValue(schedule || { name: '', description: '', cron: '0 * * * *', enabled: true });
        setIsModalOpen(true);
      };
      const handleCancel = () => setIsModalOpen(false);
      const onFinish = (values) => {
        message.success(editingSchedule ? '排程更新成功' : '排程新增成功');
        handleCancel();
      };

      const columns = [
        { title: '任務名稱', dataIndex: 'name' },
        { title: '狀態', dataIndex: 'enabled', render: e => <Switch defaultChecked={e} /> },
        { title: '執行腳本', dataIndex: 'scriptId', render: id => getScriptName(id) },
        { title: 'CRON 觸發條件', dataIndex: 'cron', render: c => <code>{c}</code> },
        { title: '上次執行', dataIndex: 'lastRun', render: time => time.fromNow() },
        { title: '操作', key: 'action', render: (_, record) => <Space><Button className="btn btn--info btn--sm" onClick={() => showModal(record)}>編輯</Button><Button className="btn btn--danger btn--sm">刪除</Button></Space> }
      ];

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>排程管理</Title>
            <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>新增排程</Button>
          </div>
          <Paragraph className="page-subtitle" type="secondary">提供對定時執行任務的完整管理界面。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              {
                schedules.length > 0 ?
                  <Table columns={columns} dataSource={schedules} rowKey="key" style={{ background: 'transparent' }} /> :
                  <Empty description="尚無任何排程">
                    <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showModal()}>立即新增排程</Button>
                  </Empty>
              }
            </div>
          </div>
          <Modal title={editingSchedule ? '編輯排程' : '新增排程'} open={isModalOpen} onCancel={handleCancel} onOk={() => form.submit()}>
            <Form form={form} layout="vertical" onFinish={onFinish} style={{ marginTop: 24 }}>
              <Form.Item name="name" label="任務名稱" rules={[{ required: true }]}><Input /></Form.Item>
              <Form.Item name="description" label="描述"><TextArea rows={2} /></Form.Item>
              <Form.Item name="scriptId" label="執行腳本" rules={[{ required: true }]}>
                <Select showSearch options={scripts.map(s => ({ label: s.name, value: s.key }))} />
              </Form.Item>
              <Form.Item name="target_resources" label="目標資源">
                <Select mode="multiple" allowClear showSearch options={mockResources.map(r => ({ label: r.name, value: r.key }))} />
              </Form.Item>
              <Form.Item name="cron" label={
                <Space>
                  <span>CRON 表達式</span>
                  <Tooltip title="依序為：分 時 日 月 週。 `* * * * *` 表示每分鐘執行一次。">
                    <InfoCircleOutlined />
                  </Tooltip>
                </Space>
              } rules={[{ required: true }]}>
                <Input />
              </Form.Item>
              {selectedScript && selectedScript.params && (
                <Card size="small" title="腳本參數">
                  {selectedScript.params.map(p => (
                    <Form.Item key={p.name} name={['params', p.name]} label={p.label} rules={[{ required: true }]}>
                      {p.type === 'number' ? <InputNumber style={{ width: '100%' }} /> : <Input />}
                    </Form.Item>
                  ))}
                </Card>
              )}
            </Form>
          </Modal>
        </React.Fragment>
      );
    };

    const ExecutionsPage = ({ executions, setExecutions }) => {
      const [logModal, setLogModal] = useState({ open: false, log: '' });

      const viewLog = (record) => {
        const logContent = `[${record.startTime ? record.startTime.format('YYYY-MM-DD HH:mm:ss') : '未知時間'}] Starting execution for script: ${record.scriptName}\nTriggered by: ${record.trigger.type}\n...\nExecution ${record.status}.\nDuration: ${record.duration}`;
        setLogModal({ open: true, log: logContent });
      };

      const copyLog = () => {
        navigator.clipboard.writeText(logModal.log);
        message.success('日誌已複製');
      };

      const columns = [
        { title: '狀態', dataIndex: 'status', render: s => <Tag color={s === 'success' ? 'green' : 'red'}>{s ? s.toUpperCase() : 'UNKNOWN'}</Tag> },
        { title: '腳本名稱', dataIndex: 'scriptName' },
        { title: '觸發方式', dataIndex: 'trigger', render: t => t.type === 'Manual' ? `手動 (${t.user})` : t.type },
        { title: '開始時間', dataIndex: 'startTime', render: t => t ? t.format('YYYY-MM-DD HH:mm:ss') : '-' },
        { title: '執行耗時', dataIndex: 'duration' },
        { title: '操作', key: 'action', render: (_, record) => <Button className="btn btn--ghost btn--sm" onClick={() => viewLog(record)}>查看日誌</Button> }
      ];

      return (
        <React.Fragment>
          <Title level={2} className="page-title">執行日誌</Title>
          <Paragraph className="page-subtitle" type="secondary">追蹤所有自動化腳本的執行歷史與結果。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              <Table columns={columns} dataSource={executions} rowKey="key" style={{ background: 'transparent' }} />
            </div>
          </div>
          <Modal title="執行日誌" open={logModal.open} onCancel={() => setLogModal({ open: false, log: '' })} footer={null} width={700}>
            <div style={{ marginTop: 24 }}>
              <Button icon={<CopyOutlined />} onClick={copyLog} style={{ marginBottom: 16 }}>複製日誌</Button>
              <div className="log-viewer">
                <pre>{logModal.log}</pre>
              </div>
            </div>
          </Modal>
        </React.Fragment>
      );
    };

    const CapacityPlanningPage = ({ themeMode }) => {
      const [form] = Form.useForm();
      const { message, modal } = antd.App.useApp();
      const [analysisResult, setAnalysisResult] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [confirmModal, setConfirmModal] = useState({ open: false, script: null });

      const mockResourceGroups = [
        { id: 'g_1', name: 'Production Database' },
        { id: 'g_2', name: 'Production Web Servers' },
      ];
      const mockMetrics = [
        { id: 'cpu_utilization', name: 'CPU 使用率 (%)' },
        { id: 'memory_usage', name: '記憶體使用率 (GB)' },
        { id: 'disk_space', name: '磁碟空間使用率 (%)' },
      ];
      const mockScripts = [
        { id: 's_1', name: 'Auto-scaling for Web Servers' },
        { id: 's_2', name: 'Increase Database Disk Volume' },
      ];

      const handleAnalysis = (values) => {
        setIsLoading(true);
        setAnalysisResult(null);
        setTimeout(() => {
          const historical = Array.from({ length: 30 }, (_, i) => {
            const date = dayjs().subtract(30 - i, 'days').format('YYYY-MM-DD');
            const value = 50 + i * 0.5 + Math.random() * 5;
            return [date, value.toFixed(2)];
          });

          const lastValue = parseFloat(historical[historical.length - 1][1]);
          const prediction = Array.from({ length: 90 }, (_, i) => {
            const date = dayjs().add(i + 1, 'days').format('YYYY-MM-DD');
            const value = lastValue + i * 0.3 + Math.random() * 2;
            return [date, value.toFixed(2)];
          });

          setAnalysisResult({
            key_metrics: { days_to_threshold: 45, threshold: 80, current_value: lastValue.toFixed(2), },
            chart_data: { historical, prediction },
            suggestions: [
              { text: '目前的資源增長趨勢穩定，但預計在 45 天後達到 80% 的警戒線。', actionable: false },
              { text: '建議執行擴容腳本，增加 2 個 Web Server 實例以應對預期流量增長。', actionable: true, action_type: '執行擴容腳本', action_target: { script_id: 's_1' } },
              { text: '考慮對資料庫進行垂直擴容，將實例類型升級至下一個級別。', actionable: false },
            ]
          });
          setIsLoading(false);
        }, 1500);
      };

      const handleActionClick = (suggestion) => {
        const script = mockScripts.find(s => s.id === suggestion.action_target.script_id);
        if (script) {
          setConfirmModal({ open: true, script: script });
        }
      };

      const handleConfirmOk = () => {
        message.loading({ content: '正在執行腳本...', key: 'exec' });
        setTimeout(() => {
          message.success({ content: `腳本 "${confirmModal.script.name}" 已成功執行`, key: 'exec' });
          setConfirmModal({ open: false, script: null });
        }, 1000);
      };

      const chartOption = analysisResult ? {
        backgroundColor: 'transparent',
        tooltip: { trigger: 'axis' },
        legend: { data: ['歷史數據', '預測趨勢'] },
        xAxis: {
          type: 'category',
          data: [
            ...analysisResult.chart_data.historical.map(d => d[0]),
            ...analysisResult.chart_data.prediction.map(d => d[0])
          ]
        },
        yAxis: {
          type: 'value',
          axisLabel: { formatter: '{value} %' }
        },
        series: [
          {
            name: '歷史數據',
            type: 'line',
            data: analysisResult.chart_data.historical,
            smooth: true
          },
          {
            name: '預測趨勢',
            type: 'line',
            data: [
              ...Array(Math.max(0, analysisResult.chart_data.historical.length - 1)).fill(null),
              analysisResult.chart_data.historical[analysisResult.chart_data.historical.length - 1],
              ...analysisResult.chart_data.prediction
            ].filter(item => item !== undefined),
            smooth: true,
            lineStyle: { type: 'dashed' }
          },
          {
            name: '警戒線',
            type: 'line',
            markLine: {
              silent: true,
              data: [{ yAxis: 80, name: '80% 警戒線' }],
              label: { position: 'end', formatter: '{b}', color: '#ff4d4f' },
              lineStyle: { color: '#ff4d4f' }
            }
          }
        ]
      } : {};

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '12px' }}>
            <div>
              <Title level={2} className="page-title" style={{ margin: 0, marginBottom: '4px' }}>容量規劃</Title>
              <Paragraph className="page-subtitle" type="secondary" style={{ margin: 0 }}>分析歷史數據，預測未來資源消耗趨勢，從被動事件轉向主動規劃。</Paragraph>
            </div>
          </div>

          <Form form={form} layout="inline" onFinish={handleAnalysis} style={{ marginBottom: 16, padding: '16px', background: 'rgba(0,0,0,0.2)', borderRadius: '8px' }}>
            <Form.Item name="resource_group" label="資源群組" rules={[{ required: true }]} initialValue="g_1" style={{ marginBottom: 8 }}>
              <Select style={{ width: 180 }} placeholder="選擇資源群組" options={mockResourceGroups.map(g => ({ label: g.name, value: g.id }))} />
            </Form.Item>
            <Form.Item name="metric" label="效能指標" rules={[{ required: true }]} initialValue="cpu_utilization" style={{ marginBottom: 8 }}>
              <Select style={{ width: 180 }} placeholder="選擇指標" options={mockMetrics.map(m => ({ label: m.name, value: m.id }))} />
            </Form.Item>
            <Form.Item name="period" label="預測期間" initialValue="90d" rules={[{ required: true }]} style={{ marginBottom: 8 }}>
              <Select style={{ width: 120 }}>
                <Select.Option value="30d">30 天</Select.Option>
                <Select.Option value="60d">60 天</Select.Option>
                <Select.Option value="90d">90 天</Select.Option>
              </Select>
            </Form.Item>
            <Form.Item style={{ marginBottom: 8 }}>
              <Button type="primary" className="btn btn--primary" htmlType="submit" loading={isLoading}>開始分析</Button>
            </Form.Item>
          </Form>

          <Spin spinning={isLoading} tip="正在進行數據分析與趨勢預測...">
            {analysisResult ? (
              <Row gutter={[16, 16]} align="stretch">
                <Col xs={24} md={8}>
                  <div style={{ display: 'flex', flexDirection: 'column', height: '320px', gap: '16px' }}>
                    {/* 目前使用率卡片 */}
                    <div style={{
                      flex: '1',
                      background: 'linear-gradient(135deg, rgba(24, 144, 255, 0.1) 0%, rgba(24, 144, 255, 0.05) 100%)',
                      border: '1px solid rgba(24, 144, 255, 0.2)',
                      borderRadius: '12px',
                      padding: '24px',
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center',
                      alignItems: 'center',
                      backdropFilter: 'blur(20px) saturate(180%)',
                      WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                    }}>
                      <div style={{ fontSize: '14px', color: 'rgba(255, 255, 255, 0.7)', marginBottom: '8px' }}>目前使用率</div>
                      <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#1890ff', marginBottom: '4px' }}>
                        {analysisResult.key_metrics.current_value}<span style={{ fontSize: '24px' }}>%</span>
                      </div>
                    </div>

                    {/* 警戒線卡片 */}
                    <div style={{
                      flex: '1',
                      background: 'linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%)',
                      border: '1px solid rgba(255, 193, 7, 0.2)',
                      borderRadius: '12px',
                      padding: '24px',
                      display: 'flex',
                      flexDirection: 'column',
                      justifyContent: 'center',
                      alignItems: 'center',
                      backdropFilter: 'blur(20px) saturate(180%)',
                      WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                      boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                    }}>
                      <div style={{ fontSize: '14px', color: 'rgba(255, 255, 255, 0.7)', marginBottom: '8px' }}>預計達到 80% 警戒線</div>
                      <div style={{ fontSize: '36px', fontWeight: 'bold', color: '#ffc107', marginBottom: '4px' }}>
                        {analysisResult.key_metrics.days_to_threshold} <span style={{ fontSize: '16px' }}>天後</span>
                      </div>
                    </div>
                  </div>
                </Col>
                <Col xs={24} md={16}>
                  <div style={{
                    height: '320px',
                    background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                    border: '1px solid rgba(255, 255, 255, 0.08)',
                    borderRadius: '12px',
                    padding: '24px',
                    backdropFilter: 'blur(20px) saturate(180%)',
                    WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
                  }}>
                    <Title level={5} style={{ margin: 0, marginBottom: 16, color: 'rgba(255, 255, 255, 0.85)' }}>趨勢預測圖</Title>
                    <div style={{ height: 'calc(100% - 40px)' }}>
                      <EchartsForReact option={chartOption} isDark={themeMode === 'dark'} />
                    </div>
                  </div>
                </Col>
                <Col xs={24}>
                  <div style={{
                    background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                    border: '1px solid rgba(255, 255, 255, 0.08)',
                    borderRadius: '12px',
                    padding: '24px',
                    backdropFilter: 'blur(20px) saturate(180%)',
                    WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)',
                    marginTop: '16px'
                  }}>
                    <Title level={5} style={{ margin: 0, marginBottom: 16, color: 'rgba(255, 255, 255, 0.85)' }}>分析與建議</Title>
                    <List
                      size="small"
                      dataSource={analysisResult.suggestions}
                      renderItem={item => (
                        <List.Item
                          actions={item.actionable ? [
                            <Button
                              size="small"
                              type="primary"
                              icon={<ThunderboltOutlined />}
                              onClick={() => handleActionClick(item)}
                              style={{
                                background: 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)',
                                border: 'none',
                                borderRadius: '6px',
                                fontWeight: '500'
                              }}
                            >
                              {item.action_type}
                            </Button>
                          ] : []}
                        >
                          <List.Item.Meta description={<span style={{ color: 'rgba(255, 255, 255, 0.85)' }}>{item.text}</span>} />
                        </List.Item>
                      )}
                    />
                  </div>
                </Col>
              </Row>
            ) : (
              !isLoading && <div className="empty-analysis" style={{ marginTop: 24, textAlign: 'center' }}><Empty description="請選擇資源與指標以開始分析" /></div>
            )}
          </Spin>

          <Modal
            title="確認執行自動化腳本"
            open={confirmModal.open}
            onOk={handleConfirmOk}
            onCancel={() => setConfirmModal({ open: false, script: null })}
            okText="確認執行"
            cancelText="取消"
          >
            {confirmModal.script && <p>您確定要執行以下腳本嗎？<br /><strong>腳本名稱:</strong> {confirmModal.script.name}</p>}
          </Modal>
        </React.Fragment>
      );
    };

    // 共享的數據和工具函數
    const mockRoles = [
      { id: 'super_admin', name: '超級管理員', color: 'red' },
      { id: 'team_manager', name: '團隊管理員', color: 'orange' },
      { id: 'team_member', name: '團隊成員', color: 'blue' },
      { id: 'viewer', name: '唯讀用戶', color: 'gray' }
    ];

    const UserManagementPage = () => {
      const initialUsers = [
        { key: 'u_1', name: 'Admin User', email: 'admin@example.com', teams: ['t_3'], roles: ['super_admin'], status: 'active', lastLogin: dayjs().subtract(1, 'day'), createdAt: dayjs().subtract(30, 'day') },
        { key: 'u_2', name: 'Dev User', email: 'dev@example.com', teams: ['t_1'], roles: ['team_manager', 'team_member'], status: 'active', lastLogin: dayjs().subtract(2, 'hours'), createdAt: dayjs().subtract(15, 'day') },
        { key: 'u_3', name: 'View User', email: 'view@example.com', teams: ['t_2'], roles: ['viewer'], status: 'inactive', lastLogin: dayjs().subtract(7, 'day'), createdAt: dayjs().subtract(45, 'day') },
        { key: 'u_4', name: 'Ops User', email: 'ops@example.com', teams: ['t_1', 't_3'], roles: ['team_member'], status: 'active', lastLogin: dayjs().subtract(30, 'minutes'), createdAt: dayjs().subtract(10, 'day') },
      ];

      const initialTeams = [
        { key: 't_1', name: 'Developers', description: '負責開發與維護的核心團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_devops'], createdAt: dayjs().subtract(60, 'day'), owner: 'u_2' },
        { key: 't_2', name: 'Viewers', description: '僅有檢視權限的觀察員', members: ['u_3'], subscribers: ['u_2'], createdAt: dayjs().subtract(45, 'day'), owner: 'u_1' },
        { key: 't_3', name: 'Administrators', description: '平台最高權限管理者', members: ['u_1', 'u_4'], subscribers: ['u_1', 'slack_network', 'email_security', 'oncall_security'], createdAt: dayjs().subtract(90, 'day'), owner: 'u_1' },
        { key: 't_4', name: 'QA Team', description: '品質保證與測試團隊', members: [], subscribers: ['u_3', 'email_ops'], createdAt: dayjs().subtract(20, 'day'), owner: 'u_1' },
        { key: 't_5', name: 'DevOps Team', description: '負責CI/CD和基礎設施自動化的團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_devops'], createdAt: dayjs().subtract(30, 'day'), owner: 'u_2' },
        { key: 't_6', name: 'Database Team', description: '負責資料庫管理與優化的團隊', members: ['u_1'], subscribers: ['u_1', 'slack_database'], createdAt: dayjs().subtract(40, 'day'), owner: 'u_1' },
        { key: 't_7', name: 'Network Team', description: '負責網路基礎設施與安全的團隊', members: ['u_3'], subscribers: ['u_3', 'slack_network'], createdAt: dayjs().subtract(50, 'day'), owner: 'u_3' },
        { key: 't_8', name: 'Security Team', description: '負責資訊安全與合規的團隊', members: ['u_4'], subscribers: ['u_4', 'email_security', 'oncall_security'], createdAt: dayjs().subtract(35, 'day'), owner: 'u_4' },
        { key: 't_9', name: 'Operations Team', description: '負責系統運營與監控的團隊', members: ['u_1', 'u_2', 'u_3'], subscribers: ['u_1', 'slack_operations'], createdAt: dayjs().subtract(25, 'day'), owner: 'u_1' },
        { key: 't_10', name: 'Platform Team', description: '負責平台架構與技術基礎設施的團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_platform'], createdAt: dayjs().subtract(15, 'day'), owner: 'u_2' },
      ];

      const [users, setUsers] = useLocalStorageState('sre-users', initialUsers);
      const [teams] = useLocalStorageState('sre-teams', initialTeams);
      const [isUserModalOpen, setIsUserModalOpen] = useState(false);
      const [editingUser, setEditingUser] = useState(null);
      const [userSearchText, setUserSearchText] = useState('');
      const [userForm] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      const getTeamNames = (teamIds) => teamIds.map(id => {
        const team = teams.find(t => t.key === id);
        return team ? team.name : id;
      });
      const getRoleNames = (roleIds) => roleIds.map(id => {
        const role = mockRoles.find(r => r.id === id);
        return role ? role.name : id;
      });

      // 用戶操作函數
      const showUserModal = (user = null) => {
        setEditingUser(user);
        userForm.setFieldsValue(user || { name: '', email: '', teams: [], roles: ['viewer'], status: 'active' });
        setIsUserModalOpen(true);
      };
      const handleUserCancel = () => {
        setIsUserModalOpen(false);
        setEditingUser(null);
        userForm.resetFields();
      };
      const handleUserFinish = (values) => {
        const newUser = {
          ...values,
          key: editingUser ? editingUser.key : `u_${Date.now()}`,
          createdAt: editingUser ? editingUser.createdAt : dayjs(),
          lastLogin: editingUser ? editingUser.lastLogin : null
        };
        if (editingUser) {
          setUsers(users.map(u => u.key === editingUser.key ? newUser : u));
          message.success('用戶更新成功');
        } else {
          setUsers([newUser, ...users]);
          message.success('用戶新增成功');
        }
        handleUserCancel();
      };
      const handleUserDelete = (user) => {
        modal.confirm({
          title: '確定要刪除此用戶嗎？',
          content: `將刪除用戶 "${user.name}"，此操作無法復原。`,
          okText: '確定',
          okType: 'danger',
          cancelText: '取消',
          onOk() {
            setUsers(users.filter(u => u.key !== user.key));
            message.success('用戶刪除成功');
          }
        });
      };

      const userColumns = [
        {
          title: '狀態', dataIndex: 'status', width: 80, render: status => (
            <Tag color={status === 'active' ? 'green' : 'gray'}>
              {status === 'active' ? '活躍' : '停用'}
            </Tag>
          )
        },
        { title: '姓名', dataIndex: 'name', sorter: (a, b) => a.name.localeCompare(b.name) },
        { title: '電子郵件', dataIndex: 'email', sorter: (a, b) => a.email.localeCompare(b.email) },
        { title: '團隊', dataIndex: 'teams', render: ids => getTeamNames(ids).join(', ') },
        {
          title: '角色', dataIndex: 'roles', render: ids => ids.map(id => {
            const role = mockRoles.find(r => r.id === id);
            return <Tag key={id} color={role && role.color}>{getRoleNames([id])}</Tag>;
          })
        },
        { title: '最後登入', dataIndex: 'lastLogin', render: time => time ? time.fromNow() : '從未登入', sorter: (a, b) => (a.lastLogin || dayjs(0)).valueOf() - (b.lastLogin || dayjs(0)).valueOf() },
        {
          title: '操作', key: 'action', width: 120, render: (_, record) => (
            <Space>
              <Button type="link" onClick={() => showUserModal(record)}>編輯</Button>
              <Button type="link" danger onClick={() => handleUserDelete(record)}>刪除</Button>
            </Space>
          )
        }
      ];

      // 篩選用戶
      const filteredUsers = users.filter(user =>
        user.name.toLowerCase().includes(userSearchText.toLowerCase()) ||
        user.email.toLowerCase().includes(userSearchText.toLowerCase())
      );

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>人員管理</Title>
            <Space>
              <Input.Search
                placeholder="搜尋用戶姓名或電子郵件"
                onChange={e => setUserSearchText(e.target.value)}
                style={{ width: 300 }}
              />
              <Button type="primary" icon={<PlusOutlined />} onClick={() => showUserModal()}>新增用戶</Button>
            </Space>
          </div>
          <Paragraph className="page-subtitle" type="secondary">管理平台的所有使用者帳號與權限角色。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              <Table
                dataSource={filteredUsers}
                columns={userColumns}
                rowKey="key"
                style={{ background: 'transparent' }}
                pagination={{ pageSize: 10 }}
              />
            </div>
          </div>

          {/* 用戶編輯模態框 */}
          <Modal
            title={editingUser ? '編輯用戶' : '新增用戶'}
            open={isUserModalOpen}
            onCancel={handleUserCancel}
            footer={null}
            width={600}
          >
            <Form form={userForm} layout="vertical" onFinish={handleUserFinish} style={{ marginTop: 24 }}>
              <Form.Item name="name" label="用戶姓名" rules={[{ required: true, message: '請輸入用戶姓名' }]}>
                <Input />
              </Form.Item>
              <Form.Item name="email" label="電子郵件" rules={[{ required: true, message: '請輸入電子郵件' }, { type: 'email', message: '請輸入有效的電子郵件地址' }]}>
                <Input />
              </Form.Item>
              <Form.Item name="teams" label="所屬團隊">
                <Select mode="multiple" options={teams.map(t => ({ label: t.name, value: t.key }))} />
              </Form.Item>
              <Form.Item name="roles" label="角色" rules={[{ required: true, message: '請選擇至少一個角色' }]}>
                <Select mode="multiple" options={mockRoles.map(r => ({ label: r.name, value: r.id }))} />
              </Form.Item>
              <Form.Item name="status" label="狀態">
                <Select>
                  <Select.Option value="active">活躍</Select.Option>
                  <Select.Option value="inactive">停用</Select.Option>
                </Select>
              </Form.Item>
              <Form.Item style={{ textAlign: 'right', marginBottom: 0 }}>
                <Button onClick={handleUserCancel} style={{ marginRight: 8 }}>取消</Button>
                <Button type="primary" htmlType="submit">確定</Button>
              </Form.Item>
            </Form>
          </Modal>
        </React.Fragment>
      );
    };

    const TeamManagementPage = () => {
      const initialTeams = [
        { key: 't_1', name: 'Developers', description: '負責開發與維護的核心團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_devops'], createdAt: dayjs().subtract(60, 'day'), owner: 'u_2' },
        { key: 't_2', name: 'Viewers', description: '僅有檢視權限的觀察員', members: ['u_3'], subscribers: ['u_2'], createdAt: dayjs().subtract(45, 'day'), owner: 'u_1' },
        { key: 't_3', name: 'Administrators', description: '平台最高權限管理者', members: ['u_1', 'u_4'], subscribers: ['u_1', 'slack_network', 'email_security', 'oncall_security'], createdAt: dayjs().subtract(90, 'day'), owner: 'u_1' },
        { key: 't_4', name: 'QA Team', description: '品質保證與測試團隊', members: [], subscribers: ['u_3', 'email_ops'], createdAt: dayjs().subtract(20, 'day'), owner: 'u_1' },
        { key: 't_5', name: 'DevOps Team', description: '負責CI/CD和基礎設施自動化的團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_devops'], createdAt: dayjs().subtract(30, 'day'), owner: 'u_2' },
        { key: 't_6', name: 'Database Team', description: '負責資料庫管理與優化的團隊', members: ['u_1'], subscribers: ['u_1', 'slack_database'], createdAt: dayjs().subtract(40, 'day'), owner: 'u_1' },
        { key: 't_7', name: 'Network Team', description: '負責網路基礎設施與安全的團隊', members: ['u_3'], subscribers: ['u_3', 'slack_network'], createdAt: dayjs().subtract(50, 'day'), owner: 'u_3' },
        { key: 't_8', name: 'Security Team', description: '負責資訊安全與合規的團隊', members: ['u_4'], subscribers: ['u_4', 'email_security', 'oncall_security'], createdAt: dayjs().subtract(35, 'day'), owner: 'u_4' },
        { key: 't_9', name: 'Operations Team', description: '負責系統運營與監控的團隊', members: ['u_1', 'u_2', 'u_3'], subscribers: ['u_1', 'slack_operations'], createdAt: dayjs().subtract(25, 'day'), owner: 'u_1' },
        { key: 't_10', name: 'Platform Team', description: '負責平台架構與技術基礎設施的團隊', members: ['u_2', 'u_4'], subscribers: ['u_1', 'slack_platform'], createdAt: dayjs().subtract(15, 'day'), owner: 'u_2' },
      ];

      const initialUsers = [
        { key: 'u_1', name: 'Admin User', email: 'admin@example.com', teams: ['t_3'], roles: ['super_admin'], status: 'active', lastLogin: dayjs().subtract(1, 'day'), createdAt: dayjs().subtract(30, 'day') },
        { key: 'u_2', name: 'Dev User', email: 'dev@example.com', teams: ['t_1'], roles: ['team_manager', 'team_member'], status: 'active', lastLogin: dayjs().subtract(2, 'hours'), createdAt: dayjs().subtract(15, 'day') },
        { key: 'u_3', name: 'View User', email: 'view@example.com', teams: ['t_2'], roles: ['viewer'], status: 'inactive', lastLogin: dayjs().subtract(7, 'day'), createdAt: dayjs().subtract(45, 'day') },
        { key: 'u_4', name: 'Ops User', email: 'ops@example.com', teams: ['t_1', 't_3'], roles: ['team_member'], status: 'active', lastLogin: dayjs().subtract(30, 'minutes'), createdAt: dayjs().subtract(10, 'day') },
      ];

      const [teams, setTeams] = useLocalStorageState('sre-teams', initialTeams);
      const [users] = useLocalStorageState('sre-users', initialUsers);
      const [isTeamModalOpen, setIsTeamModalOpen] = useState(false);
      const [editingTeam, setEditingTeam] = useState(null);
      const [teamSearchText, setTeamSearchText] = useState('');
      const [selectedMembers, setSelectedMembers] = useState([]);
      const [selectedSubscribers, setSelectedSubscribers] = useState([]);
      const [teamForm] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      // 模擬通知訂閱者數據
      const mockSubscribers = [
        // 人員
        { key: 'u_1', name: '王工程師', type: 'USER', icon: '👤' },
        { key: 'u_2', name: '陳經理', type: 'USER', icon: '👤' },
        { key: 'u_3', name: '李開發', type: 'USER', icon: '👤' },
        // Slack頻道
        { key: 'slack_network', name: '網路一部 Slack', type: 'SLACK_CHANNEL', icon: '#️⃣' },
        { key: 'slack_devops', name: 'DevOps 團隊 Slack', type: 'SLACK_CHANNEL', icon: '#️⃣' },
        // Email群組
        { key: 'email_security', name: '資安團隊 Email 群組', type: 'EMAIL_GROUP', icon: '✉️' },
        { key: 'email_ops', name: '運營團隊 Email 群組', type: 'EMAIL_GROUP', icon: '✉️' },
        // On-Call值班表
        { key: 'oncall_network', name: '網路團隊 On-Call 值班表', type: 'ON_CALL_SCHEDULE', icon: '📞' },
        { key: 'oncall_security', name: '資安團隊 On-Call 值班表', type: 'ON_CALL_SCHEDULE', icon: '📞' }
      ];

      const getUserName = (userId) => {
        const user = users.find(u => u.key === userId);
        return user ? user.name : userId;
      };

      // 團隊操作函數
      const showTeamModal = (team = null) => {
        setEditingTeam(team);
        const initialMembers = team ? team.members || [] : [];
        const initialSubscribers = team ? team.subscribers || [] : [];
        setSelectedMembers(initialMembers);
        setSelectedSubscribers(initialSubscribers);
        teamForm.setFieldsValue(team || { name: '', description: '' });
        setIsTeamModalOpen(true);
      };
      const handleTeamCancel = () => {
        setIsTeamModalOpen(false);
        setEditingTeam(null);
        setSelectedMembers([]);
        setSelectedSubscribers([]);
        teamForm.resetFields();
      };
      const handleTeamFinish = (values) => {
        const newTeam = {
          ...values,
          members: selectedMembers,
          subscribers: selectedSubscribers,
          key: editingTeam ? editingTeam.key : `t_${Date.now()}`,
          createdAt: editingTeam ? editingTeam.createdAt : dayjs(),
          owner: editingTeam ? editingTeam.owner : 'u_1' // 默認創建者為管理員
        };
        if (editingTeam) {
          setTeams(teams.map(t => t.key === editingTeam.key ? newTeam : t));
          message.success('團隊更新成功');
        } else {
          setTeams([newTeam, ...teams]);
          message.success('團隊新增成功');
        }
        handleTeamCancel();
      };
      const handleTeamDelete = (team) => {
        modal.confirm({
          title: '確定要刪除此團隊嗎？',
          content: `將刪除團隊 "${team.name}"，所有成員將被移除，此操作無法復原。`,
          okText: '確定',
          okType: 'danger',
          cancelText: '取消',
          onOk() {
            setTeams(teams.filter(t => t.key !== team.key));
            message.success('團隊刪除成功');
          }
        });
      };

      const teamColumns = [
        { title: '團隊名稱', dataIndex: 'name', sorter: (a, b) => a.name.localeCompare(b.name) },
        { title: '成員數', dataIndex: 'members', render: m => m.length, sorter: (a, b) => a.members.length - b.members.length },
        { title: '訂閱者數', dataIndex: 'subscribers', render: s => s ? s.length : 0, sorter: (a, b) => (a.subscribers?.length || 0) - (b.subscribers?.length || 0) },
        { title: '負責人', dataIndex: 'owner', render: owner => getUserName(owner) },
        { title: '描述', dataIndex: 'description' },
        { title: '創建時間', dataIndex: 'createdAt', render: time => time ? time.format('YYYY-MM-DD') : '-', sorter: (a, b) => (a.createdAt || dayjs(0)).valueOf() - (b.createdAt || dayjs(0)).valueOf() },
        {
          title: '操作', key: 'action', width: 120, render: (_, record) => (
            <Space>
              <Button type="link" onClick={() => showTeamModal(record)}>編輯</Button>
              <Button type="link" danger onClick={() => handleTeamDelete(record)}>刪除</Button>
            </Space>
          )
        }
      ];

      // 篩選團隊
      const filteredTeams = teams.filter(team =>
        team.name.toLowerCase().includes(teamSearchText.toLowerCase()) ||
        team.description.toLowerCase().includes(teamSearchText.toLowerCase()) ||
        (team.subscribers && team.subscribers.some(subscriberKey =>
          mockSubscribers.find(s => s.key === subscriberKey)?.name.toLowerCase().includes(teamSearchText.toLowerCase())
        ))
      );

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>團隊管理</Title>
            <Space>
              <Input.Search
                placeholder="搜尋團隊名稱或描述"
                onChange={e => setTeamSearchText(e.target.value)}
                style={{ width: 300 }}
              />
              <Button type="primary" className="btn btn--primary" icon={<PlusOutlined />} onClick={() => showTeamModal()}>新增團隊</Button>
            </Space>
          </div>
          <Paragraph className="page-subtitle" type="secondary">管理團隊結構與成員配置。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              <Table
                dataSource={filteredTeams}
                columns={teamColumns}
                rowKey="key"
                style={{ background: 'transparent' }}
                pagination={{ pageSize: 10 }}
              />
            </div>
          </div>

          {/* 團隊編輯模態框 */}
          <Modal
            title={editingTeam ? '編輯團隊' : '新增團隊'}
            open={isTeamModalOpen}
            onCancel={handleTeamCancel}
            footer={null}
            width={900}
          >
            <Form form={teamForm} layout="vertical" onFinish={handleTeamFinish} style={{ marginTop: 24 }}>
              <Row gutter={16}>
                <Col span={12}>
                  <Form.Item name="name" label="團隊名稱" rules={[{ required: true, message: '請輸入團隊名稱' }]}>
                    <Input />
                  </Form.Item>
                </Col>
                <Col span={12}>
                  <Form.Item name="owner" label="負責人" rules={[{ required: true, message: '請選擇負責人' }]}>
                    <Select options={users.map(u => ({ label: u.name, value: u.key }))} />
                  </Form.Item>
                </Col>
              </Row>
              <Form.Item name="description" label="團隊描述" rules={[{ required: true, message: '請輸入團隊描述' }]}>
                <TextArea rows={3} />
              </Form.Item>
              <Form.Item label="團隊成員">
                <Transfer
                  dataSource={users.map(user => ({
                    key: user.key,
                    title: `${user.name} (${user.email})`,
                    description: user.email,
                    status: user.status,
                    name: user.name,
                    email: user.email
                  }))}
                  showSearch
                  filterOption={(inputValue, item) =>
                    item.name.toLowerCase().includes(inputValue.toLowerCase()) ||
                    item.email.toLowerCase().includes(inputValue.toLowerCase())
                  }
                  targetKeys={selectedMembers}
                  onChange={(targetKeys) => {
                    setSelectedMembers(targetKeys);
                  }}
                  render={item => {
                    const user = users.find(u => u.key === item.key);
                    return (
                      <div style={{ padding: '4px 0', display: 'flex', alignItems: 'center', gap: '8px' }}>
                        <div style={{ fontWeight: '500', color: 'rgba(255, 255, 255, 0.9)', flex: 1 }}>
                          {item.name}
                        </div>
                        <div style={{ fontSize: '12px', color: 'rgba(255, 255, 255, 0.6)', flexShrink: 0 }}>
                          {item.email}
                        </div>
                        <Tag size="small" color={user?.status === 'active' ? 'green' : 'gray'} style={{ flexShrink: 0 }}>
                          {user?.status === 'active' ? '活躍' : '停用'}
                        </Tag>
                      </div>
                    );
                  }}
                  listStyle={{
                    width: 420,
                    height: 300,
                  }}
                  locale={{
                    itemUnit: '個用戶',
                    itemsUnit: '個用戶',
                    searchPlaceholder: '搜尋用戶姓名或郵箱'
                  }}
                  titles={['可用用戶', '團隊成員']}
                />
              </Form.Item>

              <div style={{ display: 'flex', alignItems: 'center', marginBottom: '20px', marginTop: '32px' }}>
                <div style={{ width: '4px', height: '24px', background: 'linear-gradient(135deg, #722ed1 0%, #9254de 100%)', borderRadius: '2px', marginRight: '12px' }}></div>
                <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.9)' }}>通知訂閱者</Title>
              </div>
              <div style={{ padding: '20px', background: 'rgba(255, 255, 255, 0.02)', border: '1px solid rgba(255, 255, 255, 0.08)', borderRadius: '8px', marginBottom: '32px' }}>
                <Form.Item label="選擇通知訂閱者" extra="團隊的告警將發送給選中的訂閱者">
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                    {/* 按類型分組顯示選項 */}
                    {[
                      { title: '👥 人員', type: 'USER', data: mockSubscribers.filter(s => s.type === 'USER') },
                      { title: '#️⃣ Slack 頻道', type: 'SLACK_CHANNEL', data: mockSubscribers.filter(s => s.type === 'SLACK_CHANNEL') },
                      { title: '✉️ Email 群組', type: 'EMAIL_GROUP', data: mockSubscribers.filter(s => s.type === 'EMAIL_GROUP') },
                      { title: '📞 On-Call 值班表', type: 'ON_CALL_SCHEDULE', data: mockSubscribers.filter(s => s.type === 'ON_CALL_SCHEDULE') }
                    ].map(group => (
                      <div key={group.type} style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                        <Text strong style={{ color: 'rgba(255, 255, 255, 0.8)', fontSize: '14px' }}>
                          {group.title}
                        </Text>
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                          {group.data.map(subscriber => {
                            const isSelected = selectedSubscribers.includes(subscriber.key);
                            return (
                              <Tag
                                key={subscriber.key}
                                style={{
                                  cursor: 'pointer',
                                  background: isSelected ? 'rgba(24, 144, 255, 0.15)' : 'rgba(255, 255, 255, 0.05)',
                                  borderColor: isSelected ? 'rgba(24, 144, 255, 0.4)' : 'rgba(255, 255, 255, 0.3)',
                                  color: isSelected ? 'rgba(24, 144, 255, 0.9)' : 'rgba(255, 255, 255, 0.8)',
                                  transition: 'all 0.2s',
                                  padding: '4px 8px',
                                  fontSize: '12px'
                                }}
                                onClick={() => {
                                  if (isSelected) {
                                    setSelectedSubscribers(selectedSubscribers.filter(key => key !== subscriber.key));
                                  } else {
                                    setSelectedSubscribers([...selectedSubscribers, subscriber.key]);
                                  }
                                }}
                              >
                                {subscriber.icon} {subscriber.name}
                              </Tag>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                </Form.Item>

                {selectedSubscribers.length > 0 && (
                  <div style={{ marginTop: '16px', padding: '12px', background: 'rgba(24, 144, 255, 0.08)', borderRadius: '6px', border: '1px solid rgba(24, 144, 255, 0.2)' }}>
                    <Text strong style={{ color: 'rgba(24, 144, 255, 0.9)', fontSize: '12px' }}>
                      📋 已選擇的訂閱者 ({selectedSubscribers.length})：
                    </Text>
                    <div style={{ marginTop: '8px', display: 'flex', gap: '6px', flexWrap: 'wrap' }}>
                      {selectedSubscribers.map(subscriberKey => {
                        const subscriber = mockSubscribers.find(s => s.key === subscriberKey);
                        return subscriber ? (
                          <Tag
                            key={subscriberKey}
                            color="blue"
                            closable
                            onClose={() => setSelectedSubscribers(selectedSubscribers.filter(key => key !== subscriberKey))}
                            style={{ fontSize: '11px' }}
                          >
                            {subscriber.icon} {subscriber.name}
                          </Tag>
                        ) : null;
                      })}
                    </div>
                  </div>
                )}
              </div>

              <Form.Item style={{ textAlign: 'right', marginTop: 24, marginBottom: 0 }}>
                <Button onClick={handleTeamCancel} style={{ marginRight: 8 }}>取消</Button>
                <Button type="primary" className="btn btn--primary" htmlType="submit">{editingTeam ? '更新團隊' : '創建團隊'}</Button>
              </Form.Item>
            </Form>
          </Modal>

        </React.Fragment>
      );
    };

    const RoleManagementPage = () => {
      const permissionTreeData = [
        {
          title: '資源管理', key: 'resources', children: [
            { title: '讀取資源列表', key: 'res:list:read' },
            { title: '寫入資源', key: 'res:list:write' },
            { title: '讀取資源群組', key: 'res:group:read' },
            { title: '寫入資源群組', key: 'res:group:write' },
          ]
        },
        {
          title: '事件管理', key: 'incidents', children: [
            { title: '讀取事件', key: 'inc:list:read' },
            { title: '確認/解決事件', key: 'inc:list:update' },
            { title: '讀取告警規則', key: 'inc:rule:read' },
            { title: '寫入告警規則', key: 'inc:rule:write' },
          ]
        },
      ];
      const initialRoles = [
        { key: 'super_admin', name: '超級管理員', isBuiltIn: true, permissions: ['resources', 'incidents'] },
        { key: 'team_manager', name: '團隊管理員', isBuiltIn: true, permissions: ['res:list:read', 'res:list:write', 'inc:list:read', 'inc:rule:write'] },
        { key: 'viewer', name: '唯讀用戶', isBuiltIn: true, permissions: ['res:list:read', 'inc:list:read'] },
        { key: 'custom_role_1', name: '自定義DBA角色', isBuiltIn: false, permissions: ['res:list:read', 'res:group:write'] },
      ];

      const [roles, setRoles] = useLocalStorageState('sre-roles', initialRoles);
      const [selectedRoleKey, setSelectedRoleKey] = useState('super_admin');
      const [checkedKeys, setCheckedKeys] = useState([]);
      const [isCreateRoleModalOpen, setIsCreateRoleModalOpen] = useState(false);
      const [newRolePermissions, setNewRolePermissions] = useState([]);
      const [roleForm] = Form.useForm();
      const { message, modal } = antd.App.useApp();

      const selectedRole = roles.find(r => r.key === selectedRoleKey);

      useEffect(() => {
        if (selectedRole) {
          setCheckedKeys(selectedRole.permissions);
        }
      }, [selectedRole]);

      const handleSelectRole = (key) => setSelectedRoleKey(key);
      const onCheck = (keys) => setCheckedKeys(keys);
      const handleSave = () => message.success(`角色 "${selectedRole.name}" 的權限已更新`);

      const handleCreateRole = () => {
        setIsCreateRoleModalOpen(true);
        setNewRolePermissions([]);
        roleForm.resetFields();
      };

      const handleCreateRoleCancel = () => {
        setIsCreateRoleModalOpen(false);
        setNewRolePermissions([]);
        roleForm.resetFields();
      };

      const handleCreateRoleFinish = (values) => {
        const newRole = {
          key: `custom_role_${Date.now()}`,
          name: values.name,
          isBuiltIn: false,
          permissions: newRolePermissions
        };

        setRoles([...roles, newRole]);
        setSelectedRoleKey(newRole.key);
        message.success(`角色 "${values.name}" 建立成功`);
        handleCreateRoleCancel();
      };

      const onNewRolePermissionsCheck = (keys) => setNewRolePermissions(keys);

      return (
        <React.Fragment>
          <Title level={2} className="page-title">角色管理</Title>
          <Paragraph className="page-subtitle" type="secondary">為 super_admin 提供一個管理系統角色與其權限的界面。</Paragraph>
          <Row gutter={16}>
            <Col span={6}>
              <div className="role-list-container">
                <div className="role-list-header">
                  <Title level={5} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>角色列表</Title>
                  <Button
                    type="primary"
                    size="small"
                    onClick={handleCreateRole}
                    style={{
                      background: 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)',
                      border: 'none',
                      borderRadius: '6px',
                      fontWeight: '500'
                    }}
                  >
                    新增角色
                  </Button>
                </div>
                <div className="role-list-content">
                  <List
                    dataSource={roles}
                    renderItem={item => (
                      <List.Item key={item.key} onClick={() => handleSelectRole(item.key)} style={{ cursor: 'pointer', background: selectedRoleKey === item.key ? 'rgba(255,255,255,0.1)' : 'transparent', padding: '8px 16px', borderRadius: '4px' }}>
                        {item.name}
                      </List.Item>
                    )}
                  />
                </div>
              </div>
            </Col>
            <Col span={18}>
              {selectedRole && (
                <div className="role-permissions-container">
                  <div className="role-permissions-header">
                    <Space>
                      <span>{selectedRole.name}</span>
                      <Tag color={selectedRole.isBuiltIn ? 'red' : 'blue'}>{selectedRole.isBuiltIn ? '內建角色' : '自定義角色'}</Tag>
                    </Space>
                  </div>
                  <div className="role-permissions-content">
                    <Title level={5}>權限設定</Title>
                    <Tree
                      checkable
                      treeData={permissionTreeData}
                      checkedKeys={checkedKeys}
                      onCheck={onCheck}
                      disabled={selectedRole.isBuiltIn}
                      defaultExpandAll
                    />
                    {!selectedRole.isBuiltIn && <Button type="primary" onClick={handleSave} style={{ marginTop: 16 }}>儲存變更</Button>}
                  </div>
                </div>
              )}
            </Col>
          </Row>

          {/* 新增角色彈窗 */}
          <Modal
            title={
              <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                <UserOutlined style={{ color: '#1890ff' }} />
                <span>新增角色</span>
              </div>
            }
            open={isCreateRoleModalOpen}
            onCancel={handleCreateRoleCancel}
            footer={null}
            width={700}
            style={{
              background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
              borderRadius: '12px'
            }}
          >
            <Form
              form={roleForm}
              layout="vertical"
              onFinish={handleCreateRoleFinish}
              style={{ marginTop: '24px' }}
            >
              {/* 基本資訊區塊 */}
              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '24px',
                backdropFilter: 'blur(20px) saturate(180%)',
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
              }}>
                <Title level={4} style={{ margin: 0, marginBottom: '16px', color: 'rgba(255, 255, 255, 0.85)' }}>
                  基本資訊
                </Title>
                <Form.Item
                  name="name"
                  label="角色名稱"
                  rules={[
                    { required: true, message: '請輸入角色名稱' },
                    { min: 2, message: '角色名稱至少需要2個字符' },
                    { max: 50, message: '角色名稱不能超過50個字符' }
                  ]}
                >
                  <Input
                    placeholder="例如：資料庫管理員"
                    prefix={<UserOutlined style={{ color: 'rgba(255, 255, 255, 0.4)' }} />}
                    style={{
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '1px solid rgba(255, 255, 255, 0.15)',
                      color: 'rgba(255, 255, 255, 0.85)',
                      borderRadius: '6px'
                    }}
                  />
                </Form.Item>
              </div>

              {/* 權限設定區塊 */}
              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                borderRadius: '12px',
                padding: '20px',
                marginBottom: '24px',
                backdropFilter: 'blur(20px) saturate(180%)',
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
              }}>
                <Title level={4} style={{ margin: 0, marginBottom: '16px', color: 'rgba(255, 255, 255, 0.85)' }}>
                  權限設定
                </Title>
                <div style={{
                  background: 'rgba(255, 255, 255, 0.02)',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: '8px',
                  padding: '16px'
                }}>
                  <Tree
                    checkable
                    treeData={permissionTreeData}
                    checkedKeys={newRolePermissions}
                    onCheck={onNewRolePermissionsCheck}
                    defaultExpandAll
                    style={{
                      background: 'transparent',
                      color: 'rgba(255, 255, 255, 0.85)'
                    }}
                  />
                </div>
                {newRolePermissions.length > 0 && (
                  <div style={{
                    marginTop: '16px',
                    padding: '12px',
                    background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%)',
                    border: '1px solid rgba(34, 197, 94, 0.2)',
                    borderRadius: '6px'
                  }}>
                    <Text style={{ color: '#52c41a', fontWeight: '500' }}>
                      已選擇 {newRolePermissions.length} 項權限
                    </Text>
                  </div>
                )}
              </div>

              {/* 底部按鈕區塊 */}
              <div style={{
                background: 'linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(200, 200, 200, 0.02) 100%)',
                border: '1px solid rgba(255, 255, 255, 0.08)',
                borderRadius: '12px',
                padding: '20px',
                backdropFilter: 'blur(20px) saturate(180%)',
                WebkitBackdropFilter: 'blur(20px) saturate(180%)',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.1)'
              }}>
                <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '12px' }}>
                  <Button
                    onClick={handleCreateRoleCancel}
                    style={{
                      borderRadius: '6px',
                      fontWeight: '500'
                    }}
                  >
                    取消
                  </Button>
                  <Button
                    type="primary"
                    htmlType="submit"
                    disabled={newRolePermissions.length === 0}
                    style={{
                      background: newRolePermissions.length === 0
                        ? 'rgba(255, 255, 255, 0.1)'
                        : 'linear-gradient(135deg, #1890ff 0%, #40a9ff 100%)',
                      border: 'none',
                      borderRadius: '6px',
                      fontWeight: '500'
                    }}
                  >
                    建立角色
                  </Button>
                </div>
                {newRolePermissions.length === 0 && (
                  <Text type="secondary" style={{ display: 'block', marginTop: '8px', fontSize: '12px' }}>
                    請至少選擇一個權限才能建立角色
                  </Text>
                )}
              </div>
            </Form>
          </Modal>
        </React.Fragment>
      );
    };

    const NotificationChannelsPage = () => {
      const initialChannels = [
        { key: 'nc_1', name: 'Default Email', type: 'Email', enabled: true, lastTest: { result: 'success', time: dayjs().subtract(1, 'day') } },
        { key: 'nc_2', name: 'On-call Slack', type: 'Slack', enabled: true, lastTest: { result: 'success', time: dayjs().subtract(2, 'hour') } },
        { key: 'nc_3', name: 'Billing Webhook', type: 'Webhook', enabled: false, lastTest: { result: 'failed', time: dayjs().subtract(3, 'day'), message: 'Connection timed out' } },
      ];

      const [channels, setChannels] = useLocalStorageState('sre-channels', initialChannels);
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [editingChannel, setEditingChannel] = useState(null);
      const [form] = Form.useForm();
      const { message } = antd.App.useApp();

      const channelType = Form.useWatch('type', form);

      const showModal = (channel = null) => {
        setEditingChannel(channel);
        form.setFieldsValue(channel || { name: '', type: 'Email', enabled: true });
        setIsModalOpen(true);
      };
      const handleCancel = () => setIsModalOpen(false);
      const onFinish = (values) => message.success('儲存成功');
      const handleTest = () => {
        message.loading({ content: "正在發送測試訊息...", key: "test" });
        setTimeout(() => message.success({ content: "測試訊息發送成功", key: "test" }), 1000);
      }

      const columns = [
        { title: '名稱', dataIndex: 'name' },
        { title: '類型', dataIndex: 'type' },
        { title: '啟用狀態', dataIndex: 'enabled', render: e => <Switch defaultChecked={e} /> },
        { title: '最近測試結果', dataIndex: 'lastTest', render: lt => <Tag color={lt && lt.result === 'success' ? 'green' : 'red'}>{lt && lt.result ? lt.result.toUpperCase() : 'UNKNOWN'}</Tag> },
        { title: '最近測試時間', dataIndex: 'lastTest', render: lt => lt && lt.time ? lt.time.fromNow() : '未知' },
        { title: '操作', key: 'action', render: (_, record) => <Space><Button type="link" onClick={() => showModal(record)}>編輯</Button><Button danger type="link">刪除</Button></Space> },
      ];

      return (
        <React.Fragment>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
            <Title level={2} className="page-title" style={{ margin: 0 }}>通知管道</Title>
            <Button type="primary" icon={<PlusOutlined />} onClick={() => showModal()}>新增通知管道</Button>
          </div>
          <Paragraph className="page-subtitle" type="secondary">提供系統通知管道的集中管理、測試與狀態追蹤。</Paragraph>
          <div className="resource-list-container">
            <div className="table-wrapper">
              <Table columns={columns} dataSource={channels} rowKey="key" style={{ background: 'transparent' }} />
            </div>
          </div>
          <Modal title={editingChannel ? "編輯通知管道" : "新增通知管道"} open={isModalOpen} onCancel={handleCancel}
            footer={[
              <Button key="back" onClick={handleCancel}>取消</Button>,
              <Button key="test" onClick={handleTest}>發送測試</Button>,
              <Button key="submit" type="primary" onClick={() => form.submit()}>儲存</Button>
            ]}
          >
            <Form form={form} layout="vertical" onFinish={onFinish} style={{ marginTop: 24 }}>
              <Form.Item name="name" label="名稱" rules={[{ required: true }]}><Input /></Form.Item>
              <Form.Item name="type" label="管道類型" rules={[{ required: true }]}>
                <Select>
                  <Select.Option value="Email">Email</Select.Option>
                  <Select.Option value="Webhook">Webhook (通用)</Select.Option>
                  <Select.Option value="Slack">Slack</Select.Option>
                  <Select.Option value="LINE Notify">LINE Notify</Select.Option>
                  <Select.Option value="SMS">SMS</Select.Option>
                </Select>
              </Form.Item>

              {channelType === 'Email' && (
                <React.Fragment>
                  <Form.Item name="to" label="收件人 (To)" rules={[{ required: true }]}><Input /></Form.Item>
                  <Form.Item name="cc" label="副本 (CC)"><Input /></Form.Item>
                  <Form.Item name="bcc" label="密件副本 (BCC)"><Input /></Form.Item>
                </React.Fragment>
              )}
              {channelType === 'Webhook' && (
                <React.Fragment>
                  <Form.Item name="webhook_url" label="Webhook URL" rules={[{ required: true, type: 'url' }]}><Input /></Form.Item>
                  <Form.Item name="webhook_method" label="HTTP 方法 (Method)" initialValue="POST">
                    <Select>
                      <Select.Option value="POST">POST</Select.Option>
                      <Select.Option value="PUT">PUT</Select.Option>
                    </Select>
                  </Form.Item>
                </React.Fragment>
              )}
              {channelType === 'Slack' && (
                <React.Fragment>
                  <Form.Item name="slack_url" label="Incoming Webhook URL" rules={[{ required: true, type: 'url' }]}><Input /></Form.Item>
                  <Form.Item name="slack_mention" label="提及對象 (Mention)"><Input placeholder="@channel, @here, or user_id" /></Form.Item>
                </React.Fragment>
              )}
              {channelType === 'LINE Notify' && (
                <Form.Item name="line_token" label="存取權杖 (Access Token)" rules={[{ required: true }]}><Input.Password /></Form.Item>
              )}
              {channelType === 'SMS' && (
                <Form.Item name="sms_recipient" label="收件人手機號碼" rules={[{ required: true }]}><Input placeholder="例如: +886912345678" /></Form.Item>
              )}
            </Form>
          </Modal>
        </React.Fragment>
      )
    };

    const SystemSettingsPage = () => {
      const [form] = Form.useForm();
      const { message } = antd.App.useApp();

      return (
        <React.Fragment>
          <Title level={2} className="page-title">系統設定</Title>
          <Paragraph className="page-subtitle" type="secondary">為 super_admin 提供設定平台級別全域參數的界面。</Paragraph>

          <Form form={form} layout="vertical">
            {/* 平台基本設定區塊 */}
            <Title level={4} style={{ marginBottom: 8, marginTop: 16, color: 'rgba(255, 255, 255, 0.85)' }}>平台基本設定</Title>
            <Form.Item name="platform_name" label="平台名稱" style={{ marginBottom: 12 }}>
              <Input placeholder="輸入平台名稱" />
            </Form.Item>
            <Form.Item name="default_lang" label="預設語言" style={{ marginBottom: 16 }}>
              <Select placeholder="選擇預設語言">
                <Select.Option value="en">English</Select.Option>
                <Select.Option value="zh-Hant">繁體中文</Select.Option>
              </Select>
            </Form.Item>

            {/* 認證設定區塊 */}
            <Title level={4} style={{ marginBottom: 8, marginTop: 16, color: 'rgba(255, 255, 255, 0.85)' }}>認證設定</Title>
            <Form.Item name="oidc_enabled" label="啟用 OIDC" style={{ marginBottom: 12 }}>
              <Select placeholder="選擇是否啟用">
                <Select.Option value={true}>啟用</Select.Option>
                <Select.Option value={false}>停用</Select.Option>
              </Select>
            </Form.Item>
            <Form.Item name="oidc_client_id" label="客戶端 ID" style={{ marginBottom: 12 }}>
              <Input placeholder="輸入客戶端 ID" />
            </Form.Item>
            <Form.Item name="oidc_client_secret" label="客戶端密鑰" style={{ marginBottom: 16 }}>
              <Input.Password placeholder="輸入客戶端密鑰" />
            </Form.Item>

            {/* 郵件伺服器設定區塊 */}
            <Title level={4} style={{ marginBottom: 8, marginTop: 16, color: 'rgba(255, 255, 255, 0.85)' }}>郵件伺服器設定</Title>
            <Form.Item name="smtp_host" label="SMTP 伺服器" style={{ marginBottom: 12 }}>
              <Input placeholder="例如: smtp.gmail.com" />
            </Form.Item>
            <Form.Item name="smtp_port" label="埠號" style={{ marginBottom: 12 }}>
              <InputNumber placeholder="例如: 587" style={{ width: '100%' }} />
            </Form.Item>
            <Form.Item name="smtp_user" label="使用者名稱" style={{ marginBottom: 12 }}>
              <Input placeholder="輸入郵件帳號" />
            </Form.Item>
            <Form.Item name="smtp_pass" label="密碼" style={{ marginBottom: 20 }}>
              <Input.Password placeholder="輸入郵件密碼" />
            </Form.Item>

            {/* 操作按鈕 */}
            <Form.Item style={{ textAlign: 'right', marginBottom: 0 }}>
              <Space size="middle">
                <Button>還原預設值</Button>
                <Button type="primary" onClick={() => message.success('設定已儲存')}>
                  儲存
                </Button>
              </Space>
            </Form.Item>
          </Form>
        </React.Fragment>
      );
    };
    const PlatformDiagnosticsPage = () => {
      const scriptHealthData = [
        { key: 1, name: 'Auto-scaling for Web Servers', total: 150, failed: 8, rate: 5.3 },
        { key: 2, name: 'Increase Database Disk Volume', total: 30, failed: 0, rate: 0 },
        { key: 3, name: 'Daily Backup', total: 7, failed: 1, rate: 14.3 },
      ];
      const channelHealthData = [
        { key: 1, name: 'On-call Slack', total: 532, failed: 1, rate: 0.2 },
        { key: 2, name: 'Default Email', total: 1024, failed: 0, rate: 0 },
        { key: 3, name: 'Billing Webhook', total: 50, failed: 6, rate: 12.0 },
      ];

      const healthColumns = [
        { title: '名稱', dataIndex: 'name', width: '40%' },
        { title: '總次數', dataIndex: 'total', width: '20%', align: 'center' },
        {
          title: '失敗率',
          dataIndex: 'rate',
          width: '40%',
          align: 'center',
          render: (rate) => (
            <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <Progress
                percent={rate}
                status={rate > 5 ? 'exception' : 'normal'}
                size="small"
                style={{ flex: 1, minWidth: '80px' }}
                strokeColor={rate > 10 ? '#ff4d4f' : rate > 5 ? '#faad14' : '#52c41a'}
              />
              <span style={{
                color: rate > 10 ? '#ff4d4f' : rate > 5 ? '#faad14' : '#52c41a',
                fontSize: '12px',
                fontWeight: '500',
                minWidth: '35px'
              }}>
                {rate}%
              </span>
            </div>
          )
        }
      ];

      return (
        <React.Fragment>
          <Title level={2} className="page-title">平台狀態診斷</Title>
          <Paragraph className="page-subtitle" type="secondary">監控 SRE 平台自身的健康狀況，快速發現系統瓶頸。</Paragraph>

          <div style={{ marginBottom: 24 }}>
            <Radio.Group defaultValue="24h">
              <Radio.Button value="24h">過去 24 小時</Radio.Button>
              <Radio.Button value="7d">過去 7 天</Radio.Button>
            </Radio.Group>
          </div>

          <Row gutter={[24, 24]}>
            <Col span={12}>
              <div className="resource-list-container">
                <div style={{ padding: '16px 20px', borderBottom: '1px solid rgba(255, 255, 255, 0.08)' }}>
                  <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>自動化健康度</Title>
                </div>
                <div className="table-wrapper">
                  <Table
                    columns={healthColumns}
                    dataSource={scriptHealthData}
                    rowClassName={(record) => record.rate > 10 ? 'row-highlight' : ''}
                    pagination={false}
                    style={{ background: 'transparent' }}
                    size="middle"
                  />
                </div>
              </div>
            </Col>
            <Col span={12}>
              <div className="resource-list-container">
                <div style={{ padding: '16px 20px', borderBottom: '1px solid rgba(255, 255, 255, 0.08)' }}>
                  <Title level={4} style={{ margin: 0, color: 'rgba(255, 255, 255, 0.85)' }}>通知管道健康度</Title>
                </div>
                <div className="table-wrapper">
                  <Table
                    columns={healthColumns}
                    dataSource={channelHealthData}
                    rowClassName={(record) => record.rate > 10 ? 'row-highlight' : ''}
                    pagination={false}
                    style={{ background: 'transparent' }}
                    size="middle"
                  />
                </div>
              </div>
            </Col>
          </Row>
        </React.Fragment>
      );
    };

    const AuditLogsPage = () => {
      const [drawer, setDrawer] = useState({ open: false, data: null });
      const initialLogs = [
        { key: 1, time: dayjs().subtract(5, 'minutes'), user: 'admin', action: 'execute', type: 'Script', id: 's_1', result: 'success' },
        { key: 2, time: dayjs().subtract(1, 'hour'), user: 'admin', action: 'update', type: 'AlertRule', id: 'rule_2', result: 'success', diff: { before: 'severity: warning', after: 'severity: critical' } },
        { key: 3, time: dayjs().subtract(3, 'hour'), user: 'dev_user', action: 'login', type: 'User', id: 'dev_user', result: 'success' },
        { key: 4, time: dayjs().subtract(4, 'hour'), user: 'system', action: 'create', type: 'Incident', id: 'i_4', result: 'failure', message: 'Rate limit exceeded' },
      ];

      const showDrawer = (record) => setDrawer({ open: true, data: record });
      const closeDrawer = () => setDrawer({ open: false, data: null });

      const columns = [
        { title: '時間', dataIndex: 'time', render: t => t ? t.format('YYYY-MM-DD HH:mm:ss') : '-' },
        { title: '操作者', dataIndex: 'user' },
        { title: '動作', dataIndex: 'action', render: a => <Tag>{a ? a.toUpperCase() : 'UNKNOWN'}</Tag> },
        { title: '資源類型', dataIndex: 'type' },
        { title: '資源 ID', dataIndex: 'id' },
        { title: '結果', dataIndex: 'result', render: r => <Tag color={r === 'success' ? 'green' : 'red'}>{r ? r.toUpperCase() : 'UNKNOWN'}</Tag> },
        { title: '操作', key: 'action', render: (_, record) => <Button type="link" onClick={() => showDrawer(record)}>查看詳情</Button> },
      ];

      return (
        <React.Fragment>
          <Title level={2} className="page-title">審計日誌</Title>
          <Paragraph className="page-subtitle" type="secondary">追蹤平台重要操作的審計紀錄，用於追溯與合規。</Paragraph>
          <div className="resource-list-container">
            <div className="table-toolbar">
              <Form layout="inline">
                <Form.Item label="時間範圍"><RangePicker showTime /></Form.Item>
                <Form.Item label="使用者"><Input style={{ width: 150 }} /></Form.Item>
                <Form.Item label="動作類型"><Select style={{ width: 120 }}><Select.Option value="create">Create</Select.Option></Select></Form.Item>
                <Button type="primary">查詢</Button>
              </Form>
            </div>
            <div className="table-wrapper">
              <Table columns={columns} dataSource={initialLogs} rowKey="key" rowClassName={r => r.result === 'failure' ? 'row-highlight' : ''} style={{ background: 'transparent' }} />
            </div>
          </div>
          <Drawer title="日誌詳情" onClose={closeDrawer} open={drawer.open} width={500}>
            {drawer.data && (
              <List>
                <List.Item><Text strong>時間:</Text> {drawer.data.time ? drawer.data.time.format('YYYY-MM-DD HH:mm:ss') : '-'}</List.Item>
                <List.Item><Text strong>操作者:</Text> {drawer.data.user}</List.Item>
                <List.Item><Text strong>動作:</Text> {drawer.data.action}</List.Item>
                <List.Item><Text strong>資源:</Text> {drawer.data.type} ({drawer.data.id})</List.Item>
                <List.Item><Text strong>結果:</Text> <Tag color={drawer.data && drawer.data.result === 'success' ? 'green' : 'red'}>{drawer.data && drawer.data.result ? drawer.data.result.toUpperCase() : 'UNKNOWN'}</Tag></List.Item>
                {drawer.data.message && <List.Item><Text strong>訊息:</Text> {drawer.data.message}</List.Item>}
                {drawer.data.diff && (
                  <List.Item>
                    <pre>
                      <strong>變更差異:</strong><br />
                      - {drawer.data.diff.before}<br />
                      + {drawer.data.diff.after}
                    </pre>
                  </List.Item>
                )}
              </List>
            )}
          </Drawer>
        </React.Fragment>
      );
    };

    const ProfilePage = ({ themeMode, setThemeMode }) => {
      const [form] = Form.useForm();
      return (
        <React.Fragment>
          <Title level={2} className="page-title">個人資料與偏好設定</Title>
          <Paragraph className="page-subtitle" type="secondary">管理您的個人資訊、密碼與通知偏好。</Paragraph>
          <Tabs tabPosition="left">
            <Tabs.TabPane tab="個人資訊" key="1">
              <Card title="Profile">
                <Form layout="vertical" form={form} style={{ maxWidth: 500 }}>
                  <Form.Item label="姓名" name="name"><Input defaultValue="Admin User" /></Form.Item>
                  <Form.Item label="電子郵件" name="email"><Input defaultValue="admin@example.com" disabled /></Form.Item>
                  <Form.Item><Button type="primary">更新個人資訊</Button></Form.Item>
                </Form>
              </Card>
            </Tabs.TabPane>
            <Tabs.TabPane tab="密碼安全" key="2">
              <Card title="變更密碼">
                <Form layout="vertical" style={{ maxWidth: 500 }}>
                  <Form.Item label="目前密碼" name="currentPassword"><Input.Password /></Form.Item>
                  <Form.Item label="新密碼" name="newPassword"><Input.Password /></Form.Item>
                  <Form.Item label="確認新密碼" name="confirmPassword"><Input.Password /></Form.Item>
                  <Form.Item><Button type="primary">更新密碼</Button></Form.Item>
                </Form>
              </Card>
            </Tabs.TabPane>
            <Tabs.TabPane tab="通知設定" key="3">
              <Card title="Preferences">
                <Form layout="vertical" style={{ maxWidth: 500 }}>
                  <Form.Item label="介面主題" name="theme">
                    <Select value={themeMode} onChange={setThemeMode}><Select.Option value="dark">Dark</Select.Option><Select.Option value="light">Light</Select.Option></Select>
                  </Form.Item>
                  <Form.Item label="預設儀表板" name="homeDashboard">
                    <Select defaultValue="default"><Select.Option value="default">Default</Select.Option></Select>
                  </Form.Item>
                  <Form.Item label="時區" name="timezone">
                    <Select defaultValue="utc"><Select.Option value="utc">UTC</Select.Option><Select.Option value="local">Browser Time</Select.Option></Select>
                  </Form.Item>
                  <Form.Item><Button type="primary">儲存偏好設定</Button></Form.Item>
                </Form>
              </Card>
            </Tabs.TabPane>
          </Tabs>
        </React.Fragment>
      );
    };

    const AdministrationPage = ({ onNavigate }) => {
      const adminCards = [{ group: '存取控制 (Access Control)', items: [{ key: 'user-management', icon: <UserOutlined />, title: '人員管理', description: '管理使用者帳號與權限角色。' }, { key: 'team-management', icon: <TeamOutlined />, title: '團隊管理', description: '管理團隊結構與成員配置。' }, { key: 'role-management', icon: <ApartmentOutlined />, title: '角色管理', description: '管理系統角色與其對應的權限。' }] }, { group: '平台設定 (Platform Settings)', items: [{ key: 'notification-strategies', icon: <ApartmentOutlined />, title: '通知策略', description: '設定告警通知的路由策略和團隊分派。' }, { key: 'notification-channels', icon: <BellOutlined />, title: '通知管道', description: '設定系統發送通知的各種管道。' }, { key: 'system-settings', icon: <BuildOutlined />, title: '系統設定', description: '設定平台級別的全域參數。' }] }, { group: '平台維運 (Platform Operations)', items: [{ key: 'diagnostics', icon: <ControlOutlined />, title: '平台診斷', description: '監控 SRE 平台自身的健康狀況。' }, { key: 'audit-logs', icon: <AuditOutlined />, title: '審計日誌', description: '追蹤與審計平台上的所有重要操作紀錄。' }] }];
      return (
        <React.Fragment>
          <Title level={2} className="page-title">Administration</Title><Paragraph className="page-subtitle" type="secondary">管理平台級別的設定、存取控制與維運狀態。</Paragraph>
          {adminCards.map(group => (
            <div key={group.group} style={{ marginBottom: '32px' }}>
              <Title level={4} style={{ marginBottom: '16px' }}>{group.group}</Title>
              <Row gutter={[16, 16]}>
                {group.items.map(item => (
                  <Col key={item.key} xs={24} md={12} lg={8}>
                    <Card className="admin-card" onClick={() => onNavigate(item.key)}><Card.Meta avatar={item.icon} title={<Title level={5}>{item.title}</Title>} description={item.description} /></Card>
                  </Col>
                ))}
              </Row>
            </div>
          ))}
        </React.Fragment>
      );
    };

    // --- Main App Component ---
    const MainApp = ({ themeMode, setThemeMode }) => {
      const [currentPage, setCurrentPage] = useState('dashboard');
      const [collapsed, setCollapsed] = useState(false);
      const [isSearchModalOpen, setIsSearchModalOpen] = useState(false);

      const { message } = antd.App.useApp();

      const initialScripts = [
        { key: 's_1', name: 'Auto-scaling for Web Servers', type: 'Python', description: '自動擴展 Web 伺服器實例', creator: 'admin', code: '# Python script to scale web servers\nprint("Scaling up web servers...")', params: [{ name: 'instance_count', type: 'number', label: '實例數量' }] },
        { key: 's_2', name: 'Increase Database Disk Volume', type: 'Bash', description: '增加資料庫磁碟區容量', creator: 'admin', code: '#!/bin/bash\n# Bash script to increase disk volume\necho "Increasing DB disk size..."', params: [{ name: 'increase_gb', type: 'number', label: '增加容量 (GB)' }] },
        { key: 's_3', name: 'Daily Backup', type: 'Python', description: '每日資料庫備份', creator: 'dev_user', code: '# Python script for daily backup\nprint("Starting daily backup...")' },
      ];
      const initialExecutions = [
        { key: 'e_1', scriptName: 'Auto-scaling for Web Servers', trigger: { type: 'Event', id: 'i_2' }, status: 'success', startTime: dayjs().subtract(2, 'hour'), duration: '5.2s' },
        { key: 'e_2', scriptName: 'Increase Database Disk Volume', trigger: { type: 'Manual', user: 'admin' }, status: 'failed', startTime: dayjs().subtract(1, 'day'), duration: '2.1s' },
        { key: 'e_3', scriptName: 'Daily Backup', trigger: { type: 'Schedule', id: 'sch_1' }, status: 'success', startTime: dayjs().subtract(1, 'day').hour(2), duration: '15m 30s' },
      ];

      const [scripts, setScripts] = useLocalStorageState('sre-scripts', initialScripts);
      const [executions, setExecutions] = useLocalStorageState('sre-executions', initialExecutions);

      const addExecution = (newExecution) => {
        setExecutions(function (prev) { return [newExecution, ...prev] });
      };

      const handleLogout = () => { message.success('已成功登出'); setTimeout(() => window.location.reload(), 500); }
      const handleMenuClick = ({ key }) => {
        // 處理所有選單項目點擊，包括父選單和子選單
        setCurrentPage(key);
      };

      const handleSubMenuTitleClick = ({ key, domEvent }) => {
        // 阻止預設的展開/收合行為
        domEvent.stopPropagation();
        // 直接導航到父選單頁面
        setCurrentPage(key);
      };
      const getItem = (label, key, icon, children) => {
        const item = {
          key,
          icon,
          children,
          label,
          disabled: false
        };

        // 如果有子項目，為父選單標題添加點擊事件
        if (children) {
          item.onTitleClick = handleSubMenuTitleClick;
        }

        return item;
      };
      const sideMenuItems = [getItem('儀表板', 'dashboard', <DashboardOutlined />), { type: 'divider' }, getItem('資源', 'resources', <HddOutlined />, [getItem('資源列表', 'resource-list'), getItem('資源群組', 'resource-groups'),]), getItem('事件', 'incidents', <HistoryOutlined />, [getItem('事件紀錄', 'incident-list'), getItem('告警規則', 'alerting-rules'), getItem('靜音規則', 'silences'),]), { type: 'divider' }, getItem('分析', 'analyzing', <BarChartOutlined />, [getItem('容量規劃', 'capacity-planning'),]), getItem('自動化', 'automation', <CodeOutlined />, [getItem('腳本庫', 'scripts'), getItem('排程管理', 'schedules'), getItem('執行日誌', 'executions'),]), { type: 'divider' }, getItem('管理', 'administration', <SettingOutlined />),];

      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            setIsSearchModalOpen(true);
          }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, []);

      const PageContent = () => {
        switch (currentPage) {
          case 'dashboard': return <DashboardPage themeMode={themeMode} />;
          case 'resources': return <ResourcesPage onNavigate={setCurrentPage} />;
          case 'incidents': return <IncidentsPage onNavigate={setCurrentPage} />;
          case 'analyzing': return <AnalyzingPage onNavigate={setCurrentPage} />;
          case 'automation': return <AutomationPage onNavigate={setCurrentPage} />;
          case 'resource-list': return <ResourceListPage />;
          case 'resource-groups': return <ResourceGroupsPage />;
          case 'incident-list': return <IncidentListPage onNavigate={setCurrentPage} />;
          case 'alerting-rules': return <AlertingRulesPage />;
          case 'silences': return <SilencesPage />;
          case 'capacity-planning': return <CapacityPlanningPage themeMode={themeMode} />;
          case 'scripts': return <ScriptsPage scripts={scripts} setScripts={setScripts} addExecution={addExecution} />;
          case 'schedules': return <SchedulesPage scripts={scripts} />;
          case 'executions': return <ExecutionsPage executions={executions} setExecutions={setExecutions} />;
          case 'administration': return <AdministrationPage onNavigate={setCurrentPage} />;
          case 'user-management': return <UserManagementPage />;
          case 'team-management': return <TeamManagementPage />;
          case 'role-management': return <RoleManagementPage />;
          case 'notification-strategies': return <NotificationStrategiesPage />;
          case 'notification-channels': return <NotificationChannelsPage />;
          case 'system-settings': return <SystemSettingsPage />;
          case 'diagnostics': return <PlatformDiagnosticsPage />;
          case 'audit-logs': return <AuditLogsPage />;
          case 'profile': return <ProfilePage themeMode={themeMode} setThemeMode={setThemeMode} />;
          default: return <DashboardPage />;
        }
      };

      const findLabel = (key, menu) => {
        for (const item of menu) {
          if (item.key === key) return { parent: null, parentKey: null, child: item.label };
          if (item.children) {
            for (const child of item.children) {
              if (child.key === key) return { parent: item.label, parentKey: item.key, child: child.label };
            }
          }
        }
        const adminPageMap = { 'user-management': '人員管理', 'team-management': '團隊管理', 'role-management': '角色管理', 'notification-strategies': '通知策略', 'notification-channels': '通知管道', 'system-settings': '系統設定', diagnostics: '平台診斷', 'audit-logs': '審計日誌', profile: '個人資料' };
        if (adminPageMap[key]) return { parent: '管理', parentKey: 'administration', child: adminPageMap[key] };
        return { parent: null, parentKey: null, child: '儀表板' };
      };

      const { parent, parentKey, child } = findLabel(currentPage, sideMenuItems);
      const breadcrumbItems = [{ title: <a onClick={() => setCurrentPage('dashboard')}>Home</a> }];
      if (parent) {
        breadcrumbItems.push({ title: <a onClick={() => setCurrentPage(parentKey)}>{parent}</a> });
      }
      if (child && child !== '儀表板' && child !== parent) {
        breadcrumbItems.push({ title: child });
      }

      const userMenuItems = [
        { key: 'profile', label: '個人資料', icon: <UserOutlined />, onClick: () => setCurrentPage('profile') },
        { type: 'divider' },
        { key: 'logout', label: '登出', icon: <RobotOutlined style={{ color: '#8a2be2' }} />, onClick: handleLogout }
      ];

      const NotificationCenter = () => {
        const [notifications, setNotifications] = useState([
          { id: 1, type: 'error', title: 'CPU high on db-prod-01', time: dayjs().subtract(5, 'minutes'), read: false },
          { id: 2, type: 'system', title: 'Script "Daily Backup" executed successfully', time: dayjs().subtract(2, 'hours'), read: false },
          { id: 3, type: 'warning', title: 'Disk space low on web-prod-02', time: dayjs().subtract(1, 'day'), read: true },
        ]);
        const unreadCount = notifications.filter(n => !n.read).length;

        const handleMarkAllAsRead = () => {
          setNotifications(notifications.map(n => ({ ...n, read: true })));
          message.success('所有通知已標為已讀');
        }

        const content = (
          <div style={{ width: 350 }}>
            <List
              header={<div style={{ display: 'flex', justifyContent: 'space-between' }}><b>通知中心</b><Button type="link" size="small" onClick={handleMarkAllAsRead}>全部標為已讀</Button></div>}
              footer={<div style={{ textAlign: 'center' }}><a onClick={() => message.info("導向所有通知頁面")}>查看所有通知</a></div>}
              dataSource={notifications}
              renderItem={item => (
                <List.Item onClick={() => message.info(`跳轉至 ${item.title} 相關頁面`)} style={{ cursor: 'pointer' }}>
                  <List.Item.Meta
                    avatar={<Avatar icon={item.type === 'error' ? <ExclamationCircleOutlined /> : <InfoCircleOutlined />} style={{ backgroundColor: item.type === 'error' ? '#ff4d4f' : '#1677ff' }} />}
                    title={<a style={{ fontWeight: item.read ? 'normal' : 'bold' }}>{item.title}</a>}
                    description={item.time.fromNow()}
                  />
                </List.Item>
              )}
            />
          </div>
        );
        return (
          <Popover content={content} trigger="click" placement="bottomRight">
            <Badge count={unreadCount} color="red" size="small" style={{ color: 'white' }}><BellOutlined style={{ fontSize: '18px' }} /></Badge>
          </Popover>
        );
      };

      const GlobalSearch = () => {
        const [query, setQuery] = useState('');
        const mockResults = [
          { type: '資源', items: [{ key: 'r_1', name: 'db-prod-01', desc: '10.0.0.10' }] },
          { type: '事件', items: [{ key: 'i_1', name: 'CPU high on db-prod-01', desc: 'Firing' }] },
          { type: '自動化腳本', items: [{ key: 's_1', name: 'Auto-scaling for Web Servers', desc: 'Python Script' }] },
        ];

        const filteredResults = query ? mockResults.map(function (group) {
          return {
            ...group,
            items: group.items.filter(function (item) {
              return item.name.toLowerCase().includes(query.toLowerCase())
            })
          }
        }).filter(function (group) { return group.items.length > 0 }) : [];

        return (
          <Modal open={isSearchModalOpen} onCancel={() => setIsSearchModalOpen(false)} footer={null} closable={false} width={600} style={{ top: 50 }}>
            <Input size="large" placeholder="搜尋資源、事件、腳本..." prefix={<SearchOutlined />} onChange={(e) => setQuery(e.target.value)} autoFocus />
            {query && <List
              style={{ marginTop: 16 }}
              dataSource={filteredResults}
              renderItem={group => (
                <List
                  header={<Divider orientation="left">{group.type}</Divider>}
                  dataSource={group.items}
                  renderItem={item => <List.Item style={{ cursor: 'pointer' }} onClick={() => message.info(`跳轉至 ${item.name} 詳情`)}>{item.name}</List.Item>}
                />
              )}
            />}
          </Modal>
        );
      };

      return (
        <Layout style={{ minHeight: '100vh' }}>
          <Layout.Sider trigger={null} collapsible collapsed={collapsed} width={220}>
            <div style={{ height: '50px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', gap: '10px' }} onClick={() => setCurrentPage('dashboard')}>
              <DeploymentUnitOutlined style={{ fontSize: '24px', color: '#8a2be2' }} />
              {!collapsed && <Title level={4} style={{ margin: 0 }}>SRE Platform</Title>}
            </div>
            <Menu
              theme="dark"
              mode="inline"
              defaultOpenKeys={['resources', 'incidents', 'automation', 'analyzing']}
              selectedKeys={[currentPage]}
              items={sideMenuItems}
              onClick={handleMenuClick}
            />
          </Layout.Sider>
          <Layout>
            <Layout.Header style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0 16px' }}>
              <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                <Button
                  type="text"
                  icon={collapsed ? <MenuUnfoldOutlined /> : <MenuFoldOutlined />}
                  onClick={() => setCollapsed(!collapsed)}
                  style={{
                    color: 'rgba(255, 255, 255, 0.8)',
                    fontSize: '14px',
                    width: '32px',
                    height: '32px',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    marginLeft: '-8px'
                  }}
                />
                <Breadcrumb items={breadcrumbItems} />
              </div>
              <div style={{ display: 'flex', alignItems: 'center', gap: '20px' }}>
                <Input prefix={<SearchOutlined />} placeholder="Search... (Ctrl+K)" style={{ width: 250 }} onClick={() => setIsSearchModalOpen(true)} readOnly />
                <NotificationCenter />
                <Dropdown menu={{ items: userMenuItems }}>
                  <a onClick={function (e) { e.preventDefault() }} style={{ display: 'flex', alignItems: 'center' }}>
                    <Avatar size="small" icon={<UserOutlined />} />
                    <span style={{ margin: '0 8px' }}>admin</span>
                    <DownOutlined />
                  </a>
                </Dropdown>
              </div>
            </Layout.Header>
            <Layout.Content style={{ padding: '24px', background: '#0d1117' }}>
              <PageContent />
            </Layout.Content>
            <GlobalSearch />
          </Layout>
        </Layout>
      );
    };

    const AppWrapper = () => {
      const [isAuthenticated, setIsAuthenticated] = useState(false);
      const [themeMode, setThemeMode] = useLocalStorageState('sre-theme-mode', 'dark');

      const handleLogin = () => setIsAuthenticated(true);

      const currentTheme = {
        algorithm: themeMode === 'dark' ? theme.darkAlgorithm : theme.defaultAlgorithm,
        components: {
          Layout: {
            siderBg: themeMode === 'dark' ? '#161719' : '#ffffff',
            headerBg: themeMode === 'dark' ? '#161719' : '#ffffff',
          },
          Menu: {
            darkItemBg: '#161719',
          },
          Card: {
            colorBgContainer: themeMode === 'dark' ? '#202226' : '#ffffff'
          },
          Modal: {
            contentBg: themeMode === 'dark' ? '#202226' : '#ffffff',
            headerBg: themeMode === 'dark' ? '#202226' : '#ffffff',
          },
          Drawer: {
            colorBgElevated: themeMode === 'dark' ? '#202226' : '#ffffff',
          },
          Popover: {
            colorBgElevated: themeMode === 'dark' ? '#202226' : '#ffffff',
          },
          Dropdown: {
            colorBgElevated: themeMode === 'dark' ? '#202226' : '#ffffff',
          },
          Select: {
            colorBgElevated: themeMode === 'dark' ? '#202226' : '#ffffff',
          },
          DatePicker: {
            colorBgContainer: themeMode === 'dark' ? '#161719' : '#ffffff',
            colorBgElevated: themeMode === 'dark' ? '#202226' : '#ffffff',
          },
          Tree: {
            colorBgContainer: themeMode === 'dark' ? '#202226' : '#ffffff',
          }
        }
      };

      return (
        <ConfigProvider theme={currentTheme}>
          <antd.App>
            {isAuthenticated ? <MainApp themeMode={themeMode} setThemeMode={setThemeMode} /> : <LoginPage onLogin={handleLogin} />}
          </antd.App>
        </ConfigProvider>
      )
    }

    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<AppWrapper />);
  </script>
</body>

</html>