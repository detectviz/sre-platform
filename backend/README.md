# SRE å¹³å°å¾Œç«¯ - æ–½å·¥è¨ˆç•« (Construction Plan)

## ğŸ¯ ç¸½è¦½ (Overview)
æœ¬æ–‡ä»¶ç‚º SRE å¹³å° Go å¾Œç«¯æœå‹™çš„è©³ç´°æ–½å·¥è¨ˆç•«ï¼Œæ—¨åœ¨æŒ‡å°é–‹ç™¼åœ˜éšŠå¾é›¶é–‹å§‹ï¼Œé€æ­¥æ§‹å»ºä¸€å€‹ç©©å¥ã€å¯æ“´å±•ã€ä¸”ç¬¦åˆ `openapi.yaml` å¥‘ç´„çš„å¾Œç«¯ç³»çµ±ã€‚

**æ ¸å¿ƒæ¶æ§‹**: **Factory Provider æ¨¡å¼**ï¼Œæ”¯æ´åœ¨ä¸åŒç’°å¢ƒï¼ˆé–‹ç™¼/ç”Ÿç”¢ï¼‰ä¸­åˆ‡æ›çµ„ä»¶å¯¦ç¾ã€‚

---

## ğŸš€ Phase 1: åŸºç¤æ¶æ§‹èˆ‡æ ¸å¿ƒè¨­å®š (Foundation & Core Setup)
*ç›®æ¨™ï¼šå»ºç«‹å°ˆæ¡ˆéª¨æ¶ï¼Œå¯¦ç¾æ ¸å¿ƒçš„å·¥å» æ¨¡å¼ï¼Œä¸¦å•Ÿå‹•ä¸€å€‹åŸºç¤çš„ Web æœå‹™ã€‚*

### 1.1: Go æ¨¡çµ„åˆå§‹åŒ–
- [ ] åœ¨ `backend/` ç›®éŒ„ä¸‹ï¼ŒåŸ·è¡Œ `go mod init github.com/detectviz/sre-platform/backend` ä¾†å»ºç«‹ `go.mod` æª”æ¡ˆã€‚
- [ ] åŸ·è¡Œ `go mod tidy` ä¾†ç¢ºä¿ä¾è³´é—œä¿‚ä¹¾æ·¨ã€‚

### 1.2: å°ˆæ¡ˆçµæ§‹å»ºç«‹
- [ ] å»ºç«‹ä»¥ä¸‹ç›®éŒ„çµæ§‹ï¼š
  ```
  backend/
  â”œâ”€â”€ cmd/
  â”‚   â””â”€â”€ sre-platform/
  â”‚       â””â”€â”€ main.go
  â”œâ”€â”€ internal/
  â”‚   â”œâ”€â”€ config/
  â”‚   â”‚   â””â”€â”€ config.go
  â”‚   â””â”€â”€ providers/
  â”‚       â”œâ”€â”€ factory.go
  â”‚       â”œâ”€â”€ database.go
  â”‚       â””â”€â”€ cache.go
  â””â”€â”€ pkg/
      â””â”€â”€ api/
          â””â”€â”€ v1/
  ```

### 1.3: æ ¸å¿ƒä»‹é¢èˆ‡å·¥å» å¯¦ç¾
- [ ] **`internal/providers/database.go`**: å®šç¾© `DatabaseProvider` ä»‹é¢ï¼Œä¸¦å¯¦ä½œ `SQLite` ç‰ˆæœ¬çš„ Providerã€‚
- [ ] **`internal/providers/cache.go`**: å®šç¾© `CacheProvider` ä»‹é¢ï¼Œä¸¦å¯¦ä½œ `InMemory` ç‰ˆæœ¬çš„ Providerã€‚
- [ ] **`internal/config/config.go`**: å¯¦ä½œ `LoadConfigFromEnv()` å‡½æ•¸ï¼Œç”¨æ–¼å¾ç’°å¢ƒè®Šæ•¸è®€å– `DB_TYPE`, `CACHE_TYPE` ç­‰è¨­å®šã€‚
- [ ] **`internal/providers/factory.go`**: å¯¦ä½œ `NewProviderFactory()` å’Œ `CreateDatabaseProvider()`, `CreateCacheProvider()` ç­‰å·¥å» æ–¹æ³•ï¼Œæ ¹æ“šè¨­å®šå›å‚³å°æ‡‰çš„ Provider å¯¦ä¾‹ã€‚

### 1.4: ä¸»æ‡‰ç”¨ç¨‹å¼å…¥å£
- [ ] **`cmd/sre-platform/main.go`**:
  - [ ] å¼•å…¥ `Gin` Web æ¡†æ¶ (`go get github.com/gin-gonic/gin`)ã€‚
  - [ ] åˆå§‹åŒ–è¨­å®šå’Œ Provider Factoryã€‚
  - [ ] å»ºç«‹ä¸€å€‹åŸºç¤çš„ Gin å¼•æ“ã€‚
  - [ ] è¨»å†Šä¸€å€‹ `/healthz` è·¯ç”±ï¼Œå›å‚³ `200 OK`ã€‚
  - [ ] å•Ÿå‹• HTTP ä¼ºæœå™¨ç›£è½ `8080` é€£æ¥åŸ ã€‚

### 1.5: Dockerfile èª¿æ•´
- [ ] æ›´æ–° `backend/Dockerfile` ä¸­çš„ `COPY` å’Œ `CMD` æŒ‡ä»¤ï¼Œä»¥å°æ‡‰ `cmd/sre-platform/main.go` çš„æ–°è·¯å¾‘ã€‚

---

## ğŸš€ Phase 2: è³‡æ–™åº«æ¨¡å‹èˆ‡é·ç§» (Database Models & Migration)
*ç›®æ¨™ï¼šæ ¹æ“š `db_schema.sql` å»ºç«‹ GORM è³‡æ–™æ¨¡å‹ï¼Œä¸¦å¯¦ç¾è‡ªå‹•åŒ–çš„è³‡æ–™åº«é·ç§»ã€‚*

### 2.1: GORM æ¨¡å‹å®šç¾©
- [ ] åœ¨ `internal/models/` ç›®éŒ„ä¸‹ï¼Œç‚º `users`, `teams`, `roles`, `events`, `resources` ç­‰æ ¸å¿ƒè³‡æºå»ºç«‹å°æ‡‰çš„ Go structã€‚
- [ ] ç‚º struct æ·»åŠ  GORM æ¨™ç±¤ (`gorm:"..."`) ä»¥å°æ‡‰è³‡æ–™åº«æ¬„ä½ã€‚

### 2.2: è³‡æ–™åº«é·ç§»æ•´åˆ
- [ ] åœ¨ `DatabaseProvider` ä»‹é¢ä¸­æ–°å¢ `Migrate()` æ–¹æ³•ã€‚
- [ ] åœ¨ `main.go` ä¸­ï¼Œæ–¼ä¼ºæœå™¨å•Ÿå‹•å‰å‘¼å« `dbProvider.Migrate()`ã€‚
- [ ] é·ç§»é‚è¼¯æ‡‰ä½¿ç”¨ `db.AutoMigrate()` ä¾†è‡ªå‹•åŒæ­¥ GORM æ¨¡å‹èˆ‡è³‡æ–™åº« schemaã€‚

---

## ğŸš€ Phase 3: API ç«¯é»å¯¦ç¾ (API Endpoint Implementation)
*ç›®æ¨™ï¼šæ ¹æ“š `openapi.yaml` è¦æ ¼ï¼Œé€æ­¥å¯¦ç¾æ‰€æœ‰ API ç«¯é»çš„æ¥­å‹™é‚è¼¯ã€‚*

### 3.1: èº«ä»½èˆ‡å­˜å–ç®¡ç† (IAM) API
- [ ] **`internal/handlers/iam.go`**: å»ºç«‹è™•ç† IAM ç›¸é—œè«‹æ±‚çš„ Handlerã€‚
- [ ] **è·¯ç”±è¨»å†Š**: åœ¨ `main.go` ä¸­ï¼Œè¨»å†Š `/users`, `/teams`, `/roles` çš„ GET, POST, PUT, DELETE è·¯ç”±ã€‚
- [ ] **æ¥­å‹™é‚è¼¯**:
  - è·¯ç”± Handler æ‡‰å¾ `DatabaseProvider` ç²å– `*gorm.DB` å¯¦ä¾‹ã€‚
  - å¯¦ç¾å°ä½¿ç”¨è€…ã€åœ˜éšŠã€è§’è‰²çš„å¢åˆªæ”¹æŸ¥é‚è¼¯ã€‚

### 3.2: äº‹ä»¶ç®¡ç† API
- [ ] **`internal/handlers/events.go`**: å»ºç«‹è™•ç†äº‹ä»¶ç›¸é—œè«‹æ±‚çš„ Handlerã€‚
- [ ] **è·¯ç”±è¨»å†Š**: åœ¨ `main.go` ä¸­ï¼Œè¨»å†Š `/events`, `/silence-rules`, `/recurring-silence-rules` ç­‰è·¯ç”±ã€‚
- [ ] **æ¥­å‹™é‚è¼¯**:
  - å¯¦ç¾äº‹ä»¶çš„åˆ—è¡¨æŸ¥è©¢èˆ‡ç¯©é¸ã€‚
  - å¯¦ç¾ `POST /silence-rules` çš„é‚è¼¯ï¼šæ ¹æ“š `event_id` æŸ¥æ‰¾äº‹ä»¶æ¨™ç±¤ï¼Œä¸¦å»ºç«‹ä¸€å€‹ä¸€æ¬¡æ€§çš„éœéŸ³è¦å‰‡ã€‚

### 3.3: è³‡æºç®¡ç† API
- [ ] **`internal/handlers/resources.go`**: å»ºç«‹è™•ç†è³‡æºç›¸é—œè«‹æ±‚çš„ Handlerã€‚
- [ ] **è·¯ç”±è¨»å†Š**: åœ¨ `main.go` ä¸­ï¼Œè¨»å†Š `/resources`, `/resource-groups` ç­‰è·¯ç”±ã€‚
- [ ] **æ¥­å‹™é‚è¼¯**:
  - å¯¦ç¾ `aggregateInventory` çš„é‚è¼¯ï¼Œèšåˆå¤šæ–¹è³‡æ–™å¾Œå›å‚³è³‡æºåˆ—è¡¨ã€‚
  - å¯¦ç¾è³‡æºç¾¤çµ„çš„ç®¡ç†ã€‚

---

## ğŸš€ Phase 4: ç”Ÿç”¢ç’°å¢ƒæº–å‚™ (Production Readiness)
*ç›®æ¨™ï¼šå¯¦ç¾ç”Ÿç”¢ç’°å¢ƒæ‰€éœ€çš„ Providerï¼Œä¸¦å®Œå–„é…ç½®èˆ‡éƒ¨ç½²æµç¨‹ã€‚*

### 4.1: ç”Ÿç”¢ç´š Provider å¯¦ç¾
- [ ] **`PostgreSQLProvider`**: å¯¦ä½œ `DatabaseProvider` ä»‹é¢ï¼Œä½¿ç”¨ `gorm.io/driver/postgres` é€£æ¥åˆ° PostgreSQLã€‚
- [ ] **`RedisCacheProvider`**: å¯¦ä½œ `CacheProvider` ä»‹é¢ï¼Œä½¿ç”¨ `go-redis/redis` é€£æ¥åˆ° Redisã€‚

### 4.2: ä¾è³´æ³¨å…¥èˆ‡ä¸Šä¸‹æ–‡
- [ ] å°‡åˆå§‹åŒ–çš„ Providers æ³¨å…¥åˆ° Gin çš„ `Context` ä¸­ï¼Œæ–¹ä¾¿åœ¨ Handler ä¸­å­˜å–ã€‚

### 4.3: éŒ¯èª¤è™•ç†èˆ‡æ—¥èªŒ
- [ ] å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†ä¸­é–“ä»¶ (Middleware)ã€‚
- [ ] å¼•å…¥çµæ§‹åŒ–æ—¥èªŒå‡½å¼åº«ï¼ˆå¦‚ `logrus` æˆ– `zap`ï¼‰ï¼Œä¸¦åœ¨æ‰€æœ‰é—œéµæ“ä½œä¸­è¨˜éŒ„æ—¥èªŒã€‚

## ğŸ“‹ æœ€çµ‚äº¤ä»˜æ¨™æº–
- [ ] æ‰€æœ‰å¾Œç«¯ç¨‹å¼ç¢¼çš†æœ‰åˆç†çš„å–®å…ƒæ¸¬è©¦è¦†è“‹ã€‚
- [ ] `docker build` èƒ½æˆåŠŸå»ºç«‹å¯é‹è¡Œçš„æ˜ åƒæª”ã€‚
- [ ] å•Ÿå‹•å¾Œçš„æœå‹™èƒ½æˆåŠŸå›æ‡‰æ‰€æœ‰åœ¨ `openapi.yaml` ä¸­å®šç¾©çš„ `GET` è«‹æ±‚ã€‚
- [ ] é–‹ç™¼ç’°å¢ƒ (`SQLite` + `In-Memory`) å’Œç”Ÿç”¢ç’°å¢ƒ (`PostgreSQL` + `Redis`) çš„åˆ‡æ›èƒ½é€éç’°å¢ƒè®Šæ•¸æ­£å¸¸å·¥ä½œã€‚
